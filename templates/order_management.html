{% extends "base.html" %}

{% block extra_head %}
<style>
    .order-description {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    .filter-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    .orders-table {
        background: white;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .table th {
        background-color: #f8f9fa;
        border-top: none;
        font-weight: 600;
    }
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    .btn-action {
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 0.25rem;
    }
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }
    .loading-spinner {
        background: white;
        padding: 2rem;
        border-radius: 0.5rem;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mb-0">ì²˜ë¦¬ ì¤‘...</p>
    </div>
</div>

<!-- í˜ì´ì§€ ì œëª© ë° ì„¤ëª… -->
<div class="order-description">
    <h2 class="h4 mb-2">
        <i class="fas fa-box"></i> {{ title }}
    </h2>
    <p class="mb-0">{{ description }}</p>
</div>

<!-- í•„í„° ì„¹ì…˜ -->
<div class="filter-card">
    <h5 class="mb-3"><i class="fas fa-filter"></i> ì¡°íšŒ ì¡°ê±´</h5>
    <form id="filterForm">
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">ì‹œì‘ì¼</label>
                <input type="date" class="form-control" id="startDate" name="start_date">
            </div>
            <div class="col-md-3">
                <label class="form-label">ì¢…ë£Œì¼</label>
                <input type="date" class="form-control" id="endDate" name="end_date">
            </div>
            <div class="col-md-3">
                <label class="form-label">ê¸°ê°„ ì„¤ì •</label>
                <div class="input-group">
                    <select class="form-select" id="periodSelect">
                        <option value="">ì§ì ‘ ì„ íƒ</option>
                        <option value="1">1ì¼</option>
                        <option value="3">3ì¼</option>
                        <option value="7">7ì¼</option>
                        <option value="15">15ì¼</option>
                        <option value="30">30ì¼</option>
                    </select>
                    <button class="btn btn-outline-success btn-sm" type="button" onclick="savePeriodSetting()" title="í˜„ì¬ ì„ íƒëœ ê¸°ê°„ì„ ì´ í˜ì´ì§€ì˜ ê¸°ë³¸ê°’ìœ¼ë¡œ ì €ì¥">
                        <i class="fas fa-save"></i>
                    </button>
                </div>
                <div class="form-text">
                    <span id="currentDefaultPeriod">ê¸°ë³¸: -ì¼</span>
                    <button class="btn btn-link btn-sm p-0 ms-2" onclick="showPeriodHelp()" title="ê¸°ê°„ ì„¤ì • ë„ì›€ë§">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-3 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search"></i> ì¡°íšŒ
                </button>
                <button type="button" class="btn btn-success" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Excel
                </button>
            </div>
        </div>
    </form>
</div>

<!-- ì£¼ë¬¸ ëª©ë¡ -->
<div class="orders-table">
    <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
        <h5 class="mb-0"><i class="fas fa-list"></i> ì£¼ë¬¸ ëª©ë¡</h5>
        <div id="orderCount" class="badge bg-primary fs-6">
            ì´ <span id="totalCount">0</span>ê±´
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th width="3%">
                        <input type="checkbox" id="selectAll" onchange="toggleAllOrders()">
                    </th>
                    <th width="12%">ì£¼ë¬¸ë²ˆí˜¸</th>
                    <th width="15%">ìƒí’ˆëª…</th>
                    <th width="10%">ê³ ê°ëª…</th>
                    <th width="10%">ì£¼ë¬¸ì¼ì‹œ</th>
                    <th width="8%">ê¸ˆì•¡</th>
                    <th width="8%">ìˆ˜ëŸ‰</th>
                    <th width="10%">ìƒíƒœ</th>
                    <th width="12%">ì†¡ì¥ë²ˆí˜¸</th>
                    <th width="12%">ì•¡ì…˜</th>
                </tr>
            </thead>
            <tbody id="ordersTableBody">
                <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
            </tbody>
        </table>
    </div>

    <!-- ì£¼ë¬¸ì´ ì—†ì„ ë•Œ -->
    <div id="noOrdersMessage" class="text-center p-5 d-none">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">ì¡°íšŒëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</h5>
        <p class="text-muted">ë‹¤ë¥¸ ì¡°ê±´ìœ¼ë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</p>
    </div>
</div>

<!-- ì£¼ë¬¸ ì•¡ì…˜ ëª¨ë‹¬ -->
<div class="modal fade" id="actionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="actionModalTitle">ì£¼ë¬¸ ì²˜ë¦¬</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="actionForm">
                    <input type="hidden" id="actionOrderId" name="order_id">
                    <input type="hidden" id="actionType" name="action">

                    <div id="trackingNumberField" class="mb-3" style="display: none;">
                        <label class="form-label">ì†¡ì¥ë²ˆí˜¸</label>
                        <input type="text" class="form-control" id="trackingNumber" name="tracking_number" placeholder="ì†¡ì¥ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>

                    <div id="cancelReasonField" class="mb-3" style="display: none;">
                        <label class="form-label">ì·¨ì†Œ ì‚¬ìœ </label>
                        <select class="form-select" id="cancelReason" name="cancel_reason">
                            <option value="customer_request">ê³ ê° ìš”ì²­</option>
                            <option value="out_of_stock">ì¬ê³  ë¶€ì¡±</option>
                            <option value="product_defect">ìƒí’ˆ ë¶ˆëŸ‰</option>
                            <option value="other">ê¸°íƒ€</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="processAction()">í™•ì¸</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentPageType = '{{ page_type }}';
let currentOrderStatus = '{{ order_status }}';
let orders = [];

// í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    initializeDates();
    loadOrders();

    // ê¸°ê°„ ì„ íƒ ì´ë²¤íŠ¸
    document.getElementById('periodSelect').addEventListener('change', function() {
        if (this.value) {
            setPeriod(parseInt(this.value));
        }
    });

    // í¼ ì œì¶œ ì´ë²¤íŠ¸
    document.getElementById('filterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        loadOrders();
    });
});

// ë‚ ì§œ ì´ˆê¸°í™” (í˜ì´ì§€ íƒ€ì…ì— ë”°ë¥¸ ê¸°ë³¸ ê¸°ê°„ ì ìš©)
async function initializeDates() {
    console.log('initializeDates í•¨ìˆ˜ í˜¸ì¶œ');
    console.log('í˜„ì¬ í˜ì´ì§€ íƒ€ì…:', currentPageType);

    try {
        // í˜ì´ì§€ íƒ€ì…ë³„ ê¸°ë³¸ ê¸°ê°„ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        const response = await fetch(`/api/settings/period/${currentPageType}`);
        const result = await response.json();

        let defaultDays = 7; // ê¸°ë³¸ê°’

        if (result.success && result.data) {
            defaultDays = result.data.days;
            console.log(`${currentPageType} í˜ì´ì§€ì˜ ê¸°ë³¸ ê¸°ê°„: ${defaultDays}ì¼ (ì„¤ì •: ${result.data.env_key})`);

            // í˜„ì¬ ê¸°ë³¸ ê¸°ê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
            document.getElementById('currentDefaultPeriod').textContent = `ê¸°ë³¸: ${defaultDays}ì¼`;
        } else {
            console.warn(`í˜ì´ì§€ íƒ€ì…ë³„ ê¸°ê°„ ì„¤ì • ì‹¤íŒ¨, ê¸°ë³¸ê°’ ${defaultDays}ì¼ ì‚¬ìš©:`, result.error);
            document.getElementById('currentDefaultPeriod').textContent = `ê¸°ë³¸: ${defaultDays}ì¼`;
        }

        // ë‚ ì§œ ì„¤ì •
        const today = new Date();
        const startDate = new Date(today.getTime() - (defaultDays * 24 * 60 * 60 * 1000));

        const startDateValue = startDate.toISOString().split('T')[0];
        const endDateValue = today.toISOString().split('T')[0];

        console.log('ì„¤ì •í•  ì‹œì‘ì¼:', startDateValue);
        console.log('ì„¤ì •í•  ì¢…ë£Œì¼:', endDateValue);
        console.log('ì„¤ì •í•  ê¸°ê°„:', defaultDays + 'ì¼');

        document.getElementById('startDate').value = startDateValue;
        document.getElementById('endDate').value = endDateValue;

        // ê¸°ê°„ ì„ íƒ ë“œë¡­ë‹¤ìš´ì— í•´ë‹¹ ê°’ì´ ìˆìœ¼ë©´ ì„¤ì •
        const periodSelect = document.getElementById('periodSelect');
        const availableOptions = Array.from(periodSelect.options).map(opt => opt.value);
        if (availableOptions.includes(defaultDays.toString())) {
            periodSelect.value = defaultDays.toString();
        } else {
            periodSelect.value = ''; // "ì§ì ‘ ì„ íƒ"ìœ¼ë¡œ ì„¤ì •
            console.log(`ê¸°ê°„ ${defaultDays}ì¼ì€ ì„ íƒ ì˜µì…˜ì— ì—†ìŒ, "ì§ì ‘ ì„ íƒ"ìœ¼ë¡œ ì„¤ì •`);
        }

        console.log('ì‹¤ì œ ì„¤ì •ëœ ì‹œì‘ì¼:', document.getElementById('startDate').value);
        console.log('ì‹¤ì œ ì„¤ì •ëœ ì¢…ë£Œì¼:', document.getElementById('endDate').value);
        console.log('ì‹¤ì œ ì„¤ì •ëœ ê¸°ê°„ ì˜µì…˜:', periodSelect.value);

    } catch (error) {
        console.error('ê¸°ë³¸ ê¸°ê°„ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);

        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ 7ì¼ë¡œ ì„¤ì •
        const today = new Date();
        const weekAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));

        document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
        document.getElementById('endDate').value = today.toISOString().split('T')[0];
        document.getElementById('periodSelect').value = '7';
    }
}

// ê¸°ê°„ ì„¤ì •
function setPeriod(days) {
    const today = new Date();
    const startDate = new Date(today.getTime() - (days * 24 * 60 * 60 * 1000));

    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
}

// ì£¼ë¬¸ ë¡œë“œ
async function loadOrders() {
    console.log('loadOrders í•¨ìˆ˜ í˜¸ì¶œ');
    showLoading(true);

    try {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        console.log('í˜„ì¬ í˜ì´ì§€ íƒ€ì…:', currentPageType);
        console.log('í˜„ì¬ ì£¼ë¬¸ ìƒíƒœ:', currentOrderStatus);
        console.log('ì‹œì‘ì¼:', startDate);
        console.log('ì¢…ë£Œì¼:', endDate);

        const params = new URLSearchParams({
            start_date: startDate,
            end_date: endDate,
            order_status: currentOrderStatus,
            limit: 100
        });

        console.log('API ìš”ì²­ URL:', `/api/orders?${params}`);

        const response = await fetch(`/api/orders?${params}`);
        const data = await response.json();

        console.log('API ì‘ë‹µ:', data);
        console.log('ì£¼ë¬¸ ìˆ˜:', data.orders ? data.orders.length : 0);

        if (data.success) {
            orders = data.orders;
            console.log('renderOrders í˜¸ì¶œ ì „, orders:', orders);
            renderOrders(orders);
            updateOrderCount(orders.length);
            console.log('renderOrders í˜¸ì¶œ ì™„ë£Œ');
        } else {
            console.error('API ì‘ë‹µ ì‹¤íŒ¨:', data.error);
            throw new Error(data.error || 'ì£¼ë¬¸ ë¡œë“œ ì‹¤íŒ¨');
        }
    } catch (error) {
        console.error('ì£¼ë¬¸ ë¡œë“œ ì˜¤ë¥˜:', error);
        alert('ì£¼ë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// ì£¼ë¬¸ í…Œì´ë¸” ë Œë”ë§
function renderOrders(orderList) {
    console.log('renderOrders í•¨ìˆ˜ ì‹œì‘, orderList:', orderList);

    const tbody = document.getElementById('ordersTableBody');
    const noOrdersMessage = document.getElementById('noOrdersMessage');

    console.log('tbody ìš”ì†Œ:', tbody);
    console.log('noOrdersMessage ìš”ì†Œ:', noOrdersMessage);

    if (orderList.length === 0) {
        console.log('ì£¼ë¬¸ ëª©ë¡ì´ ë¹„ì–´ìˆìŒ');
        tbody.innerHTML = '';
        noOrdersMessage.classList.remove('d-none');
        return;
    }

    console.log('ì£¼ë¬¸ ëª©ë¡ ë Œë”ë§ ì‹œì‘, ì´', orderList.length, 'ê±´');
    noOrdersMessage.classList.add('d-none');

    tbody.innerHTML = orderList.map((order, index) => `
        <tr>
            <td>
                <input type="checkbox" class="order-checkbox" value="${order.order_id}">
            </td>
            <td>
                <small class="text-muted">${order.order_id || '-'}</small>
            </td>
            <td>
                <div class="text-truncate" style="max-width: 150px;" title="${order.product_name || '-'}">
                    ${order.product_name || '-'}
                </div>
            </td>
            <td>${order.customer_name || '-'}</td>
            <td>
                <small>${formatDate(order.order_date)}</small>
            </td>
            <td class="text-end">
                ${formatPrice(order.price)}
            </td>
            <td class="text-center">${order.quantity || 1}</td>
            <td>
                <span class="status-badge ${getStatusBadgeClass(order.status)}">
                    ${getStatusText(order.status)}
                </span>
            </td>
            <td>
                <small>${order.tracking_number || '-'}</small>
            </td>
            <td>
                ${getActionButtons(order)}
            </td>
        </tr>
    `).join('');
}

// ìƒíƒœë³„ ë°°ì§€ í´ë˜ìŠ¤
function getStatusBadgeClass(status) {
    switch(status) {
        case 'PAYED': return 'bg-success';
        case 'CONFIRMED': return 'bg-primary';
        case 'DISPATCHED': return 'bg-info';
        case 'DELIVERED': return 'bg-secondary';
        case 'PURCHASE_DECIDED': return 'bg-dark';
        case 'CANCELED': return 'bg-danger';
        case 'RETURN_REQUESTED': return 'bg-warning';
        default: return 'bg-light text-dark';
    }
}

// ìƒíƒœ í…ìŠ¤íŠ¸
function getStatusText(status) {
    switch(status) {
        case 'PAYED': return 'ê²°ì œì™„ë£Œ';
        case 'CONFIRMED': return 'ì£¼ë¬¸í™•ì¸';
        case 'DISPATCHED': return 'ë°œì†¡ì™„ë£Œ';
        case 'DELIVERED': return 'ë°°ì†¡ì™„ë£Œ';
        case 'PURCHASE_DECIDED': return 'êµ¬ë§¤í™•ì •';
        case 'CANCELED': return 'ì£¼ë¬¸ì·¨ì†Œ';
        case 'RETURN_REQUESTED': return 'ë°˜í’ˆìš”ì²­';
        default: return status || '-';
    }
}

// ì•¡ì…˜ ë²„íŠ¼ ìƒì„±
function getActionButtons(order) {
    switch(currentPageType) {
        case 'new_orders':
            return `
                <button class="btn btn-sm btn-success btn-action" onclick="showActionModal('${order.order_id}', 'confirm_order', 'ì£¼ë¬¸ í™•ì¸')">
                    í™•ì¸
                </button>
            `;
        case 'shipping_pending':
            return `
                <button class="btn btn-sm btn-primary btn-action" onclick="showActionModal('${order.order_id}', 'dispatch_order', 'ë°œì†¡ ì²˜ë¦¬')">
                    ë°œì†¡
                </button>
            `;
        case 'cancel_orders':
            return `
                <button class="btn btn-sm btn-warning btn-action" onclick="showActionModal('${order.order_id}', 'cancel_order', 'ì£¼ë¬¸ ì·¨ì†Œ')">
                    ì·¨ì†Œ
                </button>
            `;
        default:
            return '<span class="text-muted">-</span>';
    }
}

// ì•¡ì…˜ ëª¨ë‹¬ í‘œì‹œ
function showActionModal(orderId, action, title) {
    document.getElementById('actionOrderId').value = orderId;
    document.getElementById('actionType').value = action;
    document.getElementById('actionModalTitle').textContent = title;

    // í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
    document.getElementById('trackingNumberField').style.display =
        action === 'dispatch_order' ? 'block' : 'none';
    document.getElementById('cancelReasonField').style.display =
        action === 'cancel_order' ? 'block' : 'none';

    new bootstrap.Modal(document.getElementById('actionModal')).show();
}

// ì•¡ì…˜ ì²˜ë¦¬
async function processAction() {
    const form = document.getElementById('actionForm');
    const formData = new FormData(form);

    const actionData = {
        order_id: formData.get('order_id'),
        action: formData.get('action'),
        data: {}
    };

    if (formData.get('tracking_number')) {
        actionData.data.tracking_number = formData.get('tracking_number');
    }
    if (formData.get('cancel_reason')) {
        actionData.data.cancel_reason = formData.get('cancel_reason');
    }

    try {
        showLoading(true);

        const response = await fetch('/api/orders/action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(actionData)
        });

        const result = await response.json();

        if (result.success) {
            alert(result.message);
            bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();
            loadOrders(); // ì£¼ë¬¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } else {
            throw new Error(result.error || 'ì²˜ë¦¬ ì‹¤íŒ¨');
        }
    } catch (error) {
        console.error('ì•¡ì…˜ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// ì „ì²´ ì„ íƒ/í•´ì œ
function toggleAllOrders() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.order-checkbox');

    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

// Excel ë‚´ë³´ë‚´ê¸°
function exportToExcel() {
    // ì¶”í›„ êµ¬í˜„ (í˜„ì¬ëŠ” ì•Œë¦¼ë§Œ)
    alert('Excel ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì´ ê³§ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.');
}

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
}

function formatPrice(price) {
    if (!price) return '-';
    return new Intl.NumberFormat('ko-KR').format(price) + 'ì›';
}

function updateOrderCount(count) {
    document.getElementById('totalCount').textContent = count;
}

function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = show ? 'flex' : 'none';
}

// í˜ì´ì§€ë³„ ê¸°ê°„ ì„¤ì • ì €ì¥
async function savePeriodSetting() {
    const periodSelect = document.getElementById('periodSelect');
    const selectedDays = periodSelect.value;

    if (!selectedDays) {
        alert('ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    if (confirm(`ì´ í˜ì´ì§€(${currentPageType})ì˜ ê¸°ë³¸ ì¡°íšŒ ê¸°ê°„ì„ ${selectedDays}ì¼ë¡œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        try {
            console.log(`ê¸°ê°„ ì„¤ì • ì €ì¥: ${currentPageType} -> ${selectedDays}ì¼`);

            const response = await fetch(`/api/settings/period/${currentPageType}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ days: parseInt(selectedDays) })
            });

            const result = await response.json();

            if (result.success) {
                alert(result.data.message);

                // í˜„ì¬ ê¸°ë³¸ ê¸°ê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
                document.getElementById('currentDefaultPeriod').textContent = `ê¸°ë³¸: ${selectedDays}ì¼`;

                console.log(`ê¸°ê°„ ì„¤ì • ì €ì¥ ì„±ê³µ: ${result.data.env_key} = ${selectedDays}ì¼`);
            } else {
                throw new Error(result.error || 'ì €ì¥ ì‹¤íŒ¨');
            }
        } catch (error) {
            console.error('ê¸°ê°„ ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', error);
            alert('ê¸°ê°„ ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    }
}

// ê¸°ê°„ ì„¤ì • ë„ì›€ë§
function showPeriodHelp() {
    const pageTypeNames = {
        'new-orders': 'ì‹ ê·œì£¼ë¬¸',
        'shipping-pending': 'ë°œì†¡ëŒ€ê¸°',
        'shipping-in-progress': 'ë°°ì†¡ì¤‘',
        'shipping-completed': 'ë°°ì†¡ì™„ë£Œ',
        'purchase-decided': 'êµ¬ë§¤í™•ì •',
        'cancel': 'ì·¨ì†Œì£¼ë¬¸',
        'return-exchange': 'ë°˜í’ˆ/êµí™˜',
        'cancel-return-exchange': 'ì·¨ì†Œ/ë°˜í’ˆ/êµí™˜'
    };

    const currentPageName = pageTypeNames[currentPageType] || currentPageType;

    const helpText = `ğŸ“… ${currentPageName} í˜ì´ì§€ ê¸°ê°„ ì„¤ì • ë„ì›€ë§

ğŸ”¹ ê¸°ë³¸ ê¸°ê°„ ì„¤ì •
  - ì´ í˜ì´ì§€ë¥¼ ì—´ ë•Œë§ˆë‹¤ ìë™ìœ¼ë¡œ ì ìš©ë˜ëŠ” ì¡°íšŒ ê¸°ê°„ì…ë‹ˆë‹¤
  - ì„¤ì • > ì¡°ê±´ì„¤ì • íƒ­ì—ì„œë„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

ğŸ”¹ ê¸°ê°„ ì €ì¥ ë°©ë²•
  1. ë“œë¡­ë‹¤ìš´ì—ì„œ ì›í•˜ëŠ” ê¸°ê°„ì„ ì„ íƒ
  2. ğŸ’¾ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì €ì¥
  3. ë‹¤ìŒì— ì´ í˜ì´ì§€ë¥¼ ì—´ë©´ ì €ì¥í•œ ê¸°ê°„ì´ ìë™ ì ìš©ë©ë‹ˆë‹¤

ğŸ”¹ ì£¼ì˜ì‚¬í•­
  - 1ì¼~365ì¼ê¹Œì§€ ì„¤ì • ê°€ëŠ¥í•©ë‹ˆë‹¤
  - "ì§ì ‘ ì„ íƒ"ì¸ ê²½ìš° ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤
  - ì €ì¥ëœ ì„¤ì •ì€ .env íŒŒì¼ì— ì˜êµ¬ ì €ì¥ë©ë‹ˆë‹¤

ğŸ’¡ íŒ: ìì£¼ ì‚¬ìš©í•˜ëŠ” ê¸°ê°„ì„ ì €ì¥í•´ë‘ë©´ ë§¤ë²ˆ ì„¤ì •í•  í•„ìš”ê°€ ì—†ì–´ í¸ë¦¬í•©ë‹ˆë‹¤!`;

    alert(helpText);
}
</script>
{% endblock %}