{% extends "base.html" %}

{% block tab_navigation %}
<div class="order-tabs">
    <div class="container">
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link" href="/orders">
                    <i class="fas fa-list"></i>전체주문
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if page_type == 'order_confirmation' %}active{% endif %}" href="/order-confirmation">
                    <i class="fas fa-check-square"></i>발주확인/발송관리
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if page_type == 'shipping_in_progress' %}active{% endif %}" href="/shipping-in-progress">
                    <i class="fas fa-shipping-fast"></i>배송중
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if page_type == 'shipping_completed' %}active{% endif %}" href="/shipping-completed">
                    <i class="fas fa-check-circle"></i>배송완료
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if page_type == 'purchase_decided' %}active{% endif %}" href="/purchase-decided">
                    <i class="fas fa-thumbs-up"></i>구매확정
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if page_type == 'cancel' %}active{% endif %}" href="/cancel">
                    <i class="fas fa-ban"></i>취소주문
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if page_type == 'returns_exchanges' %}active{% endif %}" href="/returns-exchanges">
                    <i class="fas fa-undo"></i>반품교환
                </a>
            </li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<style>
    .order-description {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    .filter-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    .orders-table {
        background: white;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .table th {
        background-color: #f8f9fa;
        border-top: none;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    .btn-action {
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 0.25rem;
    }
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }
    .loading-spinner {
        background: white;
        padding: 2rem;
        border-radius: 0.5rem;
        text-align: center;
    }

    /* 가로 스크롤 스타일 개선 */
    .table-responsive {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }

    .table-responsive::-webkit-scrollbar {
        height: 8px;
        width: 8px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    /* 테이블 컬럼 최소 너비 보장 */
    .table td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* 컬럼 크기 조절 가능 */
    .table th {
        resize: horizontal;
        position: relative;
        border-right: 2px solid #dee2e6;
    }

    .table th:hover {
        border-right-color: #007bff;
    }

    /* 리사이저 핸들 */
    .column-resizer {
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 5px;
        cursor: col-resize;
        background: transparent;
        border-right: 2px solid transparent;
    }

    .column-resizer:hover {
        border-right-color: #007bff;
    }
</style>
{% endblock %}

{% block content %}
<!-- 로딩 오버레이 -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mb-0">처리 중...</p>
    </div>
</div>

<!-- 페이지 제목 및 설명 -->
<div class="order-description">
    <h2 class="h4 mb-2">
        <i class="fas fa-box"></i> {{ title }}
    </h2>
    <p class="mb-0">{{ description }}</p>
</div>

<!-- 필터 섹션 -->
<div class="filter-card">
    <h5 class="mb-3"><i class="fas fa-filter"></i> 조회 조건</h5>
    <form id="filterForm">
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">시작일</label>
                <input type="date" class="form-control" id="startDate" name="start_date">
            </div>
            <div class="col-md-3">
                <label class="form-label">종료일</label>
                <input type="date" class="form-control" id="endDate" name="end_date">
            </div>
            <div class="col-md-3">
                <label class="form-label">기간 설정</label>
                <div class="input-group">
                    <select class="form-select" id="periodSelect">
                        <option value="">직접 선택</option>
                        <option value="1">1일</option>
                        <option value="3">3일</option>
                        <option value="7">7일</option>
                        <option value="15">15일</option>
                        <option value="30">30일</option>
                    </select>
                    <button class="btn btn-outline-success btn-sm" type="button" onclick="savePeriodSetting()" title="현재 선택된 기간을 이 페이지의 기본값으로 저장">
                        <i class="fas fa-save"></i>
                    </button>
                </div>
                <div class="form-text">
                    <span id="currentDefaultPeriod">기본: -일</span>
                    <button class="btn btn-link btn-sm p-0 ms-2" onclick="showPeriodHelp()" title="기간 설정 도움말">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-3 d-flex align-items-end gap-2">
                <button type="button" class="btn btn-primary" onclick="refreshOrders()">
                    <i class="fas fa-search"></i> 조회
                </button>
                <button type="button" class="btn btn-success" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Excel
                </button>
            </div>
        </div>
    </form>
</div>

<!-- 주문 목록 -->
<div class="orders-table">
    <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
        <h5 class="mb-0"><i class="fas fa-list"></i> 주문 목록</h5>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="showColumnSettings()" title="컬럼 표시 설정">
                <i class="fas fa-columns"></i> 컬럼
            </button>
            <div id="orderCount" class="badge bg-primary fs-6">
                총 <span id="totalCount">0</span>건
            </div>
        </div>
    </div>

    <div class="table-responsive" style="max-height: 70vh; overflow-x: auto; overflow-y: auto;">
        <table class="table table-hover mb-0" style="min-width: 1800px;">
            <thead>
                <tr>
                    <th style="width: 40px; min-width: 40px;" data-column="select">
                        <input type="checkbox" id="selectAll" onchange="toggleAllOrders()">
                    </th>
                    {% if page_type == 'order_confirmation' %}
                    <!-- 발주확인/발송관리 페이지 전용 컬럼들 -->
                    <th style="width: 90px; min-width: 90px;" data-column="shipping_due_date">발송기한</th>
                    <th style="width: 90px; min-width: 90px;" data-column="order_date">주문일자</th>
                    <th style="width: 130px; min-width: 130px;" data-column="product_order_id">상품주문번호</th>
                    <th style="width: 100px; min-width: 100px;" data-column="product_number">상품번호</th>
                    <th style="width: 200px; min-width: 200px;" data-column="product_name">상품명</th>
                    <th style="width: 150px; min-width: 150px;" data-column="product_option">옵션정보</th>
                    <th style="width: 80px; min-width: 80px;" data-column="price">가격</th>
                    <th style="width: 80px; min-width: 80px;" data-column="buyer_name">구매자명</th>
                    <th style="width: 120px; min-width: 120px;" data-column="buyer_phone">구매자연락처</th>
                    <th style="width: 80px; min-width: 80px;" data-column="recipient_name">수취인명</th>
                    <th style="width: 200px; min-width: 200px;" data-column="shipping_address">배송지주소</th>
                    <th style="width: 120px; min-width: 120px;" data-column="recipient_phone">수취인연락처</th>
                    <th style="width: 80px; min-width: 80px;" data-column="shipping_company">택배사</th>
                    <th style="width: 120px; min-width: 120px;" data-column="tracking_number">송장번호</th>
                    <th style="width: 100px; min-width: 100px;" data-column="place_order_status">발주확인상태</th>
                    {% else %}
                    <!-- 다른 페이지들의 기본 컬럼들 -->
                    <th style="width: 120px; min-width: 120px;" data-column="order_id">주문번호</th>
                    <th style="width: 200px; min-width: 200px;" data-column="product_name">상품명</th>
                    <th style="width: 100px; min-width: 100px;" data-column="customer_name">고객명</th>
                    <th style="width: 120px; min-width: 120px;" data-column="order_date">주문일시</th>
                    <th style="width: 80px; min-width: 80px;" data-column="price">금액</th>
                    <th style="width: 60px; min-width: 60px;" data-column="quantity">수량</th>
                    <th style="width: 100px; min-width: 100px;" data-column="status">상태</th>
                    <th style="width: 120px; min-width: 120px;" data-column="tracking_number">송장번호</th>
                    {% endif %}
                    {% if show_confirmation_status %}
                    <th style="width: 100px; min-width: 100px;" data-column="actions">액션</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody id="ordersTableBody">
                <!-- 동적으로 로드됨 -->
            </tbody>
        </table>
    </div>

    <!-- 주문이 없을 때 -->
    <div id="noOrdersMessage" class="text-center p-5 d-none">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">조회된 주문이 없습니다</h5>
        <p class="text-muted">다른 조건으로 검색해보세요.</p>
    </div>
</div>

<!-- 주문 액션 모달 -->
<div class="modal fade" id="actionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="actionModalTitle">주문 처리</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="actionForm">
                    <input type="hidden" id="actionOrderId" name="order_id">
                    <input type="hidden" id="actionType" name="action">

                    <div id="trackingNumberField" class="mb-3" style="display: none;">
                        <label class="form-label">송장번호</label>
                        <input type="text" class="form-control" id="trackingNumber" name="tracking_number" placeholder="송장번호를 입력하세요">
                    </div>

                    <div id="cancelReasonField" class="mb-3" style="display: none;">
                        <label class="form-label">취소 사유</label>
                        <select class="form-select" id="cancelReason" name="cancel_reason">
                            <option value="customer_request">고객 요청</option>
                            <option value="out_of_stock">재고 부족</option>
                            <option value="product_defect">상품 불량</option>
                            <option value="other">기타</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="processAction()">확인</button>
            </div>
        </div>
    </div>
</div>

<!-- 컬럼 설정 모달 -->
<div class="modal fade" id="columnSettingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">컬럼 표시 설정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">표시하고 싶은 컬럼을 선택하세요:</p>
                <div id="columnCheckboxContainer">
                    <!-- JavaScript로 동적 생성 -->
                </div>
                <hr>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="selectAllColumns()">전체선택</button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="deselectAllColumns()">전체해제</button>
                    <button class="btn btn-outline-success btn-sm" onclick="resetToDefault()">기본값복원</button>
                    <button class="btn btn-outline-warning btn-sm" onclick="resetColumnWidths()">컬럼 너비 초기화</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="applyColumnSettings()">적용</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentPageType = '{{ page_type }}';
let currentOrderStatus = '{{ order_status }}';
let orders = [];

// 페이지 로드시 초기화
document.addEventListener('DOMContentLoaded', function() {
    initializeDates();
    loadOrders();
    initializeColumnResize();
    loadColumnWidths();
    loadColumnSettings();

    // 기간 선택 이벤트
    document.getElementById('periodSelect').addEventListener('change', function() {
        if (this.value) {
            setPeriod(parseInt(this.value));
        }
    });

    // 폼 제출 이벤트
    document.getElementById('filterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        loadOrders();
    });
});

// 날짜 초기화 (페이지 타입에 따른 기본 기간 적용)
async function initializeDates() {
    console.log('initializeDates 함수 호출');
    console.log('현재 페이지 타입:', currentPageType);

    try {
        // 페이지 타입별 기본 기간 설정 가져오기
        const response = await fetch(`/api/settings/period/${currentPageType}`);
        const result = await response.json();

        let defaultDays = 7; // 기본값

        if (result.success && result.data) {
            defaultDays = result.data.days;
            console.log(`${currentPageType} 페이지의 기본 기간: ${defaultDays}일 (설정: ${result.data.env_key})`);

            // 현재 기본 기간 표시 업데이트
            document.getElementById('currentDefaultPeriod').textContent = `기본: ${defaultDays}일`;
        } else {
            console.warn(`페이지 타입별 기간 설정 실패, 기본값 ${defaultDays}일 사용:`, result.error);
            document.getElementById('currentDefaultPeriod').textContent = `기본: ${defaultDays}일`;
        }

        // 날짜 설정
        const today = new Date();
        const startDate = new Date(today.getTime() - (defaultDays * 24 * 60 * 60 * 1000));

        const startDateValue = startDate.toISOString().split('T')[0];
        const endDateValue = today.toISOString().split('T')[0];

        console.log('설정할 시작일:', startDateValue);
        console.log('설정할 종료일:', endDateValue);
        console.log('설정할 기간:', defaultDays + '일');

        document.getElementById('startDate').value = startDateValue;
        document.getElementById('endDate').value = endDateValue;

        // 기간 선택 드롭다운에 해당 값이 있으면 설정
        const periodSelect = document.getElementById('periodSelect');
        const availableOptions = Array.from(periodSelect.options).map(opt => opt.value);
        if (availableOptions.includes(defaultDays.toString())) {
            periodSelect.value = defaultDays.toString();
        } else {
            periodSelect.value = ''; // "직접 선택"으로 설정
            console.log(`기간 ${defaultDays}일은 선택 옵션에 없음, "직접 선택"으로 설정`);
        }

        console.log('실제 설정된 시작일:', document.getElementById('startDate').value);
        console.log('실제 설정된 종료일:', document.getElementById('endDate').value);
        console.log('실제 설정된 기간 옵션:', periodSelect.value);

    } catch (error) {
        console.error('기본 기간 설정 로드 실패:', error);

        // 오류 발생 시 기본 7일로 설정
        const today = new Date();
        const weekAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));

        document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
        document.getElementById('endDate').value = today.toISOString().split('T')[0];
        document.getElementById('periodSelect').value = '7';
    }
}

// 기간 설정
function setPeriod(days) {
    const today = new Date();
    const startDate = new Date(today.getTime() - (days * 24 * 60 * 60 * 1000));

    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
}

// 주문 로드 (데이터베이스 전용 - 탭 최초 진입용)
async function loadOrders() {
    console.log('loadOrders 함수 호출 (DB 전용)');
    showLoading(true);

    try {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        console.log('현재 페이지 타입:', currentPageType);
        console.log('현재 주문 상태:', currentOrderStatus);
        console.log('시작일:', startDate);
        console.log('종료일:', endDate);

        const params = new URLSearchParams({
            start_date: startDate,
            end_date: endDate,
            order_status: currentOrderStatus,
            page_type: currentPageType,  // 페이지 타입 추가
            limit: 100
        });

        console.log('DB 조회 URL:', `/api/orders?${params}`);

        const response = await fetch(`/api/orders?${params}`);
        const data = await response.json();

        console.log('DB 응답:', data);
        console.log('주문 수:', data.orders ? data.orders.length : 0);

        if (data.success) {
            orders = data.orders;
            console.log('renderOrders 호출 전, orders:', orders);
            renderOrders(orders);
            updateOrderCount(orders.length);
            console.log('renderOrders 호출 완료');
        } else {
            console.error('API 응답 실패:', data.error);
            throw new Error(data.error || '주문 로드 실패');
        }
    } catch (error) {
        console.error('주문 로드 오류:', error);
        alert('주문을 불러오는 중 오류가 발생했습니다: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// 주문 갱신 (API 호출 후 DB 저장 - 조회 버튼용)
async function refreshOrders() {
    console.log('refreshOrders 함수 호출 (API 갱신)');
    showLoading(true);

    try {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        console.log('현재 페이지 타입:', currentPageType);
        console.log('현재 주문 상태:', currentOrderStatus);
        console.log('시작일:', startDate);
        console.log('종료일:', endDate);

        const params = new URLSearchParams({
            start_date: startDate,
            end_date: endDate,
            order_status: currentOrderStatus,
            page_type: currentPageType,  // 페이지 타입 추가
            limit: 100
        });

        console.log('API 갱신 URL:', `/api/orders/refresh?${params}`);

        const response = await fetch(`/api/orders/refresh?${params}`);
        const data = await response.json();

        console.log('API 갱신 응답:', data);
        console.log('주문 수:', data.orders ? data.orders.length : 0);

        if (data.success) {
            orders = data.orders;
            console.log('renderOrders 호출 전, orders:', orders);
            renderOrders(orders);
            updateOrderCount(orders.length);
            console.log('renderOrders 호출 완료');
        } else {
            console.error('API 갱신 응답 실패:', data.error);
            throw new Error(data.error || '주문 갱신 실패');
        }
    } catch (error) {
        console.error('주문 갱신 오류:', error);
        alert('주문을 갱신하는 중 오류가 발생했습니다: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// 주문 테이블 렌더링
function renderOrders(orderList) {
    console.log('renderOrders 함수 시작, orderList:', orderList);

    const tbody = document.getElementById('ordersTableBody');
    const noOrdersMessage = document.getElementById('noOrdersMessage');

    console.log('tbody 요소:', tbody);
    console.log('noOrdersMessage 요소:', noOrdersMessage);

    if (orderList.length === 0) {
        console.log('주문 목록이 비어있음');
        tbody.innerHTML = '';
        noOrdersMessage.classList.remove('d-none');
        return;
    }

    console.log('주문 목록 렌더링 시작, 총', orderList.length, '건');
    noOrdersMessage.classList.add('d-none');

    tbody.innerHTML = orderList.map((order, index) => {
        if (currentPageType === 'order_confirmation') {
            // 발주확인/발송관리 페이지
            return `
                <tr>
                    <td>
                        <input type="checkbox" class="order-checkbox" value="${order.order_id}">
                    </td>
                    <td>
                        <small>${formatDate(order.shipping_due_date)}</small>
                    </td>
                    <td>
                        <small>${formatDate(order.order_date)}</small>
                    </td>
                    <td>
                        <small class="text-muted">${order.product_order_id || '-'}</small>
                    </td>
                    <td>
                        <small class="text-muted">${order.product_number || '-'}</small>
                    </td>
                    <td>
                        <div class="text-truncate" style="max-width: 190px;" title="${order.product_name || '-'}">
                            ${order.product_name || '-'}
                        </div>
                    </td>
                    <td>
                        <div class="text-truncate" style="max-width: 140px;" title="${order.product_option || '-'}">
                            ${order.product_option || '-'}
                        </div>
                    </td>
                    <td class="text-end">
                        ${formatPrice(order.price)}
                    </td>
                    <td>${order.buyer_name || order.customer_name || '-'}</td>
                    <td>
                        <small>${order.buyer_phone || order.customer_phone || '-'}</small>
                    </td>
                    <td>${order.recipient_name || '-'}</td>
                    <td>
                        <div class="text-truncate" style="max-width: 190px;" title="${order.shipping_address || '-'}">
                            ${order.shipping_address || '-'}
                        </div>
                    </td>
                    <td>
                        <small>${order.recipient_phone || '-'}</small>
                    </td>
                    <td>${order.shipping_company || '-'}</td>
                    <td>
                        <small>${order.tracking_number || '-'}</small>
                    </td>
                    <td>
                        <span class="badge ${getConfirmationStatusClass(order.place_order_status)}">
                            ${getConfirmationStatusText(order.place_order_status)}
                        </span>
                    </td>
                    <td>
                        ${getActionButtons(order)}
                    </td>
                </tr>
            `;
        } else {
            // 다른 페이지들
            return `
                <tr>
                    <td>
                        <input type="checkbox" class="order-checkbox" value="${order.order_id}">
                    </td>
                    <td>
                        <small class="text-muted">${order.order_id || '-'}</small>
                    </td>
                    <td>
                        <div class="text-truncate" style="max-width: 190px;" title="${order.product_name || '-'}">
                            ${order.product_name || '-'}
                        </div>
                    </td>
                    <td>${order.customer_name || '-'}</td>
                    <td>
                        <small>${formatDate(order.order_date)}</small>
                    </td>
                    <td class="text-end">
                        ${formatPrice(order.price)}
                    </td>
                    <td class="text-center">${order.quantity || 1}</td>
                    <td>
                        <span class="status-badge ${getStatusBadgeClass(order.status)}">
                            ${getStatusText(order.status)}
                        </span>
                    </td>
                    <td>
                        <small>${order.tracking_number || '-'}</small>
                    </td>
                    ${currentPageType !== 'order_confirmation' ? `
                    <td>
                        ${getActionButtons(order)}
                    </td>
                    ` : ''}
                </tr>
            `;
        }
    }).join('');

    // 렌더링 후 컬럼 표시 설정 적용
    updateTableColumns();
}

// 상태별 배지 클래스
function getStatusBadgeClass(status) {
    switch(status) {
        case 'PAYED': return 'bg-success';
        case 'CONFIRMED': return 'bg-primary';
        case 'DISPATCHED': return 'bg-info';
        case 'DELIVERED': return 'bg-secondary';
        case 'PURCHASE_DECIDED': return 'bg-dark';
        case 'CANCELED': return 'bg-danger';
        case 'RETURN_REQUESTED': return 'bg-warning';
        default: return 'bg-light text-dark';
    }
}

// 상태 텍스트
function getStatusText(status) {
    switch(status) {
        case 'PAYED': return '결제완료';
        case 'CONFIRMED': return '주문확인';
        case 'DISPATCHED': return '발송완료';
        case 'DELIVERED': return '배송완료';
        case 'PURCHASE_DECIDED': return '구매확정';
        case 'CANCELED': return '주문취소';
        case 'RETURN_REQUESTED': return '반품요청';
        default: return status || '-';
    }
}

// 발주확인 상태별 배지 클래스
function getConfirmationStatusClass(placeOrderStatus) {
    switch(placeOrderStatus) {
        case 'NOT_YET': return 'bg-warning text-dark';  // 미확인 (주황)
        case 'OK': return 'bg-success';                 // 확인완료 (녹색)
        case null:
        case undefined: return 'bg-secondary';          // 정보없음 (회색)
        default: return 'bg-light text-dark';           // 기타
    }
}

// 발주확인 상태 텍스트
function getConfirmationStatusText(placeOrderStatus) {
    switch(placeOrderStatus) {
        case 'NOT_YET': return '미확인';
        case 'OK': return '확인완료';
        case null:
        case undefined: return '정보없음';
        default: return placeOrderStatus || '-';
    }
}

// 액션 버튼 생성
function getActionButtons(order) {
    switch(currentPageType) {
        case 'order_confirmation':
            // 발주확인 상태에 따라 다른 버튼 표시
            if (order.place_order_status === 'NOT_YET') {
                return `
                    <button class="btn btn-sm btn-success btn-action" onclick="showActionModal('${order.order_id}', 'confirm_order', '발주 확인')">
                        발주확인
                    </button>
                `;
            } else if (order.place_order_status === 'OK') {
                return `
                    <button class="btn btn-sm btn-primary btn-action" onclick="showActionModal('${order.order_id}', 'dispatch_order', '발송 처리')">
                        발송처리
                    </button>
                `;
            } else {
                return '<span class="text-muted">-</span>';
            }
        case 'new_orders':
            return `
                <button class="btn btn-sm btn-success btn-action" onclick="showActionModal('${order.order_id}', 'confirm_order', '주문 확인')">
                    확인
                </button>
            `;
        case 'shipping_pending':
            return `
                <button class="btn btn-sm btn-primary btn-action" onclick="showActionModal('${order.order_id}', 'dispatch_order', '발송 처리')">
                    발송
                </button>
            `;
        case 'cancel_orders':
            return `
                <button class="btn btn-sm btn-warning btn-action" onclick="showActionModal('${order.order_id}', 'cancel_order', '주문 취소')">
                    취소
                </button>
            `;
        default:
            return '<span class="text-muted">-</span>';
    }
}

// 액션 모달 표시
function showActionModal(orderId, action, title) {
    document.getElementById('actionOrderId').value = orderId;
    document.getElementById('actionType').value = action;
    document.getElementById('actionModalTitle').textContent = title;

    // 필드 표시/숨김
    document.getElementById('trackingNumberField').style.display =
        action === 'dispatch_order' ? 'block' : 'none';
    document.getElementById('cancelReasonField').style.display =
        action === 'cancel_order' ? 'block' : 'none';

    new bootstrap.Modal(document.getElementById('actionModal')).show();
}

// 액션 처리
async function processAction() {
    const form = document.getElementById('actionForm');
    const formData = new FormData(form);

    const actionData = {
        order_id: formData.get('order_id'),
        action: formData.get('action'),
        data: {}
    };

    if (formData.get('tracking_number')) {
        actionData.data.tracking_number = formData.get('tracking_number');
    }
    if (formData.get('cancel_reason')) {
        actionData.data.cancel_reason = formData.get('cancel_reason');
    }

    try {
        showLoading(true);

        const response = await fetch('/api/orders/action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(actionData)
        });

        const result = await response.json();

        if (result.success) {
            alert(result.message);
            bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();
            loadOrders(); // 주문 목록 새로고침
        } else {
            throw new Error(result.error || '처리 실패');
        }
    } catch (error) {
        console.error('액션 처리 오류:', error);
        alert('처리 중 오류가 발생했습니다: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// 전체 선택/해제
function toggleAllOrders() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.order-checkbox');

    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

// Excel 내보내기
function exportToExcel() {
    // 추후 구현 (현재는 알림만)
    alert('Excel 내보내기 기능이 곧 구현될 예정입니다.');
}

// 유틸리티 함수들
function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
}

function formatPrice(price) {
    if (!price) return '-';
    return new Intl.NumberFormat('ko-KR').format(price) + '원';
}

function updateOrderCount(count) {
    document.getElementById('totalCount').textContent = count;
}

function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = show ? 'flex' : 'none';
}

// 페이지별 기간 설정 저장
async function savePeriodSetting() {
    const periodSelect = document.getElementById('periodSelect');
    const selectedDays = periodSelect.value;

    if (!selectedDays) {
        alert('기간을 선택해주세요.');
        return;
    }

    if (confirm(`이 페이지(${currentPageType})의 기본 조회 기간을 ${selectedDays}일로 설정하시겠습니까?`)) {
        try {
            console.log(`기간 설정 저장: ${currentPageType} -> ${selectedDays}일`);

            const response = await fetch(`/api/settings/period/${currentPageType}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ days: parseInt(selectedDays) })
            });

            const result = await response.json();

            if (result.success) {
                alert(result.data.message);

                // 현재 기본 기간 표시 업데이트
                document.getElementById('currentDefaultPeriod').textContent = `기본: ${selectedDays}일`;

                console.log(`기간 설정 저장 성공: ${result.data.env_key} = ${selectedDays}일`);
            } else {
                throw new Error(result.error || '저장 실패');
            }
        } catch (error) {
            console.error('기간 설정 저장 오류:', error);
            alert('기간 설정 저장 중 오류가 발생했습니다: ' + error.message);
        }
    }
}

// 기간 설정 도움말
function showPeriodHelp() {
    const pageTypeNames = {
        'new-orders': '신규주문',
        'shipping-pending': '발송대기',
        'shipping-in-progress': '배송중',
        'shipping-completed': '배송완료',
        'purchase-decided': '구매확정',
        'cancel': '취소주문',
        'return-exchange': '반품/교환',
        'cancel-return-exchange': '취소/반품/교환'
    };

    const currentPageName = pageTypeNames[currentPageType] || currentPageType;

    const helpText = `📅 ${currentPageName} 페이지 기간 설정 도움말

🔹 기본 기간 설정
  - 이 페이지를 열 때마다 자동으로 적용되는 조회 기간입니다
  - 설정 > 조건설정 탭에서도 변경할 수 있습니다

🔹 기간 저장 방법
  1. 드롭다운에서 원하는 기간을 선택
  2. 💾 버튼을 클릭하여 저장
  3. 다음에 이 페이지를 열면 저장한 기간이 자동 적용됩니다

🔹 주의사항
  - 1일~365일까지 설정 가능합니다
  - "직접 선택"인 경우 저장할 수 없습니다
  - 저장된 설정은 .env 파일에 영구 저장됩니다

💡 팁: 자주 사용하는 기간을 저장해두면 매번 설정할 필요가 없어 편리합니다!`;

    alert(helpText);
}

// 페이지 타입별 컬럼 설정
function getDefaultColumnSettings() {
    if (currentPageType === 'order_confirmation') {
        // 발주확인/발송관리 페이지 전용 컬럼들
        return {
            shipping_due_date: true,
            order_date: true,
            product_order_id: true,
            product_number: true,
            product_name: true,
            product_option: true,
            price: true,
            buyer_name: true,
            buyer_phone: true,
            recipient_name: true,
            shipping_address: true,
            recipient_phone: true,
            shipping_company: true,
            tracking_number: true,
            place_order_status: true
        };
    } else {
        // 다른 페이지들의 기본 컬럼들
        return {
            order_id: true,
            product_name: true,
            customer_name: true,
            order_date: true,
            price: true,
            quantity: true,
            status: true,
            tracking_number: true
        };
    }
}

let columnSettings = getDefaultColumnSettings();

function showColumnSettings() {
    // 컬럼 체크박스를 동적으로 생성
    generateColumnCheckboxes();

    // 현재 설정으로 체크박스 상태 업데이트
    Object.keys(columnSettings).forEach(column => {
        const checkbox = document.getElementById(`col-${column}`);
        if (checkbox) {
            checkbox.checked = columnSettings[column];
        }
    });

    // 모달 표시
    new bootstrap.Modal(document.getElementById('columnSettingsModal')).show();
}

function generateColumnCheckboxes() {
    const container = document.getElementById('columnCheckboxContainer');

    // 페이지 타입별 컬럼 라벨 정의
    const columnLabels = currentPageType === 'order_confirmation' ? {
        shipping_due_date: '발송기한',
        order_date: '주문일자',
        product_order_id: '상품주문번호',
        product_number: '상품번호',
        product_name: '상품명',
        product_option: '옵션정보',
        price: '가격',
        buyer_name: '구매자명',
        buyer_phone: '구매자연락처',
        recipient_name: '수취인명',
        shipping_address: '배송지주소',
        recipient_phone: '수취인연락처',
        shipping_company: '택배사',
        tracking_number: '송장번호',
        place_order_status: '발주확인상태'
    } : {
        order_id: '주문번호',
        product_name: '상품명',
        customer_name: '고객명',
        order_date: '주문일시',
        price: '금액',
        quantity: '수량',
        status: '상태',
        tracking_number: '송장번호'
    };

    const columns = Object.keys(columnLabels);
    const mid = Math.ceil(columns.length / 2);

    let html = '<div class="row">';

    // 첫 번째 컬럼
    html += '<div class="col-6">';
    for (let i = 0; i < mid; i++) {
        const column = columns[i];
        const label = columnLabels[column];
        html += `
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="col-${column}" value="${column}" checked>
                <label class="form-check-label" for="col-${column}">${label}</label>
            </div>
        `;
    }
    html += '</div>';

    // 두 번째 컬럼
    html += '<div class="col-6">';
    for (let i = mid; i < columns.length; i++) {
        const column = columns[i];
        const label = columnLabels[column];
        html += `
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="col-${column}" value="${column}" checked>
                <label class="form-check-label" for="col-${column}">${label}</label>
            </div>
        `;
    }
    html += '</div>';

    html += '</div>';

    container.innerHTML = html;
}

function selectAllColumns() {
    Object.keys(columnSettings).forEach(column => {
        const checkbox = document.getElementById(`col-${column}`);
        if (checkbox) checkbox.checked = true;
    });
}

function deselectAllColumns() {
    Object.keys(columnSettings).forEach(column => {
        const checkbox = document.getElementById(`col-${column}`);
        if (checkbox) checkbox.checked = false;
    });
}

function resetToDefault() {
    // 페이지별 기본 설정으로 초기화
    columnSettings = getDefaultColumnSettings();

    Object.keys(columnSettings).forEach(column => {
        const checkbox = document.getElementById(`col-${column}`);
        if (checkbox) checkbox.checked = true;
    });
}

function applyColumnSettings() {
    // 체크박스 상태를 columnSettings에 저장
    Object.keys(columnSettings).forEach(column => {
        const checkbox = document.getElementById(`col-${column}`);
        if (checkbox) {
            columnSettings[column] = checkbox.checked;
        }
    });

    // 테이블 컬럼 표시/숨김 적용
    updateTableColumns();

    // 로컬 스토리지에 저장
    localStorage.setItem(`columnSettings_${currentPageType}`, JSON.stringify(columnSettings));

    // 모달 닫기
    bootstrap.Modal.getInstance(document.getElementById('columnSettingsModal')).hide();

    alert('컬럼 설정이 저장되었습니다.');
}

function updateTableColumns() {
    const table = document.querySelector('.table');
    if (!table) return;

    // 헤더 컬럼 업데이트
    const headerCells = table.querySelectorAll('thead th[data-column]');
    headerCells.forEach(cell => {
        const column = cell.getAttribute('data-column');
        if (column === 'select' || column === 'actions') {
            cell.style.display = '';
        } else {
            cell.style.display = columnSettings[column] ? '' : 'none';
        }
    });

    // 데이터 행 컬럼 업데이트
    const dataRows = table.querySelectorAll('tbody tr');
    dataRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        cells.forEach((cell, index) => {
            if (index === 0 || index === cells.length - 1) {
                cell.style.display = '';
                return;
            }

            const columnOrder = currentPageType === 'order_confirmation' ? [
                'shipping_due_date', 'order_date', 'product_order_id', 'product_number',
                'product_name', 'product_option', 'price', 'buyer_name', 'buyer_phone',
                'recipient_name', 'shipping_address', 'recipient_phone', 'shipping_company',
                'tracking_number', 'place_order_status'
            ] : [
                'order_id', 'product_name', 'customer_name', 'order_date',
                'price', 'quantity', 'status', 'tracking_number'
            ];

            const column = columnOrder[index - 1];
            if (column) {
                cell.style.display = columnSettings[column] ? '' : 'none';
            }
        });
    });
}

function loadColumnSettings() {
    const saved = localStorage.getItem(`columnSettings_${currentPageType}`);
    if (saved) {
        columnSettings = { ...columnSettings, ...JSON.parse(saved) };
        updateTableColumns();
    }
}

// 중복 제거됨 - 이미 위에서 처리함

// 컬럼 크기 조절 기능 초기화
function initializeColumnResize() {
    const table = document.querySelector('.table');
    if (!table) return;

    let isResizing = false;
    let currentColumn = null;
    let startX = 0;
    let startWidth = 0;

    // 마우스 이벤트 리스너
    table.addEventListener('mousedown', function(e) {
        if (e.target.tagName === 'TH') {
            const rect = e.target.getBoundingClientRect();
            const rightEdge = rect.right - e.clientX < 10; // 오른쪽 가장자리 10px 내

            if (rightEdge) {
                isResizing = true;
                currentColumn = e.target;
                startX = e.clientX;
                startWidth = parseInt(document.defaultView.getComputedStyle(currentColumn).width, 10);

                // 커서 변경
                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            }
        }
    });

    document.addEventListener('mousemove', function(e) {
        const table = document.querySelector('.table');
        if (!table) return;

        if (isResizing && currentColumn) {
            const diff = e.clientX - startX;
            const newWidth = Math.max(50, startWidth + diff); // 최소 너비 50px

            currentColumn.style.width = newWidth + 'px';
            currentColumn.style.minWidth = newWidth + 'px';
        } else {
            // 마우스가 컬럼 경계 근처에 있는지 확인
            const th = e.target.closest('th');
            if (th) {
                const rect = th.getBoundingClientRect();
                const rightEdge = rect.right - e.clientX < 10;

                if (rightEdge) {
                    document.body.style.cursor = 'col-resize';
                } else {
                    document.body.style.cursor = 'default';
                }
            } else {
                document.body.style.cursor = 'default';
            }
        }
    });

    document.addEventListener('mouseup', function() {
        if (isResizing && currentColumn) {
            isResizing = false;

            // 컬럼 너비 저장
            saveColumnWidths();

            currentColumn = null;
            document.body.style.cursor = 'default';
        }
    });
}

// 컬럼 너비 저장
function saveColumnWidths() {
    try {
        const columnWidths = {};
        const headers = document.querySelectorAll('.table th[data-column]');

        headers.forEach(header => {
            const columnName = header.getAttribute('data-column');
            const width = parseInt(header.style.width || header.offsetWidth);
            if (columnName && width) {
                columnWidths[columnName] = width;
            }
        });

        // localStorage에 저장
        localStorage.setItem(`columnWidths_${currentPageType}`, JSON.stringify(columnWidths));
        console.log('컬럼 너비 저장:', columnWidths);

    } catch (error) {
        console.error('컬럼 너비 저장 오류:', error);
    }
}

// 저장된 컬럼 너비 불러오기
function loadColumnWidths() {
    try {
        const savedWidths = localStorage.getItem(`columnWidths_${currentPageType}`);
        if (savedWidths) {
            const columnWidths = JSON.parse(savedWidths);
            console.log('저장된 컬럼 너비 불러오기:', columnWidths);

            Object.keys(columnWidths).forEach(columnName => {
                const header = document.querySelector(`th[data-column="${columnName}"]`);
                if (header) {
                    const width = columnWidths[columnName];
                    header.style.width = width + 'px';
                    header.style.minWidth = width + 'px';
                }
            });

            console.log('컬럼 너비 적용 완료');
        }
    } catch (error) {
        console.error('컬럼 너비 불러오기 오류:', error);
    }
}

// 컬럼 너비 초기화
function resetColumnWidths() {
    try {
        // localStorage에서 삭제
        localStorage.removeItem(`columnWidths_${currentPageType}`);

        // 기본 너비로 복원
        const headers = document.querySelectorAll('.table th[data-column]');
        headers.forEach(header => {
            header.style.width = '';
            header.style.minWidth = '';
        });

        alert('컬럼 너비가 초기화되었습니다.');

    } catch (error) {
        console.error('컬럼 너비 초기화 오류:', error);
    }
}
</script>
{% endblock %}