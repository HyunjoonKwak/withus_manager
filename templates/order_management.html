{% extends "base.html" %}

{% block tab_navigation %}
<div class="order-tabs">
    <div class="container">
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link" href="/orders">
                    <i class="fas fa-list"></i>ì „ì²´ì£¼ë¬¸
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if page_type == 'order_confirmation' %}active{% endif %}" href="/order-confirmation">
                    <i class="fas fa-check-square"></i>ë°œì£¼í™•ì¸/ë°œì†¡ê´€ë¦¬
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if page_type == 'shipping_in_progress' %}active{% endif %}" href="/shipping-in-progress">
                    <i class="fas fa-shipping-fast"></i>ë°°ì†¡ì¤‘
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if page_type == 'shipping_completed' %}active{% endif %}" href="/shipping-completed">
                    <i class="fas fa-check-circle"></i>ë°°ì†¡ì™„ë£Œ
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if page_type == 'purchase_decided' %}active{% endif %}" href="/purchase-decided">
                    <i class="fas fa-thumbs-up"></i>êµ¬ë§¤í™•ì •
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if page_type == 'cancel' %}active{% endif %}" href="/cancel">
                    <i class="fas fa-ban"></i>ì·¨ì†Œì£¼ë¬¸
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if page_type == 'returns_exchanges' %}active{% endif %}" href="/returns-exchanges">
                    <i class="fas fa-undo"></i>ë°˜í’ˆêµí™˜
                </a>
            </li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<style>
    .order-description {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    .filter-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    .orders-table {
        background: white;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .table th {
        background-color: #f8f9fa;
        border-top: none;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    .btn-action {
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 0.25rem;
    }
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }
    .loading-spinner {
        background: white;
        padding: 2rem;
        border-radius: 0.5rem;
        text-align: center;
    }

    /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ìŠ¤íƒ€ì¼ ê°œì„  */
    .table-responsive {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }

    .table-responsive::-webkit-scrollbar {
        height: 8px;
        width: 8px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    /* í…Œì´ë¸” ì»¬ëŸ¼ ìµœì†Œ ë„ˆë¹„ ë³´ì¥ */
    .table td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* ì»¬ëŸ¼ í¬ê¸° ì¡°ì ˆ ê°€ëŠ¥ */
    .table th {
        resize: horizontal;
        position: relative;
        border-right: 2px solid #dee2e6;
    }

    .table th:hover {
        border-right-color: #007bff;
    }

    /* ë¦¬ì‚¬ì´ì € í•¸ë“¤ */
    .column-resizer {
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 5px;
        cursor: col-resize;
        background: transparent;
        border-right: 2px solid transparent;
    }

    .column-resizer:hover {
        border-right-color: #007bff;
    }
</style>
{% endblock %}

{% block content %}
<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mb-0">ì²˜ë¦¬ ì¤‘...</p>
    </div>
</div>

<!-- í˜ì´ì§€ ì œëª© ë° ì„¤ëª… -->
<div class="order-description">
    <h2 class="h4 mb-2">
        <i class="fas fa-box"></i> {{ title }}
    </h2>
    <p class="mb-0">{{ description }}</p>
</div>

<!-- í•„í„° ì„¹ì…˜ -->
<div class="filter-card">
    <h5 class="mb-3"><i class="fas fa-filter"></i> ì¡°íšŒ ì¡°ê±´</h5>
    <form id="filterForm">
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">ì‹œì‘ì¼</label>
                <input type="date" class="form-control" id="startDate" name="start_date">
            </div>
            <div class="col-md-3">
                <label class="form-label">ì¢…ë£Œì¼</label>
                <input type="date" class="form-control" id="endDate" name="end_date">
            </div>
            <div class="col-md-3">
                <label class="form-label">ê¸°ê°„ ì„¤ì •</label>
                <div class="input-group">
                    <select class="form-select" id="periodSelect">
                        <option value="">ì§ì ‘ ì„ íƒ</option>
                        <option value="1">1ì¼</option>
                        <option value="3">3ì¼</option>
                        <option value="7">7ì¼</option>
                        <option value="15">15ì¼</option>
                        <option value="30">30ì¼</option>
                    </select>
                    <button class="btn btn-outline-success btn-sm" type="button" onclick="savePeriodSetting()" title="í˜„ì¬ ì„ íƒëœ ê¸°ê°„ì„ ì´ í˜ì´ì§€ì˜ ê¸°ë³¸ê°’ìœ¼ë¡œ ì €ì¥">
                        <i class="fas fa-save"></i>
                    </button>
                </div>
                <div class="form-text">
                    <span id="currentDefaultPeriod">ê¸°ë³¸: -ì¼</span>
                    <button class="btn btn-link btn-sm p-0 ms-2" onclick="showPeriodHelp()" title="ê¸°ê°„ ì„¤ì • ë„ì›€ë§">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-3 d-flex align-items-end gap-2">
                <button type="button" class="btn btn-primary" onclick="refreshOrders()">
                    <i class="fas fa-search"></i> ì¡°íšŒ
                </button>
                <button type="button" class="btn btn-success" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Excel
                </button>
            </div>
        </div>
    </form>
</div>

<!-- ì£¼ë¬¸ ëª©ë¡ -->
<div class="orders-table">
    <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
        <h5 class="mb-0"><i class="fas fa-list"></i> ì£¼ë¬¸ ëª©ë¡</h5>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="showColumnSettings()" title="ì»¬ëŸ¼ í‘œì‹œ ì„¤ì •">
                <i class="fas fa-columns"></i> ì»¬ëŸ¼
            </button>
            <div id="orderCount" class="badge bg-primary fs-6">
                ì´ <span id="totalCount">0</span>ê±´
            </div>
        </div>
    </div>

    <div class="table-responsive" style="max-height: 70vh; overflow-x: auto; overflow-y: auto;">
        <table class="table table-hover mb-0" style="min-width: 1800px;">
            <thead>
                <tr>
                    <th style="width: 40px; min-width: 40px;" data-column="select">
                        <input type="checkbox" id="selectAll" onchange="toggleAllOrders()">
                    </th>
                    {% if page_type == 'order_confirmation' %}
                    <!-- ë°œì£¼í™•ì¸/ë°œì†¡ê´€ë¦¬ í˜ì´ì§€ ì „ìš© ì»¬ëŸ¼ë“¤ -->
                    <th style="width: 90px; min-width: 90px;" data-column="shipping_due_date">ë°œì†¡ê¸°í•œ</th>
                    <th style="width: 90px; min-width: 90px;" data-column="order_date">ì£¼ë¬¸ì¼ì</th>
                    <th style="width: 130px; min-width: 130px;" data-column="product_order_id">ìƒí’ˆì£¼ë¬¸ë²ˆí˜¸</th>
                    <th style="width: 100px; min-width: 100px;" data-column="product_number">ìƒí’ˆë²ˆí˜¸</th>
                    <th style="width: 200px; min-width: 200px;" data-column="product_name">ìƒí’ˆëª…</th>
                    <th style="width: 150px; min-width: 150px;" data-column="product_option">ì˜µì…˜ì •ë³´</th>
                    <th style="width: 80px; min-width: 80px;" data-column="price">ê°€ê²©</th>
                    <th style="width: 80px; min-width: 80px;" data-column="buyer_name">êµ¬ë§¤ìëª…</th>
                    <th style="width: 120px; min-width: 120px;" data-column="buyer_phone">êµ¬ë§¤ìì—°ë½ì²˜</th>
                    <th style="width: 80px; min-width: 80px;" data-column="recipient_name">ìˆ˜ì·¨ì¸ëª…</th>
                    <th style="width: 200px; min-width: 200px;" data-column="shipping_address">ë°°ì†¡ì§€ì£¼ì†Œ</th>
                    <th style="width: 120px; min-width: 120px;" data-column="recipient_phone">ìˆ˜ì·¨ì¸ì—°ë½ì²˜</th>
                    <th style="width: 80px; min-width: 80px;" data-column="shipping_company">íƒë°°ì‚¬</th>
                    <th style="width: 120px; min-width: 120px;" data-column="tracking_number">ì†¡ì¥ë²ˆí˜¸</th>
                    <th style="width: 100px; min-width: 100px;" data-column="place_order_status">ë°œì£¼í™•ì¸ìƒíƒœ</th>
                    {% else %}
                    <!-- ë‹¤ë¥¸ í˜ì´ì§€ë“¤ì˜ ê¸°ë³¸ ì»¬ëŸ¼ë“¤ -->
                    <th style="width: 120px; min-width: 120px;" data-column="order_id">ì£¼ë¬¸ë²ˆí˜¸</th>
                    <th style="width: 200px; min-width: 200px;" data-column="product_name">ìƒí’ˆëª…</th>
                    <th style="width: 100px; min-width: 100px;" data-column="customer_name">ê³ ê°ëª…</th>
                    <th style="width: 120px; min-width: 120px;" data-column="order_date">ì£¼ë¬¸ì¼ì‹œ</th>
                    <th style="width: 80px; min-width: 80px;" data-column="price">ê¸ˆì•¡</th>
                    <th style="width: 60px; min-width: 60px;" data-column="quantity">ìˆ˜ëŸ‰</th>
                    <th style="width: 100px; min-width: 100px;" data-column="status">ìƒíƒœ</th>
                    <th style="width: 120px; min-width: 120px;" data-column="tracking_number">ì†¡ì¥ë²ˆí˜¸</th>
                    {% endif %}
                    {% if show_confirmation_status %}
                    <th style="width: 100px; min-width: 100px;" data-column="actions">ì•¡ì…˜</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody id="ordersTableBody">
                <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
            </tbody>
        </table>
    </div>

    <!-- ì£¼ë¬¸ì´ ì—†ì„ ë•Œ -->
    <div id="noOrdersMessage" class="text-center p-5 d-none">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">ì¡°íšŒëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</h5>
        <p class="text-muted">ë‹¤ë¥¸ ì¡°ê±´ìœ¼ë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</p>
    </div>
</div>

<!-- ì£¼ë¬¸ ì•¡ì…˜ ëª¨ë‹¬ -->
<div class="modal fade" id="actionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="actionModalTitle">ì£¼ë¬¸ ì²˜ë¦¬</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="actionForm">
                    <input type="hidden" id="actionOrderId" name="order_id">
                    <input type="hidden" id="actionType" name="action">

                    <div id="trackingNumberField" class="mb-3" style="display: none;">
                        <label class="form-label">ì†¡ì¥ë²ˆí˜¸</label>
                        <input type="text" class="form-control" id="trackingNumber" name="tracking_number" placeholder="ì†¡ì¥ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>

                    <div id="cancelReasonField" class="mb-3" style="display: none;">
                        <label class="form-label">ì·¨ì†Œ ì‚¬ìœ </label>
                        <select class="form-select" id="cancelReason" name="cancel_reason">
                            <option value="customer_request">ê³ ê° ìš”ì²­</option>
                            <option value="out_of_stock">ì¬ê³  ë¶€ì¡±</option>
                            <option value="product_defect">ìƒí’ˆ ë¶ˆëŸ‰</option>
                            <option value="other">ê¸°íƒ€</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="processAction()">í™•ì¸</button>
            </div>
        </div>
    </div>
</div>

<!-- ì»¬ëŸ¼ ì„¤ì • ëª¨ë‹¬ -->
<div class="modal fade" id="columnSettingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì»¬ëŸ¼ í‘œì‹œ ì„¤ì •</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">í‘œì‹œí•˜ê³  ì‹¶ì€ ì»¬ëŸ¼ì„ ì„ íƒí•˜ì„¸ìš”:</p>
                <div id="columnCheckboxContainer">
                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </div>
                <hr>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="selectAllColumns()">ì „ì²´ì„ íƒ</button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="deselectAllColumns()">ì „ì²´í•´ì œ</button>
                    <button class="btn btn-outline-success btn-sm" onclick="resetToDefault()">ê¸°ë³¸ê°’ë³µì›</button>
                    <button class="btn btn-outline-warning btn-sm" onclick="resetColumnWidths()">ì»¬ëŸ¼ ë„ˆë¹„ ì´ˆê¸°í™”</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="applyColumnSettings()">ì ìš©</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentPageType = '{{ page_type }}';
let currentOrderStatus = '{{ order_status }}';
let orders = [];

// í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    initializeDates();
    loadOrders();
    initializeColumnResize();
    loadColumnWidths();
    loadColumnSettings();

    // ê¸°ê°„ ì„ íƒ ì´ë²¤íŠ¸
    document.getElementById('periodSelect').addEventListener('change', function() {
        if (this.value) {
            setPeriod(parseInt(this.value));
        }
    });

    // í¼ ì œì¶œ ì´ë²¤íŠ¸
    document.getElementById('filterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        loadOrders();
    });
});

// ë‚ ì§œ ì´ˆê¸°í™” (í˜ì´ì§€ íƒ€ì…ì— ë”°ë¥¸ ê¸°ë³¸ ê¸°ê°„ ì ìš©)
async function initializeDates() {
    console.log('initializeDates í•¨ìˆ˜ í˜¸ì¶œ');
    console.log('í˜„ì¬ í˜ì´ì§€ íƒ€ì…:', currentPageType);

    try {
        // í˜ì´ì§€ íƒ€ì…ë³„ ê¸°ë³¸ ê¸°ê°„ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        const response = await fetch(`/api/settings/period/${currentPageType}`);
        const result = await response.json();

        let defaultDays = 7; // ê¸°ë³¸ê°’

        if (result.success && result.data) {
            defaultDays = result.data.days;
            console.log(`${currentPageType} í˜ì´ì§€ì˜ ê¸°ë³¸ ê¸°ê°„: ${defaultDays}ì¼ (ì„¤ì •: ${result.data.env_key})`);

            // í˜„ì¬ ê¸°ë³¸ ê¸°ê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
            document.getElementById('currentDefaultPeriod').textContent = `ê¸°ë³¸: ${defaultDays}ì¼`;
        } else {
            console.warn(`í˜ì´ì§€ íƒ€ì…ë³„ ê¸°ê°„ ì„¤ì • ì‹¤íŒ¨, ê¸°ë³¸ê°’ ${defaultDays}ì¼ ì‚¬ìš©:`, result.error);
            document.getElementById('currentDefaultPeriod').textContent = `ê¸°ë³¸: ${defaultDays}ì¼`;
        }

        // ë‚ ì§œ ì„¤ì •
        const today = new Date();
        const startDate = new Date(today.getTime() - (defaultDays * 24 * 60 * 60 * 1000));

        const startDateValue = startDate.toISOString().split('T')[0];
        const endDateValue = today.toISOString().split('T')[0];

        console.log('ì„¤ì •í•  ì‹œì‘ì¼:', startDateValue);
        console.log('ì„¤ì •í•  ì¢…ë£Œì¼:', endDateValue);
        console.log('ì„¤ì •í•  ê¸°ê°„:', defaultDays + 'ì¼');

        document.getElementById('startDate').value = startDateValue;
        document.getElementById('endDate').value = endDateValue;

        // ê¸°ê°„ ì„ íƒ ë“œë¡­ë‹¤ìš´ì— í•´ë‹¹ ê°’ì´ ìˆìœ¼ë©´ ì„¤ì •
        const periodSelect = document.getElementById('periodSelect');
        const availableOptions = Array.from(periodSelect.options).map(opt => opt.value);
        if (availableOptions.includes(defaultDays.toString())) {
            periodSelect.value = defaultDays.toString();
        } else {
            periodSelect.value = ''; // "ì§ì ‘ ì„ íƒ"ìœ¼ë¡œ ì„¤ì •
            console.log(`ê¸°ê°„ ${defaultDays}ì¼ì€ ì„ íƒ ì˜µì…˜ì— ì—†ìŒ, "ì§ì ‘ ì„ íƒ"ìœ¼ë¡œ ì„¤ì •`);
        }

        console.log('ì‹¤ì œ ì„¤ì •ëœ ì‹œì‘ì¼:', document.getElementById('startDate').value);
        console.log('ì‹¤ì œ ì„¤ì •ëœ ì¢…ë£Œì¼:', document.getElementById('endDate').value);
        console.log('ì‹¤ì œ ì„¤ì •ëœ ê¸°ê°„ ì˜µì…˜:', periodSelect.value);

    } catch (error) {
        console.error('ê¸°ë³¸ ê¸°ê°„ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);

        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ 7ì¼ë¡œ ì„¤ì •
        const today = new Date();
        const weekAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));

        document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
        document.getElementById('endDate').value = today.toISOString().split('T')[0];
        document.getElementById('periodSelect').value = '7';
    }
}

// ê¸°ê°„ ì„¤ì •
function setPeriod(days) {
    const today = new Date();
    const startDate = new Date(today.getTime() - (days * 24 * 60 * 60 * 1000));

    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
}

// ì£¼ë¬¸ ë¡œë“œ (ë°ì´í„°ë² ì´ìŠ¤ ì „ìš© - íƒ­ ìµœì´ˆ ì§„ì…ìš©)
async function loadOrders() {
    console.log('loadOrders í•¨ìˆ˜ í˜¸ì¶œ (DB ì „ìš©)');
    showLoading(true);

    try {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        console.log('í˜„ì¬ í˜ì´ì§€ íƒ€ì…:', currentPageType);
        console.log('í˜„ì¬ ì£¼ë¬¸ ìƒíƒœ:', currentOrderStatus);
        console.log('ì‹œì‘ì¼:', startDate);
        console.log('ì¢…ë£Œì¼:', endDate);

        const params = new URLSearchParams({
            start_date: startDate,
            end_date: endDate,
            order_status: currentOrderStatus,
            page_type: currentPageType,  // í˜ì´ì§€ íƒ€ì… ì¶”ê°€
            limit: 100
        });

        console.log('DB ì¡°íšŒ URL:', `/api/orders?${params}`);

        const response = await fetch(`/api/orders?${params}`);
        const data = await response.json();

        console.log('DB ì‘ë‹µ:', data);
        console.log('ì£¼ë¬¸ ìˆ˜:', data.orders ? data.orders.length : 0);

        if (data.success) {
            orders = data.orders;
            console.log('renderOrders í˜¸ì¶œ ì „, orders:', orders);
            renderOrders(orders);
            updateOrderCount(orders.length);
            console.log('renderOrders í˜¸ì¶œ ì™„ë£Œ');
        } else {
            console.error('API ì‘ë‹µ ì‹¤íŒ¨:', data.error);
            throw new Error(data.error || 'ì£¼ë¬¸ ë¡œë“œ ì‹¤íŒ¨');
        }
    } catch (error) {
        console.error('ì£¼ë¬¸ ë¡œë“œ ì˜¤ë¥˜:', error);
        alert('ì£¼ë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// ì£¼ë¬¸ ê°±ì‹  (API í˜¸ì¶œ í›„ DB ì €ì¥ - ì¡°íšŒ ë²„íŠ¼ìš©)
async function refreshOrders() {
    console.log('refreshOrders í•¨ìˆ˜ í˜¸ì¶œ (API ê°±ì‹ )');
    showLoading(true);

    try {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        console.log('í˜„ì¬ í˜ì´ì§€ íƒ€ì…:', currentPageType);
        console.log('í˜„ì¬ ì£¼ë¬¸ ìƒíƒœ:', currentOrderStatus);
        console.log('ì‹œì‘ì¼:', startDate);
        console.log('ì¢…ë£Œì¼:', endDate);

        const params = new URLSearchParams({
            start_date: startDate,
            end_date: endDate,
            order_status: currentOrderStatus,
            page_type: currentPageType,  // í˜ì´ì§€ íƒ€ì… ì¶”ê°€
            limit: 100
        });

        console.log('API ê°±ì‹  URL:', `/api/orders/refresh?${params}`);

        const response = await fetch(`/api/orders/refresh?${params}`);
        const data = await response.json();

        console.log('API ê°±ì‹  ì‘ë‹µ:', data);
        console.log('ì£¼ë¬¸ ìˆ˜:', data.orders ? data.orders.length : 0);

        if (data.success) {
            orders = data.orders;
            console.log('renderOrders í˜¸ì¶œ ì „, orders:', orders);
            renderOrders(orders);
            updateOrderCount(orders.length);
            console.log('renderOrders í˜¸ì¶œ ì™„ë£Œ');
        } else {
            console.error('API ê°±ì‹  ì‘ë‹µ ì‹¤íŒ¨:', data.error);
            throw new Error(data.error || 'ì£¼ë¬¸ ê°±ì‹  ì‹¤íŒ¨');
        }
    } catch (error) {
        console.error('ì£¼ë¬¸ ê°±ì‹  ì˜¤ë¥˜:', error);
        alert('ì£¼ë¬¸ì„ ê°±ì‹ í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// ì£¼ë¬¸ í…Œì´ë¸” ë Œë”ë§
function renderOrders(orderList) {
    console.log('renderOrders í•¨ìˆ˜ ì‹œì‘, orderList:', orderList);

    const tbody = document.getElementById('ordersTableBody');
    const noOrdersMessage = document.getElementById('noOrdersMessage');

    console.log('tbody ìš”ì†Œ:', tbody);
    console.log('noOrdersMessage ìš”ì†Œ:', noOrdersMessage);

    if (orderList.length === 0) {
        console.log('ì£¼ë¬¸ ëª©ë¡ì´ ë¹„ì–´ìˆìŒ');
        tbody.innerHTML = '';
        noOrdersMessage.classList.remove('d-none');
        return;
    }

    console.log('ì£¼ë¬¸ ëª©ë¡ ë Œë”ë§ ì‹œì‘, ì´', orderList.length, 'ê±´');
    noOrdersMessage.classList.add('d-none');

    tbody.innerHTML = orderList.map((order, index) => {
        if (currentPageType === 'order_confirmation') {
            // ë°œì£¼í™•ì¸/ë°œì†¡ê´€ë¦¬ í˜ì´ì§€
            return `
                <tr>
                    <td>
                        <input type="checkbox" class="order-checkbox" value="${order.order_id}">
                    </td>
                    <td>
                        <small>${formatDate(order.shipping_due_date)}</small>
                    </td>
                    <td>
                        <small>${formatDate(order.order_date)}</small>
                    </td>
                    <td>
                        <small class="text-muted">${order.product_order_id || '-'}</small>
                    </td>
                    <td>
                        <small class="text-muted">${order.product_number || '-'}</small>
                    </td>
                    <td>
                        <div class="text-truncate" style="max-width: 190px;" title="${order.product_name || '-'}">
                            ${order.product_name || '-'}
                        </div>
                    </td>
                    <td>
                        <div class="text-truncate" style="max-width: 140px;" title="${order.product_option || '-'}">
                            ${order.product_option || '-'}
                        </div>
                    </td>
                    <td class="text-end">
                        ${formatPrice(order.price)}
                    </td>
                    <td>${order.buyer_name || order.customer_name || '-'}</td>
                    <td>
                        <small>${order.buyer_phone || order.customer_phone || '-'}</small>
                    </td>
                    <td>${order.recipient_name || '-'}</td>
                    <td>
                        <div class="text-truncate" style="max-width: 190px;" title="${order.shipping_address || '-'}">
                            ${order.shipping_address || '-'}
                        </div>
                    </td>
                    <td>
                        <small>${order.recipient_phone || '-'}</small>
                    </td>
                    <td>${order.shipping_company || '-'}</td>
                    <td>
                        <small>${order.tracking_number || '-'}</small>
                    </td>
                    <td>
                        <span class="badge ${getConfirmationStatusClass(order.place_order_status)}">
                            ${getConfirmationStatusText(order.place_order_status)}
                        </span>
                    </td>
                    <td>
                        ${getActionButtons(order)}
                    </td>
                </tr>
            `;
        } else {
            // ë‹¤ë¥¸ í˜ì´ì§€ë“¤
            return `
                <tr>
                    <td>
                        <input type="checkbox" class="order-checkbox" value="${order.order_id}">
                    </td>
                    <td>
                        <small class="text-muted">${order.order_id || '-'}</small>
                    </td>
                    <td>
                        <div class="text-truncate" style="max-width: 190px;" title="${order.product_name || '-'}">
                            ${order.product_name || '-'}
                        </div>
                    </td>
                    <td>${order.customer_name || '-'}</td>
                    <td>
                        <small>${formatDate(order.order_date)}</small>
                    </td>
                    <td class="text-end">
                        ${formatPrice(order.price)}
                    </td>
                    <td class="text-center">${order.quantity || 1}</td>
                    <td>
                        <span class="status-badge ${getStatusBadgeClass(order.status)}">
                            ${getStatusText(order.status)}
                        </span>
                    </td>
                    <td>
                        <small>${order.tracking_number || '-'}</small>
                    </td>
                    ${currentPageType !== 'order_confirmation' ? `
                    <td>
                        ${getActionButtons(order)}
                    </td>
                    ` : ''}
                </tr>
            `;
        }
    }).join('');

    // ë Œë”ë§ í›„ ì»¬ëŸ¼ í‘œì‹œ ì„¤ì • ì ìš©
    updateTableColumns();
}

// ìƒíƒœë³„ ë°°ì§€ í´ë˜ìŠ¤
function getStatusBadgeClass(status) {
    switch(status) {
        case 'PAYED': return 'bg-success';
        case 'CONFIRMED': return 'bg-primary';
        case 'DISPATCHED': return 'bg-info';
        case 'DELIVERED': return 'bg-secondary';
        case 'PURCHASE_DECIDED': return 'bg-dark';
        case 'CANCELED': return 'bg-danger';
        case 'RETURN_REQUESTED': return 'bg-warning';
        default: return 'bg-light text-dark';
    }
}

// ìƒíƒœ í…ìŠ¤íŠ¸
function getStatusText(status) {
    switch(status) {
        case 'PAYED': return 'ê²°ì œì™„ë£Œ';
        case 'CONFIRMED': return 'ì£¼ë¬¸í™•ì¸';
        case 'DISPATCHED': return 'ë°œì†¡ì™„ë£Œ';
        case 'DELIVERED': return 'ë°°ì†¡ì™„ë£Œ';
        case 'PURCHASE_DECIDED': return 'êµ¬ë§¤í™•ì •';
        case 'CANCELED': return 'ì£¼ë¬¸ì·¨ì†Œ';
        case 'RETURN_REQUESTED': return 'ë°˜í’ˆìš”ì²­';
        default: return status || '-';
    }
}

// ë°œì£¼í™•ì¸ ìƒíƒœë³„ ë°°ì§€ í´ë˜ìŠ¤
function getConfirmationStatusClass(placeOrderStatus) {
    switch(placeOrderStatus) {
        case 'NOT_YET': return 'bg-warning text-dark';  // ë¯¸í™•ì¸ (ì£¼í™©)
        case 'OK': return 'bg-success';                 // í™•ì¸ì™„ë£Œ (ë…¹ìƒ‰)
        case null:
        case undefined: return 'bg-secondary';          // ì •ë³´ì—†ìŒ (íšŒìƒ‰)
        default: return 'bg-light text-dark';           // ê¸°íƒ€
    }
}

// ë°œì£¼í™•ì¸ ìƒíƒœ í…ìŠ¤íŠ¸
function getConfirmationStatusText(placeOrderStatus) {
    switch(placeOrderStatus) {
        case 'NOT_YET': return 'ë¯¸í™•ì¸';
        case 'OK': return 'í™•ì¸ì™„ë£Œ';
        case null:
        case undefined: return 'ì •ë³´ì—†ìŒ';
        default: return placeOrderStatus || '-';
    }
}

// ì•¡ì…˜ ë²„íŠ¼ ìƒì„±
function getActionButtons(order) {
    switch(currentPageType) {
        case 'order_confirmation':
            // ë°œì£¼í™•ì¸ ìƒíƒœì— ë”°ë¼ ë‹¤ë¥¸ ë²„íŠ¼ í‘œì‹œ
            if (order.place_order_status === 'NOT_YET') {
                return `
                    <button class="btn btn-sm btn-success btn-action" onclick="showActionModal('${order.order_id}', 'confirm_order', 'ë°œì£¼ í™•ì¸')">
                        ë°œì£¼í™•ì¸
                    </button>
                `;
            } else if (order.place_order_status === 'OK') {
                return `
                    <button class="btn btn-sm btn-primary btn-action" onclick="showActionModal('${order.order_id}', 'dispatch_order', 'ë°œì†¡ ì²˜ë¦¬')">
                        ë°œì†¡ì²˜ë¦¬
                    </button>
                `;
            } else {
                return '<span class="text-muted">-</span>';
            }
        case 'new_orders':
            return `
                <button class="btn btn-sm btn-success btn-action" onclick="showActionModal('${order.order_id}', 'confirm_order', 'ì£¼ë¬¸ í™•ì¸')">
                    í™•ì¸
                </button>
            `;
        case 'shipping_pending':
            return `
                <button class="btn btn-sm btn-primary btn-action" onclick="showActionModal('${order.order_id}', 'dispatch_order', 'ë°œì†¡ ì²˜ë¦¬')">
                    ë°œì†¡
                </button>
            `;
        case 'cancel_orders':
            return `
                <button class="btn btn-sm btn-warning btn-action" onclick="showActionModal('${order.order_id}', 'cancel_order', 'ì£¼ë¬¸ ì·¨ì†Œ')">
                    ì·¨ì†Œ
                </button>
            `;
        default:
            return '<span class="text-muted">-</span>';
    }
}

// ì•¡ì…˜ ëª¨ë‹¬ í‘œì‹œ
function showActionModal(orderId, action, title) {
    document.getElementById('actionOrderId').value = orderId;
    document.getElementById('actionType').value = action;
    document.getElementById('actionModalTitle').textContent = title;

    // í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
    document.getElementById('trackingNumberField').style.display =
        action === 'dispatch_order' ? 'block' : 'none';
    document.getElementById('cancelReasonField').style.display =
        action === 'cancel_order' ? 'block' : 'none';

    new bootstrap.Modal(document.getElementById('actionModal')).show();
}

// ì•¡ì…˜ ì²˜ë¦¬
async function processAction() {
    const form = document.getElementById('actionForm');
    const formData = new FormData(form);

    const actionData = {
        order_id: formData.get('order_id'),
        action: formData.get('action'),
        data: {}
    };

    if (formData.get('tracking_number')) {
        actionData.data.tracking_number = formData.get('tracking_number');
    }
    if (formData.get('cancel_reason')) {
        actionData.data.cancel_reason = formData.get('cancel_reason');
    }

    try {
        showLoading(true);

        const response = await fetch('/api/orders/action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(actionData)
        });

        const result = await response.json();

        if (result.success) {
            alert(result.message);
            bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();
            loadOrders(); // ì£¼ë¬¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } else {
            throw new Error(result.error || 'ì²˜ë¦¬ ì‹¤íŒ¨');
        }
    } catch (error) {
        console.error('ì•¡ì…˜ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// ì „ì²´ ì„ íƒ/í•´ì œ
function toggleAllOrders() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.order-checkbox');

    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

// Excel ë‚´ë³´ë‚´ê¸°
function exportToExcel() {
    // ì¶”í›„ êµ¬í˜„ (í˜„ì¬ëŠ” ì•Œë¦¼ë§Œ)
    alert('Excel ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì´ ê³§ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.');
}

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
}

function formatPrice(price) {
    if (!price) return '-';
    return new Intl.NumberFormat('ko-KR').format(price) + 'ì›';
}

function updateOrderCount(count) {
    document.getElementById('totalCount').textContent = count;
}

function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = show ? 'flex' : 'none';
}

// í˜ì´ì§€ë³„ ê¸°ê°„ ì„¤ì • ì €ì¥
async function savePeriodSetting() {
    const periodSelect = document.getElementById('periodSelect');
    const selectedDays = periodSelect.value;

    if (!selectedDays) {
        alert('ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    if (confirm(`ì´ í˜ì´ì§€(${currentPageType})ì˜ ê¸°ë³¸ ì¡°íšŒ ê¸°ê°„ì„ ${selectedDays}ì¼ë¡œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        try {
            console.log(`ê¸°ê°„ ì„¤ì • ì €ì¥: ${currentPageType} -> ${selectedDays}ì¼`);

            const response = await fetch(`/api/settings/period/${currentPageType}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ days: parseInt(selectedDays) })
            });

            const result = await response.json();

            if (result.success) {
                alert(result.data.message);

                // í˜„ì¬ ê¸°ë³¸ ê¸°ê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
                document.getElementById('currentDefaultPeriod').textContent = `ê¸°ë³¸: ${selectedDays}ì¼`;

                console.log(`ê¸°ê°„ ì„¤ì • ì €ì¥ ì„±ê³µ: ${result.data.env_key} = ${selectedDays}ì¼`);
            } else {
                throw new Error(result.error || 'ì €ì¥ ì‹¤íŒ¨');
            }
        } catch (error) {
            console.error('ê¸°ê°„ ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', error);
            alert('ê¸°ê°„ ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    }
}

// ê¸°ê°„ ì„¤ì • ë„ì›€ë§
function showPeriodHelp() {
    const pageTypeNames = {
        'new-orders': 'ì‹ ê·œì£¼ë¬¸',
        'shipping-pending': 'ë°œì†¡ëŒ€ê¸°',
        'shipping-in-progress': 'ë°°ì†¡ì¤‘',
        'shipping-completed': 'ë°°ì†¡ì™„ë£Œ',
        'purchase-decided': 'êµ¬ë§¤í™•ì •',
        'cancel': 'ì·¨ì†Œì£¼ë¬¸',
        'return-exchange': 'ë°˜í’ˆ/êµí™˜',
        'cancel-return-exchange': 'ì·¨ì†Œ/ë°˜í’ˆ/êµí™˜'
    };

    const currentPageName = pageTypeNames[currentPageType] || currentPageType;

    const helpText = `ğŸ“… ${currentPageName} í˜ì´ì§€ ê¸°ê°„ ì„¤ì • ë„ì›€ë§

ğŸ”¹ ê¸°ë³¸ ê¸°ê°„ ì„¤ì •
  - ì´ í˜ì´ì§€ë¥¼ ì—´ ë•Œë§ˆë‹¤ ìë™ìœ¼ë¡œ ì ìš©ë˜ëŠ” ì¡°íšŒ ê¸°ê°„ì…ë‹ˆë‹¤
  - ì„¤ì • > ì¡°ê±´ì„¤ì • íƒ­ì—ì„œë„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

ğŸ”¹ ê¸°ê°„ ì €ì¥ ë°©ë²•
  1. ë“œë¡­ë‹¤ìš´ì—ì„œ ì›í•˜ëŠ” ê¸°ê°„ì„ ì„ íƒ
  2. ğŸ’¾ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì €ì¥
  3. ë‹¤ìŒì— ì´ í˜ì´ì§€ë¥¼ ì—´ë©´ ì €ì¥í•œ ê¸°ê°„ì´ ìë™ ì ìš©ë©ë‹ˆë‹¤

ğŸ”¹ ì£¼ì˜ì‚¬í•­
  - 1ì¼~365ì¼ê¹Œì§€ ì„¤ì • ê°€ëŠ¥í•©ë‹ˆë‹¤
  - "ì§ì ‘ ì„ íƒ"ì¸ ê²½ìš° ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤
  - ì €ì¥ëœ ì„¤ì •ì€ .env íŒŒì¼ì— ì˜êµ¬ ì €ì¥ë©ë‹ˆë‹¤

ğŸ’¡ íŒ: ìì£¼ ì‚¬ìš©í•˜ëŠ” ê¸°ê°„ì„ ì €ì¥í•´ë‘ë©´ ë§¤ë²ˆ ì„¤ì •í•  í•„ìš”ê°€ ì—†ì–´ í¸ë¦¬í•©ë‹ˆë‹¤!`;

    alert(helpText);
}

// í˜ì´ì§€ íƒ€ì…ë³„ ì»¬ëŸ¼ ì„¤ì •
function getDefaultColumnSettings() {
    if (currentPageType === 'order_confirmation') {
        // ë°œì£¼í™•ì¸/ë°œì†¡ê´€ë¦¬ í˜ì´ì§€ ì „ìš© ì»¬ëŸ¼ë“¤
        return {
            shipping_due_date: true,
            order_date: true,
            product_order_id: true,
            product_number: true,
            product_name: true,
            product_option: true,
            price: true,
            buyer_name: true,
            buyer_phone: true,
            recipient_name: true,
            shipping_address: true,
            recipient_phone: true,
            shipping_company: true,
            tracking_number: true,
            place_order_status: true
        };
    } else {
        // ë‹¤ë¥¸ í˜ì´ì§€ë“¤ì˜ ê¸°ë³¸ ì»¬ëŸ¼ë“¤
        return {
            order_id: true,
            product_name: true,
            customer_name: true,
            order_date: true,
            price: true,
            quantity: true,
            status: true,
            tracking_number: true
        };
    }
}

let columnSettings = getDefaultColumnSettings();

function showColumnSettings() {
    // ì»¬ëŸ¼ ì²´í¬ë°•ìŠ¤ë¥¼ ë™ì ìœ¼ë¡œ ìƒì„±
    generateColumnCheckboxes();

    // í˜„ì¬ ì„¤ì •ìœ¼ë¡œ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
    Object.keys(columnSettings).forEach(column => {
        const checkbox = document.getElementById(`col-${column}`);
        if (checkbox) {
            checkbox.checked = columnSettings[column];
        }
    });

    // ëª¨ë‹¬ í‘œì‹œ
    new bootstrap.Modal(document.getElementById('columnSettingsModal')).show();
}

function generateColumnCheckboxes() {
    const container = document.getElementById('columnCheckboxContainer');

    // í˜ì´ì§€ íƒ€ì…ë³„ ì»¬ëŸ¼ ë¼ë²¨ ì •ì˜
    const columnLabels = currentPageType === 'order_confirmation' ? {
        shipping_due_date: 'ë°œì†¡ê¸°í•œ',
        order_date: 'ì£¼ë¬¸ì¼ì',
        product_order_id: 'ìƒí’ˆì£¼ë¬¸ë²ˆí˜¸',
        product_number: 'ìƒí’ˆë²ˆí˜¸',
        product_name: 'ìƒí’ˆëª…',
        product_option: 'ì˜µì…˜ì •ë³´',
        price: 'ê°€ê²©',
        buyer_name: 'êµ¬ë§¤ìëª…',
        buyer_phone: 'êµ¬ë§¤ìì—°ë½ì²˜',
        recipient_name: 'ìˆ˜ì·¨ì¸ëª…',
        shipping_address: 'ë°°ì†¡ì§€ì£¼ì†Œ',
        recipient_phone: 'ìˆ˜ì·¨ì¸ì—°ë½ì²˜',
        shipping_company: 'íƒë°°ì‚¬',
        tracking_number: 'ì†¡ì¥ë²ˆí˜¸',
        place_order_status: 'ë°œì£¼í™•ì¸ìƒíƒœ'
    } : {
        order_id: 'ì£¼ë¬¸ë²ˆí˜¸',
        product_name: 'ìƒí’ˆëª…',
        customer_name: 'ê³ ê°ëª…',
        order_date: 'ì£¼ë¬¸ì¼ì‹œ',
        price: 'ê¸ˆì•¡',
        quantity: 'ìˆ˜ëŸ‰',
        status: 'ìƒíƒœ',
        tracking_number: 'ì†¡ì¥ë²ˆí˜¸'
    };

    const columns = Object.keys(columnLabels);
    const mid = Math.ceil(columns.length / 2);

    let html = '<div class="row">';

    // ì²« ë²ˆì§¸ ì»¬ëŸ¼
    html += '<div class="col-6">';
    for (let i = 0; i < mid; i++) {
        const column = columns[i];
        const label = columnLabels[column];
        html += `
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="col-${column}" value="${column}" checked>
                <label class="form-check-label" for="col-${column}">${label}</label>
            </div>
        `;
    }
    html += '</div>';

    // ë‘ ë²ˆì§¸ ì»¬ëŸ¼
    html += '<div class="col-6">';
    for (let i = mid; i < columns.length; i++) {
        const column = columns[i];
        const label = columnLabels[column];
        html += `
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="col-${column}" value="${column}" checked>
                <label class="form-check-label" for="col-${column}">${label}</label>
            </div>
        `;
    }
    html += '</div>';

    html += '</div>';

    container.innerHTML = html;
}

function selectAllColumns() {
    Object.keys(columnSettings).forEach(column => {
        const checkbox = document.getElementById(`col-${column}`);
        if (checkbox) checkbox.checked = true;
    });
}

function deselectAllColumns() {
    Object.keys(columnSettings).forEach(column => {
        const checkbox = document.getElementById(`col-${column}`);
        if (checkbox) checkbox.checked = false;
    });
}

function resetToDefault() {
    // í˜ì´ì§€ë³„ ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ì´ˆê¸°í™”
    columnSettings = getDefaultColumnSettings();

    Object.keys(columnSettings).forEach(column => {
        const checkbox = document.getElementById(`col-${column}`);
        if (checkbox) checkbox.checked = true;
    });
}

function applyColumnSettings() {
    // ì²´í¬ë°•ìŠ¤ ìƒíƒœë¥¼ columnSettingsì— ì €ì¥
    Object.keys(columnSettings).forEach(column => {
        const checkbox = document.getElementById(`col-${column}`);
        if (checkbox) {
            columnSettings[column] = checkbox.checked;
        }
    });

    // í…Œì´ë¸” ì»¬ëŸ¼ í‘œì‹œ/ìˆ¨ê¹€ ì ìš©
    updateTableColumns();

    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    localStorage.setItem(`columnSettings_${currentPageType}`, JSON.stringify(columnSettings));

    // ëª¨ë‹¬ ë‹«ê¸°
    bootstrap.Modal.getInstance(document.getElementById('columnSettingsModal')).hide();

    alert('ì»¬ëŸ¼ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function updateTableColumns() {
    const table = document.querySelector('.table');
    if (!table) return;

    // í—¤ë” ì»¬ëŸ¼ ì—…ë°ì´íŠ¸
    const headerCells = table.querySelectorAll('thead th[data-column]');
    headerCells.forEach(cell => {
        const column = cell.getAttribute('data-column');
        if (column === 'select' || column === 'actions') {
            cell.style.display = '';
        } else {
            cell.style.display = columnSettings[column] ? '' : 'none';
        }
    });

    // ë°ì´í„° í–‰ ì»¬ëŸ¼ ì—…ë°ì´íŠ¸
    const dataRows = table.querySelectorAll('tbody tr');
    dataRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        cells.forEach((cell, index) => {
            if (index === 0 || index === cells.length - 1) {
                cell.style.display = '';
                return;
            }

            const columnOrder = currentPageType === 'order_confirmation' ? [
                'shipping_due_date', 'order_date', 'product_order_id', 'product_number',
                'product_name', 'product_option', 'price', 'buyer_name', 'buyer_phone',
                'recipient_name', 'shipping_address', 'recipient_phone', 'shipping_company',
                'tracking_number', 'place_order_status'
            ] : [
                'order_id', 'product_name', 'customer_name', 'order_date',
                'price', 'quantity', 'status', 'tracking_number'
            ];

            const column = columnOrder[index - 1];
            if (column) {
                cell.style.display = columnSettings[column] ? '' : 'none';
            }
        });
    });
}

function loadColumnSettings() {
    const saved = localStorage.getItem(`columnSettings_${currentPageType}`);
    if (saved) {
        columnSettings = { ...columnSettings, ...JSON.parse(saved) };
        updateTableColumns();
    }
}

// ì¤‘ë³µ ì œê±°ë¨ - ì´ë¯¸ ìœ„ì—ì„œ ì²˜ë¦¬í•¨

// ì»¬ëŸ¼ í¬ê¸° ì¡°ì ˆ ê¸°ëŠ¥ ì´ˆê¸°í™”
function initializeColumnResize() {
    const table = document.querySelector('.table');
    if (!table) return;

    let isResizing = false;
    let currentColumn = null;
    let startX = 0;
    let startWidth = 0;

    // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    table.addEventListener('mousedown', function(e) {
        if (e.target.tagName === 'TH') {
            const rect = e.target.getBoundingClientRect();
            const rightEdge = rect.right - e.clientX < 10; // ì˜¤ë¥¸ìª½ ê°€ì¥ìë¦¬ 10px ë‚´

            if (rightEdge) {
                isResizing = true;
                currentColumn = e.target;
                startX = e.clientX;
                startWidth = parseInt(document.defaultView.getComputedStyle(currentColumn).width, 10);

                // ì»¤ì„œ ë³€ê²½
                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            }
        }
    });

    document.addEventListener('mousemove', function(e) {
        const table = document.querySelector('.table');
        if (!table) return;

        if (isResizing && currentColumn) {
            const diff = e.clientX - startX;
            const newWidth = Math.max(50, startWidth + diff); // ìµœì†Œ ë„ˆë¹„ 50px

            currentColumn.style.width = newWidth + 'px';
            currentColumn.style.minWidth = newWidth + 'px';
        } else {
            // ë§ˆìš°ìŠ¤ê°€ ì»¬ëŸ¼ ê²½ê³„ ê·¼ì²˜ì— ìˆëŠ”ì§€ í™•ì¸
            const th = e.target.closest('th');
            if (th) {
                const rect = th.getBoundingClientRect();
                const rightEdge = rect.right - e.clientX < 10;

                if (rightEdge) {
                    document.body.style.cursor = 'col-resize';
                } else {
                    document.body.style.cursor = 'default';
                }
            } else {
                document.body.style.cursor = 'default';
            }
        }
    });

    document.addEventListener('mouseup', function() {
        if (isResizing && currentColumn) {
            isResizing = false;

            // ì»¬ëŸ¼ ë„ˆë¹„ ì €ì¥
            saveColumnWidths();

            currentColumn = null;
            document.body.style.cursor = 'default';
        }
    });
}

// ì»¬ëŸ¼ ë„ˆë¹„ ì €ì¥
function saveColumnWidths() {
    try {
        const columnWidths = {};
        const headers = document.querySelectorAll('.table th[data-column]');

        headers.forEach(header => {
            const columnName = header.getAttribute('data-column');
            const width = parseInt(header.style.width || header.offsetWidth);
            if (columnName && width) {
                columnWidths[columnName] = width;
            }
        });

        // localStorageì— ì €ì¥
        localStorage.setItem(`columnWidths_${currentPageType}`, JSON.stringify(columnWidths));
        console.log('ì»¬ëŸ¼ ë„ˆë¹„ ì €ì¥:', columnWidths);

    } catch (error) {
        console.error('ì»¬ëŸ¼ ë„ˆë¹„ ì €ì¥ ì˜¤ë¥˜:', error);
    }
}

// ì €ì¥ëœ ì»¬ëŸ¼ ë„ˆë¹„ ë¶ˆëŸ¬ì˜¤ê¸°
function loadColumnWidths() {
    try {
        const savedWidths = localStorage.getItem(`columnWidths_${currentPageType}`);
        if (savedWidths) {
            const columnWidths = JSON.parse(savedWidths);
            console.log('ì €ì¥ëœ ì»¬ëŸ¼ ë„ˆë¹„ ë¶ˆëŸ¬ì˜¤ê¸°:', columnWidths);

            Object.keys(columnWidths).forEach(columnName => {
                const header = document.querySelector(`th[data-column="${columnName}"]`);
                if (header) {
                    const width = columnWidths[columnName];
                    header.style.width = width + 'px';
                    header.style.minWidth = width + 'px';
                }
            });

            console.log('ì»¬ëŸ¼ ë„ˆë¹„ ì ìš© ì™„ë£Œ');
        }
    } catch (error) {
        console.error('ì»¬ëŸ¼ ë„ˆë¹„ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
    }
}

// ì»¬ëŸ¼ ë„ˆë¹„ ì´ˆê¸°í™”
function resetColumnWidths() {
    try {
        // localStorageì—ì„œ ì‚­ì œ
        localStorage.removeItem(`columnWidths_${currentPageType}`);

        // ê¸°ë³¸ ë„ˆë¹„ë¡œ ë³µì›
        const headers = document.querySelectorAll('.table th[data-column]');
        headers.forEach(header => {
            header.style.width = '';
            header.style.minWidth = '';
        });

        alert('ì»¬ëŸ¼ ë„ˆë¹„ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');

    } catch (error) {
        console.error('ì»¬ëŸ¼ ë„ˆë¹„ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
    }
}
</script>
{% endblock %}