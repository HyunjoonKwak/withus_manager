{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-cog text-primary"></i> ì„¤ì •</h2>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveAllSettings()">
                        <i class="fas fa-save"></i> ëª¨ë“  ì„¤ì • ì €ì¥
                    </button>
                    <button class="btn btn-outline-secondary" onclick="resetToDefaults()">
                        <i class="fas fa-undo"></i> ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
                    </button>
                </div>
            </div>

            <!-- ì„¤ì • íƒ­ -->
            <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">
                        <i class="fas fa-tools"></i> ê¸°ë³¸ì„¤ì •
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="conditions-tab" data-bs-toggle="tab" data-bs-target="#conditions" type="button" role="tab">
                        <i class="fas fa-filter"></i> ì¡°ê±´ì„¤ì •
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button" role="tab">
                        <i class="fas fa-info-circle"></i> ì‹œìŠ¤í…œ ì •ë³´
                    </button>
                </li>
            </ul>

            <!-- íƒ­ ì»¨í…ì¸  -->
            <div class="tab-content" id="settingsTabContent">
                <!-- ê¸°ë³¸ì„¤ì • íƒ­ -->
                <div class="tab-pane fade show active" id="basic" role="tabpanel">
                    <div class="mt-4">
                        <!-- API ì„¤ì • -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="fas fa-plug text-warning"></i> ë„¤ì´ë²„ API ì„¤ì •</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="clientId" class="form-label">í´ë¼ì´ì–¸íŠ¸ ID</label>
                                        <input type="text" class="form-control" id="clientId" placeholder="ë„¤ì´ë²„ í´ë¼ì´ì–¸íŠ¸ ID">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="clientSecret" class="form-label">í´ë¼ì´ì–¸íŠ¸ ì‹œí¬ë¦¿</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="clientSecret" placeholder="ë„¤ì´ë²„ í´ë¼ì´ì–¸íŠ¸ ì‹œí¬ë¦¿">
                                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('clientSecret')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-primary" onclick="testApiConnection()">
                                        <i class="fas fa-flask"></i> API ì—°ê²° í…ŒìŠ¤íŠ¸
                                    </button>
                                    <span id="apiTestResult" class="ms-3"></span>
                                </div>
                            </div>
                        </div>

                        <!-- ì•Œë¦¼ ì„¤ì • -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="fas fa-bell text-info"></i> ì•Œë¦¼ ì„¤ì •</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <label for="discordWebhook" class="form-label">Discord ì›¹í›… URL</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="discordWebhook" placeholder="Discord ì›¹í›… URL">
                                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('discordWebhook')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Discord ì•Œë¦¼ í™œì„±í™”</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="discordEnabled">
                                            <label class="form-check-label" for="discordEnabled">
                                                Discord ì•Œë¦¼ ì‚¬ìš©
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-primary" onclick="testDiscordNotification()">
                                        <i class="fab fa-discord"></i> Discord ì•Œë¦¼ í…ŒìŠ¤íŠ¸
                                    </button>
                                    <span id="discordTestResult" class="ms-3"></span>
                                </div>
                            </div>
                        </div>

                        <!-- IP ê´€ë¦¬ -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="fas fa-globe text-success"></i> í—ˆê°€ëœ ê³µì¸ IP ê´€ë¦¬</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">í˜„ì¬ ê³µì¸ IP:</label>
                                        <div class="d-flex align-items-center">
                                            <strong id="currentIP" class="me-2">í™•ì¸ ì¤‘...</strong>
                                            <span id="ipStatus" class="badge bg-secondary me-2">í™•ì¸ ì¤‘</span>
                                            <button class="btn btn-sm btn-outline-primary" onclick="refreshCurrentIP()">
                                                <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <button class="btn btn-sm btn-outline-info" onclick="showIPHelp()">
                                            <i class="fas fa-question-circle"></i> IP ê´€ë¦¬ ë„ì›€ë§
                                        </button>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">í—ˆê°€ëœ IP ëª©ë¡ (ìµœëŒ€ 5ê°œ)</label>
                                        <select class="form-control" id="ipList" size="5" style="height: 120px;">
                                        </select>
                                        <small class="form-text text-muted">ê¸°ë³¸ê°’: 121.190.40.153, 175.125.204.97</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">IP ê´€ë¦¬</label>
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" id="newIP" placeholder="ìƒˆ IP ì£¼ì†Œ ì…ë ¥">
                                            <button class="btn btn-outline-success" onclick="addIP()">
                                                <i class="fas fa-plus"></i> ì¶”ê°€
                                            </button>
                                        </div>
                                        <div class="btn-group w-100">
                                            <button class="btn btn-outline-primary" onclick="addCurrentIP()">
                                                <i class="fas fa-map-marker-alt"></i> í˜„ì¬IP ì¶”ê°€
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="deleteSelectedIP()">
                                                <i class="fas fa-trash"></i> ì„ íƒ ì‚­ì œ
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ëª¨ë‹ˆí„°ë§ ì„¤ì • -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="fas fa-monitor-heart-rate text-success"></i> ëª¨ë‹ˆí„°ë§ ì„¤ì •</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="checkInterval" class="form-label">ì²´í¬ ê°„ê²© (ì´ˆ)</label>
                                        <input type="number" class="form-control" id="checkInterval" min="60" max="3600" value="300">
                                        <div class="form-text">ê¶Œì¥ê°’: 300ì´ˆ (5ë¶„)</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="refreshInterval" class="form-label">ìë™ ìƒˆë¡œê³ ì¹¨ ê°„ê²© (ì´ˆ)</label>
                                        <input type="number" class="form-control" id="refreshInterval" min="30" max="600" value="60">
                                        <div class="form-text">GUIì—ì„œ ìë™ ìƒˆë¡œê³ ì¹¨ ê°„ê²©</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">ìë™ ìƒˆë¡œê³ ì¹¨</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="autoRefresh">
                                            <label class="form-check-label" for="autoRefresh">
                                                ìë™ ìƒˆë¡œê³ ì¹¨ ì‚¬ìš©
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì¡°ê±´ì„¤ì • íƒ­ -->
                <div class="tab-pane fade" id="conditions" role="tabpanel">
                    <div class="mt-4">
                        <!-- ëŒ€ì‹œë³´ë“œ ì„¤ì • -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-line text-primary"></i> ëŒ€ì‹œë³´ë“œ ì„¤ì •</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="dashboardPeriod" class="form-label">ëŒ€ì‹œë³´ë“œ ì¡°íšŒ ê¸°ê°„ (ì¼)</label>
                                        <input type="number" class="form-control" id="dashboardPeriod" min="1" max="30" value="5">
                                        <div class="form-text">ìµœê·¼ ë©°ì¹ ì˜ ë°ì´í„°ë¥¼ í‘œì‹œí• ì§€ ì„¤ì •</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="quickPeriod" class="form-label">ë¹ ë¥¸ ê¸°ê°„ ì„¤ì • (ì¼)</label>
                                        <input type="number" class="form-control" id="quickPeriod" min="1" max="30" value="3">
                                        <div class="form-text">ë¹ ë¥¸ ì¡°íšŒìš© ê¸°ë³¸ ê¸°ê°„</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ì£¼ë¬¸ ìƒíƒœ ì„¤ì • -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="fas fa-list-check text-warning"></i> ì£¼ë¬¸ ìƒíƒœ ì¡°íšŒ ì„¤ì •</h5>
                            </div>
                            <div class="card-body">
                                <label class="form-label">ì¡°íšŒí•  ì£¼ë¬¸ ìƒíƒœ ì„ íƒ</label>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="orderStatus1" value="PAYMENT_WAITING" checked>
                                            <label class="form-check-label" for="orderStatus1">ê²°ì œëŒ€ê¸°</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="orderStatus2" value="PAYED" checked>
                                            <label class="form-check-label" for="orderStatus2">ê²°ì œì™„ë£Œ</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="orderStatus3" value="DELIVERING" checked>
                                            <label class="form-check-label" for="orderStatus3">ë°°ì†¡ì¤‘</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="orderStatus4" value="DELIVERED" checked>
                                            <label class="form-check-label" for="orderStatus4">ë°°ì†¡ì™„ë£Œ</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="orderStatus5" value="PURCHASE_DECIDED" checked>
                                            <label class="form-check-label" for="orderStatus5">êµ¬ë§¤í™•ì •</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="orderStatus6" value="CANCELED" checked>
                                            <label class="form-check-label" for="orderStatus6">ì£¼ë¬¸ì·¨ì†Œ</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="orderStatus7" value="RETURNED" checked>
                                            <label class="form-check-label" for="orderStatus7">ë°˜í’ˆ</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="orderStatus8" value="EXCHANGED" checked>
                                            <label class="form-check-label" for="orderStatus8">êµí™˜</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-text mt-2">ì„ íƒí•œ ìƒíƒœì˜ ì£¼ë¬¸ë§Œ ì¡°íšŒë©ë‹ˆë‹¤. ê¸°ë³¸ê°’: PAYMENT_WAITING, PAYED, DELIVERING</div>
                            </div>
                        </div>

                        <!-- ìƒí’ˆ ìƒíƒœ ì„¤ì • -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="fas fa-box text-info"></i> ìƒí’ˆ ìƒíƒœ ì¡°íšŒ ì„¤ì •</h5>
                            </div>
                            <div class="card-body">
                                <label class="form-label">ì¡°íšŒí•  ìƒí’ˆ ìƒíƒœ ì„ íƒ</label>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="productStatus1" value="SALE" checked>
                                            <label class="form-check-label" for="productStatus1">íŒë§¤ì¤‘</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="productStatus2" value="WAIT" checked>
                                            <label class="form-check-label" for="productStatus2">íŒë§¤ëŒ€ê¸°</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="productStatus3" value="OUTOFSTOCK" checked>
                                            <label class="form-check-label" for="productStatus3">í’ˆì ˆ</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-text mt-2">ì„ íƒí•œ ìƒíƒœì˜ ìƒí’ˆë§Œ ì¡°íšŒë©ë‹ˆë‹¤. ê¸°ë³¸ê°’: SALE, WAIT, OUTOFSTOCK</div>
                            </div>
                        </div>

                        <!-- ì£¼ë¬¸ ì»¬ëŸ¼ ì„¤ì • -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="fas fa-columns text-secondary"></i> ì£¼ë¬¸ ì»¬ëŸ¼ í‘œì‹œ ì„¤ì •</h5>
                            </div>
                            <div class="card-body">
                                <label class="form-label">í‘œì‹œí•  ì»¬ëŸ¼ ì„ íƒ</label>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="orderCol1" value="ì£¼ë¬¸ID" checked>
                                            <label class="form-check-label" for="orderCol1">ì£¼ë¬¸ID</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="orderCol2" value="ì£¼ë¬¸ì" checked>
                                            <label class="form-check-label" for="orderCol2">ì£¼ë¬¸ì</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="orderCol3" value="ìƒí’ˆëª…" checked>
                                            <label class="form-check-label" for="orderCol3">ìƒí’ˆëª…</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="orderCol4" value="ì˜µì…˜ì •ë³´" checked>
                                            <label class="form-check-label" for="orderCol4">ì˜µì…˜ì •ë³´</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="orderCol5" value="ìˆ˜ëŸ‰" checked>
                                            <label class="form-check-label" for="orderCol5">ìˆ˜ëŸ‰</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="orderCol6" value="ê¸ˆì•¡" checked>
                                            <label class="form-check-label" for="orderCol6">ê¸ˆì•¡</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="orderCol7" value="ë°°ì†¡ì§€ì£¼ì†Œ" checked>
                                            <label class="form-check-label" for="orderCol7">ë°°ì†¡ì§€ì£¼ì†Œ</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="orderCol8" value="ë°°ì†¡ì˜ˆì •ì¼" checked>
                                            <label class="form-check-label" for="orderCol8">ë°°ì†¡ì˜ˆì •ì¼</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="orderCol9" value="ì£¼ë¬¸ì¼ì‹œ" checked>
                                            <label class="form-check-label" for="orderCol9">ì£¼ë¬¸ì¼ì‹œ</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="orderCol10" value="ìƒíƒœ" checked>
                                            <label class="form-check-label" for="orderCol10">ìƒíƒœ</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-text mt-2">ì„ íƒí•œ ì»¬ëŸ¼ë§Œ ì£¼ë¬¸ ëª©ë¡ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
                            </div>
                        </div>

                        <!-- íƒ­ë³„ ê¸°ë³¸ ê¸°ê°„ ì„¤ì • -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="fas fa-calendar-alt text-purple"></i> íƒ­ë³„ ê¸°ë³¸ ê¸°ê°„ ì„¤ì •</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="newOrderDays" class="form-label">ì‹ ê·œì£¼ë¬¸ ê¸°ë³¸ ê¸°ê°„ (ì¼)</label>
                                        <input type="number" class="form-control" id="newOrderDays" min="1" max="90" value="3">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="shippingPendingDays" class="form-label">ë°œì†¡ëŒ€ê¸° ê¸°ë³¸ ê¸°ê°„ (ì¼)</label>
                                        <input type="number" class="form-control" id="shippingPendingDays" min="1" max="90" value="3">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="shippingInProgressDays" class="form-label">ë°°ì†¡ì¤‘ ê¸°ë³¸ ê¸°ê°„ (ì¼)</label>
                                        <input type="number" class="form-control" id="shippingInProgressDays" min="1" max="90" value="30">
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label for="shippingCompletedDays" class="form-label">ë°°ì†¡ì™„ë£Œ ê¸°ë³¸ ê¸°ê°„ (ì¼)</label>
                                        <input type="number" class="form-control" id="shippingCompletedDays" min="1" max="90" value="7">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="purchaseDecidedDays" class="form-label">êµ¬ë§¤í™•ì • ê¸°ë³¸ ê¸°ê°„ (ì¼)</label>
                                        <input type="number" class="form-control" id="purchaseDecidedDays" min="1" max="90" value="3">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="cancelDays" class="form-label">ì·¨ì†Œì£¼ë¬¸ ê¸°ë³¸ ê¸°ê°„ (ì¼)</label>
                                        <input type="number" class="form-control" id="cancelDays" min="1" max="90" value="30">
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label for="returnExchangeDays" class="form-label">ë°˜í’ˆ/êµí™˜ ê¸°ë³¸ ê¸°ê°„ (ì¼)</label>
                                        <input type="number" class="form-control" id="returnExchangeDays" min="1" max="90" value="15">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="cancelReturnExchangeDays" class="form-label">ì·¨ì†Œ/ë°˜í’ˆ/êµí™˜ ê¸°ë³¸ ê¸°ê°„ (ì¼)</label>
                                        <input type="number" class="form-control" id="cancelReturnExchangeDays" min="1" max="90" value="7">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì‹œìŠ¤í…œ ì •ë³´ íƒ­ -->
                <div class="tab-pane fade" id="system" role="tabpanel">
                    <div class="mt-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-info-circle text-secondary"></i> ì‹œìŠ¤í…œ ì •ë³´</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>ë²„ì „:</strong> <span id="systemVersion">{{ version_info.app_version }}</span></p>
                                        <p><strong>ë¹Œë“œ ë‚ ì§œ:</strong> <span id="buildDate">{{ version_info.build_date }}</span></p>
                                        <p><strong>í™˜ê²½:</strong> <span class="badge bg-info">ì›¹ ë²„ì „</span></p>
                                        <p><strong>í”Œë«í¼:</strong> EC2 ìµœì í™”</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>ëª¨ë‹ˆí„°ë§ ìƒíƒœ:</strong> <span id="monitoringStatus" class="badge bg-secondary">í™•ì¸ ì¤‘...</span></p>
                                        <p><strong>ë§ˆì§€ë§‰ ì²´í¬:</strong> <span id="lastCheck">í™•ì¸ ì¤‘...</span></p>
                                        <p><strong>ë©”ëª¨ë¦¬ ì‚¬ìš©:</strong> ~150MB (t2.micro ìµœì í™”)</p>
                                        <p><strong>ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œ:</strong> í™œì„±í™”</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ì „ì—­ ë³€ìˆ˜
let currentSettings = {};
let currentIP = '';

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
document.addEventListener('DOMContentLoaded', function() {
    loadAllSettings();
    updateSystemStatus();
    refreshCurrentIP();

    // 10ì´ˆë§ˆë‹¤ ì‹œìŠ¤í…œ ìƒíƒœ ì—…ë°ì´íŠ¸
    setInterval(updateSystemStatus, 10000);
});

// ëª¨ë“  ì„¤ì • ë¡œë“œ
async function loadAllSettings() {
    try {
        const response = await fetch('/api/settings');
        const result = await response.json();

        if (result.success) {
            currentSettings = result.data;

            // ê¸°ë³¸ì„¤ì •
            document.getElementById('clientId').value = currentSettings.client_id || '';
            document.getElementById('clientSecret').value = currentSettings.client_secret || '';
            document.getElementById('discordWebhook').value = currentSettings.discord_webhook || '';
            document.getElementById('discordEnabled').checked = currentSettings.discord_enabled || false;
            document.getElementById('checkInterval').value = currentSettings.check_interval || 300;
            document.getElementById('refreshInterval').value = currentSettings.refresh_interval || 60;
            document.getElementById('autoRefresh').checked = currentSettings.auto_refresh || false;

            // ì¡°ê±´ì„¤ì •
            document.getElementById('dashboardPeriod').value = currentSettings.dashboard_period || 5;
            document.getElementById('quickPeriod').value = currentSettings.quick_period || 3;

            // í—ˆìš©ëœ IP ë¡œë“œ
            loadIPSettings();

            // íƒ­ë³„ ê¸°ê°„ ì„¤ì •
            document.getElementById('newOrderDays').value = currentSettings.new_order_days || 3;
            document.getElementById('shippingPendingDays').value = currentSettings.shipping_pending_days || 3;
            document.getElementById('shippingInProgressDays').value = currentSettings.shipping_in_progress_days || 30;
            document.getElementById('shippingCompletedDays').value = currentSettings.shipping_completed_days || 7;
            document.getElementById('purchaseDecidedDays').value = currentSettings.purchase_decided_days || 3;
            document.getElementById('cancelDays').value = currentSettings.cancel_days || 30;
            document.getElementById('returnExchangeDays').value = currentSettings.return_exchange_days || 15;
            document.getElementById('cancelReturnExchangeDays').value = currentSettings.cancel_return_exchange_days || 7;

            // ì²´í¬ë°•ìŠ¤ ì„¤ì •ë“¤ ë¡œë“œ
            loadCheckboxSettings();
        }
    } catch (error) {
        showNotification('ì„¤ì • ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
    }
}

// IP ì„¤ì • ë¡œë“œ
function loadIPSettings() {
    const allowedIPs = currentSettings.allowed_ips || '121.190.40.153,175.125.204.97';
    const ipList = allowedIPs.split(',').map(ip => ip.trim()).filter(ip => ip);

    const select = document.getElementById('ipList');
    select.innerHTML = '';

    ipList.forEach(ip => {
        const option = document.createElement('option');
        option.value = ip;
        option.textContent = ip;
        select.appendChild(option);
    });
}

// ì²´í¬ë°•ìŠ¤ ì„¤ì •ë“¤ ë¡œë“œ
function loadCheckboxSettings() {
    // ì£¼ë¬¸ ìƒíƒœ
    const orderStatuses = (currentSettings.order_status_types || 'PAYMENT_WAITING,PAYED,DELIVERING').split(',');
    for (let i = 1; i <= 8; i++) {
        const checkbox = document.getElementById(`orderStatus${i}`);
        if (checkbox && orderStatuses.includes(checkbox.value)) {
            checkbox.checked = true;
        }
    }

    // ìƒí’ˆ ìƒíƒœ
    const productStatuses = (currentSettings.product_status_types || 'SALE,WAIT,OUTOFSTOCK').split(',');
    for (let i = 1; i <= 3; i++) {
        const checkbox = document.getElementById(`productStatus${i}`);
        if (checkbox && productStatuses.includes(checkbox.value)) {
            checkbox.checked = true;
        }
    }

    // ì£¼ë¬¸ ì»¬ëŸ¼
    const orderColumns = (currentSettings.order_columns || 'ì£¼ë¬¸ID,ì£¼ë¬¸ì,ìƒí’ˆëª…,ì˜µì…˜ì •ë³´,ìˆ˜ëŸ‰,ê¸ˆì•¡,ë°°ì†¡ì§€ì£¼ì†Œ,ë°°ì†¡ì˜ˆì •ì¼,ì£¼ë¬¸ì¼ì‹œ,ìƒíƒœ').split(',');
    for (let i = 1; i <= 10; i++) {
        const checkbox = document.getElementById(`orderCol${i}`);
        if (checkbox && orderColumns.includes(checkbox.value)) {
            checkbox.checked = true;
        }
    }
}

// í˜„ì¬ IP ìƒˆë¡œê³ ì¹¨
async function refreshCurrentIP() {
    try {
        document.getElementById('currentIP').textContent = 'í™•ì¸ ì¤‘...';
        document.getElementById('ipStatus').className = 'badge bg-secondary';
        document.getElementById('ipStatus').textContent = 'í™•ì¸ ì¤‘';

        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        currentIP = data.ip;

        document.getElementById('currentIP').textContent = currentIP;

        // IP í—ˆê°€ ìƒíƒœ í™•ì¸
        const allowedIPs = Array.from(document.getElementById('ipList').options).map(opt => opt.value);
        if (allowedIPs.includes(currentIP)) {
            document.getElementById('ipStatus').className = 'badge bg-success';
            document.getElementById('ipStatus').textContent = 'âœ“ í—ˆê°€ë¨';
        } else {
            document.getElementById('ipStatus').className = 'badge bg-warning';
            document.getElementById('ipStatus').textContent = 'âœ— í—ˆê°€ë˜ì§€ ì•ŠìŒ';
        }
    } catch (error) {
        document.getElementById('currentIP').textContent = 'í™•ì¸ ì‹¤íŒ¨';
        document.getElementById('ipStatus').className = 'badge bg-danger';
        document.getElementById('ipStatus').textContent = 'ì˜¤ë¥˜';
        console.error('IP í™•ì¸ ì˜¤ë¥˜:', error);
    }
}

// IP ê´€ë¦¬ í•¨ìˆ˜ë“¤
function addIP() {
    const newIPInput = document.getElementById('newIP');
    const newIP = newIPInput.value.trim();

    if (!newIP) {
        showNotification('IP ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    if (!validateIPFormat(newIP)) {
        showNotification('ì˜¬ë°”ë¥¸ IP ì£¼ì†Œ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.', 'error');
        return;
    }

    const select = document.getElementById('ipList');
    if (select.options.length >= 5) {
        showNotification('ìµœëŒ€ 5ê°œì˜ IPë§Œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
        return;
    }

    // ì¤‘ë³µ í™•ì¸
    for (let option of select.options) {
        if (option.value === newIP) {
            showNotification('ì´ë¯¸ ì¶”ê°€ëœ IP ì£¼ì†Œì…ë‹ˆë‹¤.', 'warning');
            return;
        }
    }

    // IP ì¶”ê°€
    const option = document.createElement('option');
    option.value = newIP;
    option.textContent = newIP;
    select.appendChild(option);

    newIPInput.value = '';
    showNotification('IPê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

function addCurrentIP() {
    if (!currentIP || currentIP === 'í™•ì¸ ì¤‘...' || currentIP === 'í™•ì¸ ì‹¤íŒ¨') {
        showNotification('í˜„ì¬ IPë¥¼ ë¨¼ì € í™•ì¸í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    const select = document.getElementById('ipList');
    if (select.options.length >= 5) {
        showNotification('ìµœëŒ€ 5ê°œì˜ IPë§Œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
        return;
    }

    // ì¤‘ë³µ í™•ì¸
    for (let option of select.options) {
        if (option.value === currentIP) {
            showNotification('í˜„ì¬ IPëŠ” ì´ë¯¸ í—ˆê°€ ëª©ë¡ì— ìˆìŠµë‹ˆë‹¤.', 'info');
            return;
        }
    }

    // IP ì¶”ê°€
    const option = document.createElement('option');
    option.value = currentIP;
    option.textContent = currentIP;
    select.appendChild(option);

    showNotification('í˜„ì¬ IPê°€ í—ˆê°€ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

    // ìƒíƒœ ì—…ë°ì´íŠ¸
    document.getElementById('ipStatus').className = 'badge bg-success';
    document.getElementById('ipStatus').textContent = 'âœ“ í—ˆê°€ë¨';
}

function deleteSelectedIP() {
    const select = document.getElementById('ipList');
    const selectedIndex = select.selectedIndex;

    if (selectedIndex === -1) {
        showNotification('ì‚­ì œí•  IPë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    if (confirm(`IP '${select.options[selectedIndex].value}'ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        select.remove(selectedIndex);
        showNotification('IPê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

        // í˜„ì¬ IP ìƒíƒœ ë‹¤ì‹œ í™•ì¸
        refreshCurrentIP();
    }
}

function validateIPFormat(ip) {
    const pattern = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
    return pattern.test(ip);
}

function showIPHelp() {
    const helpText = `ğŸ’¡ í—ˆê°€ëœ ê³µì¸ IP ê´€ë¦¬ ë„ì›€ë§

ğŸ”¹ í˜„ì¬ ê³µì¸ IP
  - ì›¹ ë¸Œë¼ìš°ì €ê°€ ì‹¤í–‰ë˜ëŠ” í™˜ê²½ì˜ ê³µì¸ IP ì£¼ì†Œì…ë‹ˆë‹¤
  - "ìƒˆë¡œê³ ì¹¨" ë²„íŠ¼ìœ¼ë¡œ ìµœì‹  ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

ğŸ”¹ í—ˆê°€ëœ IP ëª©ë¡ (ìµœëŒ€ 5ê°œ)
  - ë„¤ì´ë²„ ì»¤ë¨¸ìŠ¤ API ì‚¬ìš©ì´ í—ˆê°€ëœ IP ì£¼ì†Œ ëª©ë¡ì…ë‹ˆë‹¤
  - ê¸°ë³¸ê°’: 121.190.40.153, 175.125.204.97

ğŸ”¹ IP ì¶”ê°€/ì‚­ì œ
  - "ì¶”ê°€": ì…ë ¥ì°½ì— IP ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì—¬ ì¶”ê°€
  - "í˜„ì¬IP ì¶”ê°€": í˜„ì¬ ê³µì¸ IPë¥¼ í—ˆê°€ ëª©ë¡ì— ì¶”ê°€
  - "ì„ íƒ ì‚­ì œ": ëª©ë¡ì—ì„œ ì„ íƒí•œ IP ì‚­ì œ

ğŸ”¹ í—ˆê°€ë˜ì§€ ì•Šì€ IPë¡œ ì‹¤í–‰ ì‹œ
  - ì£¼í™©ìƒ‰ "âœ— í—ˆê°€ë˜ì§€ ì•ŠìŒ" í‘œì‹œ
  - ë„¤ì´ë²„ ì»¤ë¨¸ìŠ¤ API ê´€ë¦¬ í˜ì´ì§€ì—ì„œ IP ì¶”ê°€ í•„ìš”

ğŸ“‹ ë„¤ì´ë²„ ì»¤ë¨¸ìŠ¤ API ê´€ë¦¬ í˜ì´ì§€
  - URL: https://apicenter.commerce.naver.com/ko/member/application/manage/list

âš ï¸ ì£¼ì˜ì‚¬í•­
  - IP ë³€ê²½ í›„ "ëª¨ë“  ì„¤ì • ì €ì¥" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì €ì¥í•˜ì„¸ìš”
  - ë„¤ì´ë²„ ì»¤ë¨¸ìŠ¤ APIì—ì„œë„ ë™ì¼í•œ IPë¥¼ í—ˆê°€í•´ì•¼ í•©ë‹ˆë‹¤
  - ìµœëŒ€ 5ê°œì˜ IPë§Œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤`;

    alert(helpText);
}

// ì„¤ì • ì €ì¥ ê´€ë ¨ í•¨ìˆ˜ë“¤
async function saveAllSettings() {
    try {
        const settings = {
            // ê¸°ë³¸ì„¤ì •
            client_id: document.getElementById('clientId').value,
            client_secret: document.getElementById('clientSecret').value,
            discord_webhook: document.getElementById('discordWebhook').value,
            discord_enabled: document.getElementById('discordEnabled').checked,
            check_interval: parseInt(document.getElementById('checkInterval').value),
            refresh_interval: parseInt(document.getElementById('refreshInterval').value),
            auto_refresh: document.getElementById('autoRefresh').checked,

            // ì¡°ê±´ì„¤ì •
            dashboard_period: parseInt(document.getElementById('dashboardPeriod').value),
            quick_period: parseInt(document.getElementById('quickPeriod').value),

            // IP ì„¤ì •
            allowed_ips: Array.from(document.getElementById('ipList').options).map(opt => opt.value).join(','),

            // íƒ­ë³„ ê¸°ê°„ ì„¤ì •
            new_order_days: parseInt(document.getElementById('newOrderDays').value),
            shipping_pending_days: parseInt(document.getElementById('shippingPendingDays').value),
            shipping_in_progress_days: parseInt(document.getElementById('shippingInProgressDays').value),
            shipping_completed_days: parseInt(document.getElementById('shippingCompletedDays').value),
            purchase_decided_days: parseInt(document.getElementById('purchaseDecidedDays').value),
            cancel_days: parseInt(document.getElementById('cancelDays').value),
            return_exchange_days: parseInt(document.getElementById('returnExchangeDays').value),
            cancel_return_exchange_days: parseInt(document.getElementById('cancelReturnExchangeDays').value),

            // ì²´í¬ë°•ìŠ¤ ì„¤ì •ë“¤
            order_status_types: getCheckedValues('orderStatus', 8).join(','),
            product_status_types: getCheckedValues('productStatus', 3).join(','),
            order_columns: getCheckedValues('orderCol', 10).join(',')
        };

        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(settings)
        });

        const result = await response.json();

        if (result.success) {
            showNotification('ëª¨ë“  ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        } else {
            showNotification('ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + result.error, 'error');
        }
    } catch (error) {
        showNotification('ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
    }
}

// ì²´í¬ëœ ê°’ë“¤ ê°€ì ¸ì˜¤ê¸°
function getCheckedValues(prefix, count) {
    const values = [];
    for (let i = 1; i <= count; i++) {
        const checkbox = document.getElementById(`${prefix}${i}`);
        if (checkbox && checkbox.checked) {
            values.push(checkbox.value);
        }
    }
    return values;
}

// API í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
async function testApiConnection() {
    const button = event.target;
    const resultSpan = document.getElementById('apiTestResult');

    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> í…ŒìŠ¤íŠ¸ ì¤‘...';
    resultSpan.innerHTML = '';

    try {
        const response = await fetch('/api/test-api');
        const result = await response.json();

        if (result.success) {
            resultSpan.innerHTML = '<span class="text-success"><i class="fas fa-check"></i> API ì—°ê²° ì„±ê³µ</span>';
        } else {
            resultSpan.innerHTML = '<span class="text-danger"><i class="fas fa-times"></i> API ì—°ê²° ì‹¤íŒ¨: ' + result.error + '</span>';
        }
    } catch (error) {
        resultSpan.innerHTML = '<span class="text-danger"><i class="fas fa-times"></i> í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜: ' + error.message + '</span>';
    } finally {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-flask"></i> API ì—°ê²° í…ŒìŠ¤íŠ¸';
    }
}

async function testDiscordNotification() {
    const button = event.target;
    const resultSpan = document.getElementById('discordTestResult');

    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> í…ŒìŠ¤íŠ¸ ì¤‘...';
    resultSpan.innerHTML = '';

    try {
        const response = await fetch('/api/test-discord', {
            method: 'POST'
        });
        const result = await response.json();

        if (result.success) {
            resultSpan.innerHTML = '<span class="text-success"><i class="fas fa-check"></i> Discord ì•Œë¦¼ ì „ì†¡ ì„±ê³µ</span>';
        } else {
            resultSpan.innerHTML = '<span class="text-danger"><i class="fas fa-times"></i> Discord ì•Œë¦¼ ì‹¤íŒ¨: ' + result.error + '</span>';
        }
    } catch (error) {
        resultSpan.innerHTML = '<span class="text-danger"><i class="fas fa-times"></i> í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜: ' + error.message + '</span>';
    } finally {
        button.disabled = false;
        button.innerHTML = '<i class="fab fa-discord"></i> Discord ì•Œë¦¼ í…ŒìŠ¤íŠ¸';
    }
}

// ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
function resetToDefaults() {
    if (confirm('ëª¨ë“  ì„¤ì •ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        // ê¸°ë³¸ê°’ ì„¤ì •
        document.getElementById('clientId').value = '';
        document.getElementById('clientSecret').value = '';
        document.getElementById('discordWebhook').value = '';
        document.getElementById('discordEnabled').checked = true;
        document.getElementById('checkInterval').value = 300;
        document.getElementById('refreshInterval').value = 60;
        document.getElementById('autoRefresh').checked = true;
        document.getElementById('dashboardPeriod').value = 5;
        document.getElementById('quickPeriod').value = 3;

        // IP ê¸°ë³¸ê°’
        const select = document.getElementById('ipList');
        select.innerHTML = '';
        const defaultIPs = ['121.190.40.153', '175.125.204.97'];
        defaultIPs.forEach(ip => {
            const option = document.createElement('option');
            option.value = ip;
            option.textContent = ip;
            select.appendChild(option);
        });

        // íƒ­ë³„ ê¸°ê°„ ê¸°ë³¸ê°’
        document.getElementById('newOrderDays').value = 3;
        document.getElementById('shippingPendingDays').value = 3;
        document.getElementById('shippingInProgressDays').value = 30;
        document.getElementById('shippingCompletedDays').value = 7;
        document.getElementById('purchaseDecidedDays').value = 3;
        document.getElementById('cancelDays').value = 30;
        document.getElementById('returnExchangeDays').value = 15;
        document.getElementById('cancelReturnExchangeDays').value = 7;

        // ëª¨ë“  ì²´í¬ë°•ìŠ¤ ì²´í¬
        for (let i = 1; i <= 8; i++) {
            const checkbox = document.getElementById(`orderStatus${i}`);
            if (checkbox) checkbox.checked = true;
        }
        for (let i = 1; i <= 3; i++) {
            const checkbox = document.getElementById(`productStatus${i}`);
            if (checkbox) checkbox.checked = true;
        }
        for (let i = 1; i <= 10; i++) {
            const checkbox = document.getElementById(`orderCol${i}`);
            if (checkbox) checkbox.checked = true;
        }

        showNotification('ì„¤ì •ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    }
}

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const icon = event.target.querySelector('i');

    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function showNotification(message, type = 'info') {
    const alertClass = type === 'success' ? 'alert-success' :
                      type === 'error' ? 'alert-danger' :
                      type === 'warning' ? 'alert-warning' : 'alert-info';

    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    alert.style.top = '20px';
    alert.style.right = '20px';
    alert.style.zIndex = '9999';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alert);

    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 3000);
}

// ì‹œìŠ¤í…œ ìƒíƒœ ì—…ë°ì´íŠ¸
async function updateSystemStatus() {
    try {
        const response = await fetch('/api/monitoring/status');
        const status = await response.json();

        if (status.success) {
            const monitoringBadge = document.getElementById('monitoringStatus');
            const lastCheckSpan = document.getElementById('lastCheck');

            if (status.monitoring_active) {
                monitoringBadge.className = 'badge bg-success';
                monitoringBadge.textContent = 'í™œì„±í™”';
            } else {
                monitoringBadge.className = 'badge bg-warning';
                monitoringBadge.textContent = 'ë¹„í™œì„±í™”';
            }

            lastCheckSpan.textContent = status.last_check || 'ë¯¸í™•ì¸';
        }
    } catch (error) {
        console.error('ì‹œìŠ¤í…œ ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    }
}
</script>
{% endblock %}