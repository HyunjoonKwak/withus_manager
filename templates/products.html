{% extends "base.html" %}

{% block extra_head %}
<style>
    .product-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
    }
    .filter-card, .products-card {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .product-image {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 0.25rem;
    }
    .stock-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    .stock-low { background-color: #ffeaa7; color: #d63031; }
    .stock-medium { background-color: #81ecec; color: #00b894; }
    .stock-high { background-color: #a7f0ba; color: #00b894; }
    .stock-out { background-color: #fab1a0; color: #e17055; }
</style>
{% endblock %}

{% block content %}
<div class="product-header">
    <h2 class="h4 mb-2">
        <i class="fas fa-tags"></i> {{ title }}
    </h2>
    <p class="mb-0">ìƒí’ˆ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¬ê³  í˜„í™©ê³¼ íŒë§¤ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
</div>

<!-- ìƒí’ˆ í•„í„° -->
<div class="filter-card p-3 mb-3">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h6 class="mb-2">
                <i class="fas fa-filter"></i> íŒë§¤ ìƒíƒœ í•„í„°
                <span class="badge bg-primary ms-2" id="selectedStatusCount">0</span>
            </h6>
            <div class="d-flex flex-wrap gap-3">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="status_all" onchange="toggleAllStatus()">
                    <label class="form-check-label small" for="status_all">ì „ì²´ì„ íƒ</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input status-filter" type="checkbox" id="status_SALE" value="SALE" onchange="updateStatusFilter()">
                    <label class="form-check-label small" for="status_SALE">íŒë§¤ì¤‘</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input status-filter" type="checkbox" id="status_WAIT" value="WAIT" onchange="updateStatusFilter()">
                    <label class="form-check-label small" for="status_WAIT">ìŠ¹ì¸ëŒ€ê¸°</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input status-filter" type="checkbox" id="status_OUTOFSTOCK" value="OUTOFSTOCK" onchange="updateStatusFilter()">
                    <label class="form-check-label small" for="status_OUTOFSTOCK">í’ˆì ˆ</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input status-filter" type="checkbox" id="status_SUSPENSION" value="SUSPENSION" onchange="updateStatusFilter()">
                    <label class="form-check-label small" for="status_SUSPENSION">íŒë§¤ì¤‘ì§€</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input status-filter" type="checkbox" id="status_CLOSE" value="CLOSE" onchange="updateStatusFilter()">
                    <label class="form-check-label small" for="status_CLOSE">ì¢…ë£Œ</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input status-filter" type="checkbox" id="status_PROHIBITION" value="PROHIBITION" onchange="updateStatusFilter()">
                    <label class="form-check-label small" for="status_PROHIBITION">íŒë§¤ê¸ˆì§€</label>
                </div>
            </div>
        </div>
        <div class="col-md-4 text-end">
            <div class="d-flex gap-2 justify-content-end">
                <button type="button" class="btn btn-outline-info btn-sm" onclick="saveFilterSettings()">
                    <i class="fas fa-save"></i> ì €ì¥
                </button>
                <button type="button" class="btn btn-outline-warning btn-sm" onclick="loadFromSettings()" title="ì„¤ì •ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°">
                    <i class="fas fa-cog"></i> ì„¤ì •
                </button>
                <button type="button" class="btn btn-success btn-sm" onclick="refreshProducts()">
                    <i class="fas fa-sync"></i> ìƒˆë¡œê³ ì¹¨
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ìƒí’ˆ ëª©ë¡ -->
<div class="products-card">
    <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
        <h5 class="mb-0"><i class="fas fa-list"></i> ìƒí’ˆ ëª©ë¡</h5>
        <div>
            <span id="productCount" class="badge bg-primary fs-6 me-2">
                ì´ <span id="totalProductCount">0</span>ê±´
            </span>
            <button class="btn btn-success btn-sm me-2" onclick="showProductRegistration()">
                <i class="fas fa-plus"></i> ìƒí’ˆë“±ë¡
            </button>
            <button class="btn btn-outline-primary btn-sm" onclick="exportProducts()">
                <i class="fas fa-download"></i> ë‚´ë³´ë‚´ê¸°
            </button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="bg-light">
                <tr>
                    <th width="5%">ë³€ê²½</th>
                    <th width="5%">ì¡°íšŒ</th>
                    <th width="5%">ìƒì„¸</th>
                    <th width="4%">ì´ë¯¸ì§€</th>
                    <th width="18%">ìƒí’ˆëª…</th>
                    <th width="8%">ìƒí’ˆID</th>
                    <th width="8%">ì›ë˜íŒë§¤ê°€</th>
                    <th width="8%">ì…€ëŸ¬í• ì¸ê°€</th>
                    <th width="8%">ì‹¤ì œíŒë§¤ê°€</th>
                    <th width="6%">ì¬ê³ </th>
                    <th width="6%">ìƒíƒœ</th>
                    <th width="8%">ë“±ë¡ì¼</th>
                    <th width="6%">íŒë§¤ëŸ‰</th>
                    <th width="10%">ì›ìƒí’ˆID</th>
                </tr>
            </thead>
            <tbody id="productsTableBody">
                <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
            </tbody>
        </table>
    </div>

    <!-- ìƒí’ˆì´ ì—†ì„ ë•Œ -->
    <div id="noProductsMessage" class="text-center p-5 d-none">
        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</h5>
        <p class="text-muted">ìƒˆ ìƒí’ˆì„ ë“±ë¡í•˜ê±°ë‚˜ ë‹¤ë¥¸ ì¡°ê±´ìœ¼ë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</p>
    </div>
</div>

<!-- ìƒí’ˆ ìƒì„¸ ëª¨ë‹¬ -->
<div class="modal fade" id="productDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ìƒí’ˆ ìƒì„¸ ì •ë³´</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="productDetailContent">
                    <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary" onclick="editProduct()">ìˆ˜ì •</button>
            </div>
        </div>
    </div>
</div>

<!-- ìƒí’ˆ ë“±ë¡ ëª¨ë‹¬ -->
<div class="modal fade" id="productRegistrationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> ìƒˆ ìƒí’ˆ ë“±ë¡
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="productRegistrationForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productName" class="form-label">ìƒí’ˆëª… <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="productName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productBrand" class="form-label">ë¸Œëœë“œ</label>
                                <input type="text" class="form-control" id="productBrand" name="brand">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productPrice" class="form-label">ì›ë˜íŒë§¤ê°€ <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="productPrice" name="price" required min="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productDiscountedPrice" class="form-label">ì…€ëŸ¬í• ì¸ê°€</label>
                                <input type="number" class="form-control" id="productDiscountedPrice" name="discounted_price" min="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productStock" class="form-label">ì¬ê³ ìˆ˜ëŸ‰ <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="productStock" name="stock" required min="0">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productStatus" class="form-label">íŒë§¤ìƒíƒœ <span class="text-danger">*</span></label>
                                <select class="form-select" id="productStatus" name="status" required>
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                    <option value="SALE">íŒë§¤ì¤‘</option>
                                    <option value="WAIT">ìŠ¹ì¸ëŒ€ê¸°</option>
                                    <option value="OUTOFSTOCK">í’ˆì ˆ</option>
                                    <option value="SUSPENSION">íŒë§¤ì¤‘ì§€</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productImageUrl" class="form-label">ìƒí’ˆ ì´ë¯¸ì§€ URL</label>
                                <input type="url" class="form-control" id="productImageUrl" name="image_url">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="productDescription" class="form-label">ìƒí’ˆì„¤ëª…</label>
                        <textarea class="form-control" id="productDescription" name="description" rows="3"></textarea>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>ì°¸ê³ :</strong> ìƒí’ˆ ë“±ë¡ í›„ ë„¤ì´ë²„ ì‡¼í•‘ APIë¥¼ í†µí•´ ë™ê¸°í™”ë©ë‹ˆë‹¤.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> ë“±ë¡
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let products = [];
let filteredProducts = [];

// í˜ì´ì§€ ë¡œë“œì‹œ ìƒí’ˆ ë¡œë“œ ë° í•„í„° ì„¤ì • ë¡œë“œ
document.addEventListener('DOMContentLoaded', async function() {
    // ìƒí’ˆ ë°ì´í„° ë¡œë“œ í›„ í•„í„° ì„¤ì • ë¡œë“œ
    await loadProducts();
    await loadFilterSettings();
    // ì´ˆê¸° ìƒíƒœ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    updateStatusCount();
});

// ìƒí’ˆ ë¡œë“œ
async function loadProducts() {
    try {
        console.log('ìƒí’ˆ ë¡œë“œ ì‹œì‘...');
        showLoading(true);

        const response = await fetch('/api/products');
        console.log('API ì‘ë‹µ ìƒíƒœ:', response.status);
        const data = await response.json();
        console.log('API ì‘ë‹µ ë°ì´í„°:', data);

        if (data.success) {
            products = data.products;
            filteredProducts = [...products];
            console.log('ìƒí’ˆ ê°œìˆ˜:', products.length);
            console.log('ì²« ë²ˆì§¸ ìƒí’ˆ:', products[0]);
            renderProducts(filteredProducts);
            updateProductCount(filteredProducts.length);
        } else {
            throw new Error(data.error || 'ìƒí’ˆ ë¡œë“œ ì‹¤íŒ¨');
        }
    } catch (error) {
        console.error('ìƒí’ˆ ë¡œë“œ ì˜¤ë¥˜:', error);
        alert('ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// ë©€í‹°ì…€ë ‰ì…˜ í•„í„° ê´€ë ¨ í•¨ìˆ˜ë“¤
function getSelectedStatuses() {
    const checkboxes = document.querySelectorAll('.status-filter:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function updateStatusCount() {
    const count = getSelectedStatuses().length;
    document.getElementById('selectedStatusCount').textContent = count;
}

function updateStatusFilter() {
    updateStatusCount();
    // ìë™ í•„í„°ë§ ì ìš© (ì„ íƒì‚¬í•­)
    filterProducts();
}

function toggleAllStatus() {
    const allCheckbox = document.getElementById('status_all');
    const statusCheckboxes = document.querySelectorAll('.status-filter');

    statusCheckboxes.forEach(cb => {
        cb.checked = allCheckbox.checked;
    });

    updateStatusCount();
    filterProducts();
}

// ìƒí’ˆ í•„í„°ë§ (ë©€í‹°ì…€ë ‰ì…˜ ì§€ì›)
function filterProducts() {
    const selectedStatuses = getSelectedStatuses();

    filteredProducts = products.filter(product => {
        // ìƒíƒœ í•„í„° - ì•„ë¬´ê²ƒë„ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ëª¨ë“  ìƒí’ˆ í‘œì‹œ
        if (selectedStatuses.length > 0 && !selectedStatuses.includes(product.status)) {
            return false;
        }

        return true;
    });

    renderProducts(filteredProducts);
    updateProductCount(filteredProducts.length);
}

// í•„í„° ì„¤ì • ì €ì¥
async function saveFilterSettings() {
    const selectedStatuses = getSelectedStatuses();
    const filterSettings = {
        selectedStatuses: selectedStatuses
    };

    try {
        const response = await fetch('/api/products/filter-settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(filterSettings)
        });

        const data = await response.json();
        if (data.success) {
            // ì„±ê³µ ì•Œë¦¼
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-2';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle"></i> í•„í„° ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.filter-card').appendChild(alertDiv);

            // 3ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        } else {
            throw new Error(data.error || 'í•„í„° ì €ì¥ ì‹¤íŒ¨');
        }
    } catch (error) {
        console.error('í•„í„° ì €ì¥ ì˜¤ë¥˜:', error);
        alert('í•„í„° ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
}

// í•„í„° ì„¤ì • ë¡œë“œ
async function loadFilterSettings() {
    try {
        const response = await fetch('/api/products/filter-settings');
        const data = await response.json();

        if (data.success && data.settings) {
            const settings = data.settings;

            // ìƒíƒœ í•„í„° ë³µì›
            if (settings.selectedStatuses && settings.selectedStatuses.length > 0) {
                settings.selectedStatuses.forEach(status => {
                    const checkbox = document.getElementById(`status_${status}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
                updateStatusCount();
                filterProducts();
            }
        }
    } catch (error) {
        console.error('í•„í„° ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

// ì„¤ì • í˜ì´ì§€ì—ì„œ ìƒí’ˆì¡°íšŒì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
async function loadFromSettings() {
    try {
        // ì‚¬ìš©ìì—ê²Œ í™•ì¸
        if (!confirm('ì„¤ì • í˜ì´ì§€ì˜ ìƒí’ˆì¡°íšŒì„¤ì •ì„ í˜„ì¬ í•„í„°ì— ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ì„ íƒëœ í•„í„°ëŠ” ì´ˆê¸°í™”ë©ë‹ˆë‹¤.')) {
            return;
        }

        // ì„¤ì • APIì—ì„œ ìƒí’ˆ ìƒíƒœ ì¡°íšŒ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        const response = await fetch('/api/settings');
        const result = await response.json();

        if (result.success && result.data) {
            const productStatusTypes = result.data.product_status_types;

            if (productStatusTypes) {
                // ëª¨ë“  ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
                resetFilters();

                // ì„¤ì •ì—ì„œ ê°€ì ¸ì˜¨ ìƒíƒœë“¤ ì²´í¬
                const statusList = productStatusTypes.split(',').map(s => s.trim()).filter(s => s);
                statusList.forEach(status => {
                    const checkbox = document.getElementById(`status_${status}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });

                // í•„í„° ì—…ë°ì´íŠ¸
                updateStatusCount();
                filterProducts();

                // ìƒí’ˆ í•„í„° ì„¤ì •ë„ ë™ê¸°í™”
                await saveFilterSettings();

                alert(`ì„¤ì • í˜ì´ì§€ì—ì„œ ${statusList.length}ê°œì˜ ìƒí’ˆ ìƒíƒœë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤: ${statusList.join(', ')}`);
            } else {
                alert('ì„¤ì • í˜ì´ì§€ì— ìƒí’ˆì¡°íšŒì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.\nì„¤ì • > ì¡°ê±´ì„¤ì • > ìƒí’ˆ ìƒíƒœ ì¡°íšŒ ì„¤ì •ì„ ë¨¼ì € êµ¬ì„±í•´ì£¼ì„¸ìš”.');
            }
        } else {
            throw new Error(result.error || 'ì„¤ì • ì¡°íšŒ ì‹¤íŒ¨');
        }
    } catch (error) {
        console.error('ì„¤ì •ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
        alert('ì„¤ì •ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
}

// ë¬¸ìì—´ ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜ (JavaScript í…œí”Œë¦¿ ë¦¬í„°ëŸ´ìš©)
function escapeHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#x27;');
}

// JavaScript í•¨ìˆ˜ ì¸ììš© ì´ìŠ¤ì¼€ì´í”„ (ì‘ì€ë”°ì˜´í‘œ ì²˜ë¦¬)
function escapeJsString(str) {
    if (!str) return '';
    return String(str).replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r');
}

// ìƒí’ˆ í…Œì´ë¸” ë Œë”ë§
function renderProducts(productList) {
    console.log('renderProducts í˜¸ì¶œë¨, ìƒí’ˆ ê°œìˆ˜:', productList.length);
    const tbody = document.getElementById('productsTableBody');
    const noProductsMessage = document.getElementById('noProductsMessage');

    console.log('tbody ì—˜ë¦¬ë¨¼íŠ¸:', tbody);
    console.log('noProductsMessage ì—˜ë¦¬ë¨¼íŠ¸:', noProductsMessage);

    if (productList.length === 0) {
        console.log('ìƒí’ˆì´ ì—†ìœ¼ë¯€ë¡œ ë©”ì‹œì§€ í‘œì‹œ');
        tbody.innerHTML = '';
        noProductsMessage.classList.remove('d-none');
        return;
    }

    console.log('ìƒí’ˆ í…Œì´ë¸” ë Œë”ë§ ì‹œì‘...');
    noProductsMessage.classList.add('d-none');


    const tableHTML = productList.map((product, index) => {
        const productId = escapeJsString(product.origin_product_no || product.product_id);
        const productName = escapeJsString(product.name);

        return `
        <tr>
            <td class="text-center">
                <button class="btn btn-outline-warning btn-sm" onclick="openProductEdit('${productId}', '${productName}')" title="ìƒí’ˆ ìˆ˜ì •">
                    âš™ï¸ ë³€ê²½
                </button>
            </td>
            <td class="text-center">
                <button class="btn btn-outline-info btn-sm" onclick="openProductViewPopup('${productId}', '${productName}')" title="ìƒí’ˆ ì •ë³´ ì¡°íšŒ">
                    ğŸ” ì¡°íšŒ
                </button>
            </td>
            <td class="text-center">
                <button class="btn btn-outline-secondary btn-sm" onclick="openProductDetailPopup('${productId}', '${productName}')" title="ì›ë³¸ ë°ì´í„° ìƒì„¸ (ë””ë²„ê¹…ìš©)">
                    ğŸ“„ ìƒì„¸
                </button>
            </td>
            <td>
                <img src="${product.image_url || '/static/images/no-image.png'}"
                     alt="ìƒí’ˆì´ë¯¸ì§€" class="product-image"
                     onerror="this.src='/static/images/no-image.png'">
            </td>
            <td onclick="showProductDetail('${escapeJsString(product.product_id)}')" style="cursor: pointer;">
                <div class="text-truncate" style="max-width: 200px;" title="${escapeHtml(product.name)}">
                    <strong>${escapeHtml(product.name || '-')}</strong>
                </div>
                <small class="text-muted">${escapeHtml(product.brand || '')}</small>
            </td>
            <td>
                <small class="text-muted">${product.product_id || '-'}</small>
            </td>
            <td class="text-end">
                <strong>${formatPrice(product.sale_price)}</strong>
            </td>
            <td class="text-end">
                ${product.discounted_price && product.discounted_price > 0 && product.discounted_price < product.sale_price ?
                    `<small class="text-danger">${formatPrice(product.sale_price - product.discounted_price)}</small>` :
                    '<small class="text-muted">-</small>'
                }
            </td>
            <td class="text-end">
                ${product.discounted_price && product.discounted_price > 0 ?
                    `<strong class="text-primary">${formatPrice(product.discounted_price)}</strong>` :
                    '<small class="text-muted">-</small>'
                }
            </td>
            <td class="text-center">
                <span class="stock-badge ${getStockBadgeClass(product.stock)}">
                    ${product.stock || 0}
                </span>
            </td>
            <td>
                <span class="badge ${getStatusBadgeClass(product.status)}">
                    ${getStatusText(product.status)}
                </span>
            </td>
            <td>
                <small>${formatDate(product.created_at)}</small>
            </td>
            <td class="text-center">
                ${product.sales_count || 0}ê±´
            </td>
            <td>
                <small class="text-muted">${product.origin_product_no || '-'}</small>
            </td>
        </tr>
        `;
    }).join('');

    console.log('í…Œì´ë¸” HTML ê¸¸ì´:', tableHTML.length);
    console.log('í…Œì´ë¸” HTML ë¯¸ë¦¬ë³´ê¸°:', tableHTML.substring(0, 200) + '...');

    tbody.innerHTML = tableHTML;
    console.log('í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì™„ë£Œ');
}

// í•„í„° ì´ˆê¸°í™”
function resetFilters() {
    // ëª¨ë“  ì²´í¬ë°•ìŠ¤ í•´ì œ
    document.getElementById('status_all').checked = false;
    const statusCheckboxes = document.querySelectorAll('.status-filter');
    statusCheckboxes.forEach(cb => {
        cb.checked = false;
    });

    // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    updateStatusCount();

    // ëª¨ë“  ìƒí’ˆ í‘œì‹œ
    filteredProducts = [...products];
    renderProducts(filteredProducts);
    updateProductCount(filteredProducts.length);
}

// ìƒí’ˆ ìƒˆë¡œê³ ì¹¨ (ë„¤ì´ë²„ APIì—ì„œ ê°€ì ¸ì˜¤ê¸°)
async function refreshProducts() {
    try {
        console.log('ë„¤ì´ë²„ APIì—ì„œ ìƒí’ˆ ìƒˆë¡œê³ ì¹¨ ì‹œì‘...');
        showLoading(true);

        // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        const refreshBtn = document.querySelector('button[onclick="refreshProducts()"]');
        if (refreshBtn) {
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> API ìƒˆë¡œê³ ì¹¨ ì¤‘...';
            refreshBtn.disabled = true;
        }

        const response = await fetch('/api/products/refresh', {
            method: 'POST'
        });
        console.log('API ìƒˆë¡œê³ ì¹¨ ì‘ë‹µ ìƒíƒœ:', response.status);
        const data = await response.json();
        console.log('API ìƒˆë¡œê³ ì¹¨ ì‘ë‹µ ë°ì´í„°:', data);

        if (data.success) {
            products = data.products;
            console.log('ë„¤ì´ë²„ APIì—ì„œ ìƒˆë¡œê³ ì¹¨:', products.length, 'ê°œ ìƒí’ˆ');

            // í˜„ì¬ ì„ íƒëœ í•„í„° ìœ ì§€í•˜ì—¬ ë‹¤ì‹œ ì ìš©
            filterProducts();

            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            if (data.message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.container').prepend(alertDiv);

                // 3ì´ˆ í›„ ìë™ ì œê±°
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 3000);
            }
        } else {
            throw new Error(data.error || 'ìƒí’ˆ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨');
        }

        // ë²„íŠ¼ ì›ìƒë³µêµ¬
        if (refreshBtn) {
            refreshBtn.innerHTML = '<i class="fas fa-sync"></i> ìƒˆë¡œê³ ì¹¨';
            refreshBtn.disabled = false;
        }

    } catch (error) {
        console.error('ìƒí’ˆ ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', error);
        alert('ìƒí’ˆì„ ìƒˆë¡œê³ ì¹¨í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);

        // ì‹¤íŒ¨ ì‹œ ë²„íŠ¼ ì›ìƒë³µêµ¬
        const refreshBtn = document.querySelector('button[onclick="refreshProducts()"]');
        if (refreshBtn) {
            refreshBtn.innerHTML = '<i class="fas fa-sync"></i> ìƒˆë¡œê³ ì¹¨';
            refreshBtn.disabled = false;
        }
    } finally {
        showLoading(false);
    }
}

// ìƒí’ˆ ë‚´ë³´ë‚´ê¸°
function exportProducts() {
    alert('ìƒí’ˆ ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì´ ê³§ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.');
}

// ìƒí’ˆ ìƒì„¸ ë³´ê¸°
function showProductDetail(productId) {
    const product = products.find(p => p.product_id === productId);
    if (!product) return;

    const content = `
        <div class="row">
            <div class="col-md-4">
                <img src="${product.image_url || '/static/images/no-image.png'}"
                     class="img-fluid rounded" alt="ìƒí’ˆì´ë¯¸ì§€"
                     onerror="this.src='/static/images/no-image.png'">
            </div>
            <div class="col-md-8">
                <h5>${product.name}</h5>
                <p class="text-muted mb-2">ìƒí’ˆID: ${product.product_id}</p>

                <table class="table table-sm">
                    <tr>
                        <th>ì›ë˜íŒë§¤ê°€</th>
                        <td><span class="text-muted">${formatPrice(product.sale_price)}</span></td>
                    </tr>
                    <tr>
                        <th>ì…€ëŸ¬í• ì¸ê°€</th>
                        <td><span class="text-danger">${formatPrice((product.sale_price || 0) - (product.discounted_price || 0))}</span></td>
                    </tr>
                    <tr>
                        <th>ì‹¤ì œíŒë§¤ê°€</th>
                        <td><strong class="text-primary">${formatPrice(product.discounted_price)}</strong></td>
                    </tr>
                    <tr>
                        <th>í˜„ì¬ì¬ê³ </th>
                        <td>
                            <span class="stock-badge ${getStockBadgeClass(product.stock)}">
                                ${product.stock || 0}ê°œ
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>íŒë§¤ìƒíƒœ</th>
                        <td>
                            <span class="badge ${getStatusBadgeClass(product.status)}">
                                ${getStatusText(product.status)}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>ë“±ë¡ì¼</th>
                        <td>${formatDate(product.created_at)}</td>
                    </tr>
                    <tr>
                        <th>ì´ íŒë§¤ëŸ‰</th>
                        <td>${product.sales_count || 0}ê±´</td>
                    </tr>
                </table>

                ${product.description ? `
                <div class="mt-3">
                    <h6>ìƒí’ˆì„¤ëª…</h6>
                    <p class="text-muted">${product.description}</p>
                </div>
                ` : ''}
            </div>
        </div>
    `;

    document.getElementById('productDetailContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('productDetailModal')).show();
}

// ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ìƒí’ˆ ìˆ˜ì • í˜ì´ì§€ ì—´ê¸° (ì›ìƒí’ˆID ì‚¬ìš©)
function openProductEdit(originProductId, productName = "") {
    try {
        console.log('ìƒí’ˆ ìˆ˜ì • í˜ì´ì§€ ì—´ê¸°:', originProductId, productName);

        if (!originProductId || originProductId === 'undefined' || originProductId === '-') {
            alert('ì›ìƒí’ˆIDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒí’ˆ ìˆ˜ì • í˜ì´ì§€ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ìƒí’ˆ ìˆ˜ì • URL (ì›ìƒí’ˆID í¬í•¨)
        const url = `https://sell.smartstore.naver.com/#/products/edit/${originProductId}`;
        window.open(url, '_blank');

        console.log('ìƒí’ˆ ìˆ˜ì • í˜ì´ì§€ ì—´ê¸° ì™„ë£Œ:', originProductId, productName);

        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
        showStatusMessage(`ìƒí’ˆ ìˆ˜ì • í˜ì´ì§€ë¥¼ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ì—ˆìŠµë‹ˆë‹¤: ${productName}`, 'success');

    } catch (error) {
        console.error('ìƒí’ˆ ìˆ˜ì • í˜ì´ì§€ ì—´ê¸° ì˜¤ë¥˜:', error);
        alert('ìƒí’ˆ ìˆ˜ì • í˜ì´ì§€ë¥¼ ì—¬ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
}

// ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ìƒí’ˆ ì¡°íšŒ í˜ì´ì§€ ì—´ê¸° (ìƒí’ˆID ì‚¬ìš©)
function openProductView(productId, productName = "") {
    try {
        console.log('ìƒí’ˆ ì¡°íšŒ í˜ì´ì§€ ì—´ê¸°:', productId, productName);

        if (!productId || productId === 'undefined' || productId === '-') {
            alert('ìƒí’ˆIDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒí’ˆ ì¡°íšŒ í˜ì´ì§€ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ìƒí’ˆ ì¡°íšŒ URL (ìƒí’ˆID í¬í•¨)
        const url = `https://smartstore.naver.com/us-shop/products/${productId}`;
        window.open(url, '_blank');

        console.log('ìƒí’ˆ ì¡°íšŒ í˜ì´ì§€ ì—´ê¸° ì™„ë£Œ:', productId, productName);

        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
        showStatusMessage(`ìƒí’ˆ ì¡°íšŒ í˜ì´ì§€ë¥¼ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ì—ˆìŠµë‹ˆë‹¤: ${productName}`, 'info');

    } catch (error) {
        console.error('ìƒí’ˆ ì¡°íšŒ í˜ì´ì§€ ì—´ê¸° ì˜¤ë¥˜:', error);
        alert('ìƒí’ˆ ì¡°íšŒ í˜ì´ì§€ë¥¼ ì—¬ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
}

// ìƒí’ˆ ì •ë³´ë¥¼ ê°€ë…ì„± ì¢‹ì€ í˜•íƒœë¡œ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜
async function openProductViewPopup(originProductId, productName = "") {
    try {
        console.log('ìƒí’ˆ ì •ë³´ ì¡°íšŒ:', originProductId, productName);

        if (!originProductId || originProductId === 'undefined' || originProductId === '-') {
            alert('ì›ìƒí’ˆIDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒí’ˆ ì •ë³´ë¥¼ ì¡°íšŒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ë¡œë”© í‘œì‹œ
        showStatusMessage('ìƒí’ˆ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');

        // ì„œë²„ì—ì„œ ë„¤ì´ë²„ API ì‘ë‹µ ì¡°íšŒ
        const response = await fetch(`/api/products/${originProductId}/detail`);
        const result = await response.json();

        if (result.success) {
            const data = result.data;

            // ë””ë²„ê¹…: ì „ì²´ ë°ì´í„° êµ¬ì¡° í™•ì¸
            console.log('ì „ì²´ API ì‘ë‹µ ë°ì´í„°:', data);
            console.log('data íƒ€ì…:', typeof data);
            console.log('data í‚¤ë“¤:', Object.keys(data));
            console.log('originProduct ì¡´ì¬ ì—¬ë¶€:', !!data.originProduct);

            // ë‹¤ì–‘í•œ ê°€ëŠ¥í•œ ê²½ë¡œ í™•ì¸
            console.log('data.data í™•ì¸:', data.data);
            console.log('data.data?.originProduct í™•ì¸:', data.data?.originProduct);
            console.log('detailAttribute ì¡´ì¬ ì—¬ë¶€:', !!data.originProduct?.detailAttribute);
            console.log('optionInfo ì¡´ì¬ ì—¬ë¶€:', !!data.originProduct?.detailAttribute?.optionInfo);

            // optionInfo ê²½ë¡œ í™•ì¸ - ì—¬ëŸ¬ ê°€ëŠ¥í•œ ê²½ë¡œ ì‹œë„
            let optionInfo = data.originProduct?.detailAttribute?.optionInfo;

            // ì²« ë²ˆì§¸ ê²½ë¡œê°€ ì‹¤íŒ¨í•˜ë©´ data.data ê²½ë¡œ ì‹œë„
            if (!optionInfo) {
                optionInfo = data.data?.originProduct?.detailAttribute?.optionInfo;
                console.log('ë‘ ë²ˆì§¸ ê²½ë¡œ ì‹œë„: data.data.originProduct.detailAttribute.optionInfo');
            }
            console.log('ì¶”ì¶œëœ optionInfo:', optionInfo);

            if (!optionInfo) {
                console.log('optionInfoê°€ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„° êµ¬ì¡°ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                showStatusMessage('ì´ ìƒí’ˆì—ëŠ” ì˜µì…˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.', 'info');
                return;
            }

            // ê¸°ë³¸ ìƒí’ˆ ì •ë³´ì™€ optionInfoë§Œ í‘œì‹œ
            const basicInfo = `
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
                    <h6 style="margin: 0 0 10px 0; color: #495057;">ğŸ“¦ ê¸°ë³¸ ì •ë³´</h6>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div><strong>ìƒí’ˆëª…:</strong> ${productName}</div>
                        <div><strong>ì›ìƒí’ˆID:</strong> ${originProductId}</div>
                    </div>
                </div>
            `;

            const optionInfoHtml = generateOptionInfoSection(optionInfo);

            // íŒì—… ì°½ HTML ìƒì„±
            const popupHtml = `
                <div style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.5); z-index: 10000;
                    display: flex; align-items: center; justify-content: center;
                " onclick="closeProductViewPopup()">
                    <div style="
                        background: white; width: 90%; max-width: 900px; max-height: 90%;
                        border-radius: 8px; padding: 20px; overflow: auto;
                        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                    " onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h5 style="margin: 0; color: #333;">ğŸ›ï¸ ìƒí’ˆ ì˜µì…˜ ì •ë³´</h5>
                            <button onclick="closeProductViewPopup()" style="
                                background: #dc3545; color: white; border: none;
                                border-radius: 4px; padding: 8px 12px; cursor: pointer;
                            ">âœ• ë‹«ê¸°</button>
                        </div>
                        ${basicInfo}
                        ${optionInfoHtml}
                        <div style="margin-top: 15px; text-align: center;">
                            <button onclick="closeProductViewPopup()" style="
                                background: #6c757d; color: white; border: none;
                                border-radius: 4px; padding: 8px 16px; cursor: pointer;
                            ">ë‹«ê¸°</button>
                        </div>
                    </div>
                </div>
            `;

            // íŒì—…ì„ bodyì— ì¶”ê°€
            const popupDiv = document.createElement('div');
            popupDiv.id = 'productViewPopup';
            popupDiv.innerHTML = popupHtml;
            document.body.appendChild(popupDiv);

            showStatusMessage('ìƒí’ˆ ì •ë³´ ì¡°íšŒ ì™„ë£Œ', 'success');

        } else {
            throw new Error(result.error || 'ìƒí’ˆ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');
        }

    } catch (error) {
        console.error('ìƒí’ˆ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
        showStatusMessage(`ìƒí’ˆ ì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
    }
}

// ì˜µì…˜ ì •ë³´ë¥¼ íŒŒì‹±í•´ì„œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
function generateOptionInfoSection(optionInfo) {
    console.log('generateOptionInfoSection í˜¸ì¶œë¨, optionInfo:', optionInfo);

    if (!optionInfo) {
        console.error('optionInfoê°€ null ë˜ëŠ” undefinedì…ë‹ˆë‹¤.');
        return '<div>ì˜µì…˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
    const formatCurrency = (value) => {
        if (!value || value === 0) return 'ê¸°ë³¸ê°€';
        return (value > 0 ? '+' : '') + Number(value).toLocaleString() + 'ì›';
    };

    const getStockBadge = (stock) => {
        if (stock === 0) return '<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">í’ˆì ˆ</span>';
        if (stock < 10) return '<span style="background: #ffc107; color: black; padding: 2px 6px; border-radius: 3px; font-size: 11px;">ì¬ê³ ë¶€ì¡±</span>';
        return '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">ì¬ê³ ìˆìŒ</span>';
    };

    const getUsableBadge = (usable) => {
        return usable
            ? '<span style="background: #17a2b8; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">ì‚¬ìš©ê°€ëŠ¥</span>'
            : '<span style="background: #6c757d; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">ì‚¬ìš©ë¶ˆê°€</span>';
    };

    let html = `
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
            <h6 style="margin: 0 0 15px 0; color: #856404;">ğŸ›ï¸ ìƒí’ˆ ì˜µì…˜ ì •ë³´</h6>
    `;

    // ì˜µì…˜ ê·¸ë£¹ ì´ë¦„ í‘œì‹œ
    if (optionInfo.optionCombinationGroupNames) {
        html += `
            <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #ddd; margin-bottom: 10px;">
                <h6 style="margin: 0 0 5px 0; color: #495057;">ğŸ“‚ ì˜µì…˜ ê·¸ë£¹</h6>
        `;
        Object.entries(optionInfo.optionCombinationGroupNames).forEach(([key, value]) => {
            html += `<div><strong>${key}:</strong> ${value}</div>`;
        });
        html += `</div>`;
    }

    // ì˜µì…˜ ì¡°í•© í‘œì‹œ
    if (optionInfo.optionCombinations && optionInfo.optionCombinations.length > 0) {
        html += `
            <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #ddd; margin-bottom: 10px;">
                <h6 style="margin: 0 0 10px 0; color: #495057;">ğŸ›ï¸ ì˜µì…˜ ëª©ë¡ (ì´ ${optionInfo.optionCombinations.length}ê°œ)</h6>
                <div style="display: grid; gap: 8px;">
        `;

        optionInfo.optionCombinations.forEach((option, index) => {
            html += `
                <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #e9ecef;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 5px;">
                        <strong style="color: #495057;">${option.optionName1 || `ì˜µì…˜ ${index + 1}`}</strong>
                        <div>
                            ${getStockBadge(option.stockQuantity)}
                            ${getUsableBadge(option.usable)}
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; font-size: 12px; color: #6c757d;">
                        <div><strong>ì˜µì…˜ID:</strong> ${option.id}</div>
                        <div><strong>ì¬ê³ :</strong> ${option.stockQuantity.toLocaleString()}ê°œ</div>
                        <div><strong>ì¶”ê°€ê¸ˆì•¡:</strong> ${formatCurrency(option.price)}</div>
                        <div><strong>ê´€ë¦¬ì½”ë“œ:</strong> ${option.sellerManagerCode || '-'}</div>
                    </div>
                </div>
            `;
        });

        html += `
                </div>
            </div>
        `;
    }

    // ì˜µì…˜ ì„¤ì • ì •ë³´
    html += `
        <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
            <h6 style="margin: 0 0 10px 0; color: #495057;">âš™ï¸ ì˜µì…˜ ì„¤ì •</h6>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;">
                <div><strong>ë‹¨ìˆœì˜µì…˜ ì •ë ¬:</strong> ${optionInfo.simpleOptionSortType || '-'}</div>
                <div><strong>ì¡°í•©ì˜µì…˜ ì •ë ¬:</strong> ${optionInfo.optionCombinationSortType || '-'}</div>
                <div><strong>ë‹¨ìˆœì˜µì…˜ ìˆ˜:</strong> ${optionInfo.optionSimple ? optionInfo.optionSimple.length : 0}ê°œ</div>
                <div><strong>ì»¤ìŠ¤í…€ì˜µì…˜ ìˆ˜:</strong> ${optionInfo.optionCustom ? optionInfo.optionCustom.length : 0}ê°œ</div>
            </div>
        </div>
    `;

    html += `</div>`;
    return html;
}

// ìƒí’ˆ ì •ë³´ë¥¼ í‘œ í˜•íƒœë¡œ êµ¬ì„±í•˜ëŠ” í•¨ìˆ˜
function generateProductInfoTable(data, productName, originProductId) {
    const formatValue = (value) => {
        if (value === null || value === undefined || value === '') return '-';
        if (typeof value === 'object') return `<pre style="margin: 0; white-space: pre-wrap; font-size: 11px;">${JSON.stringify(value, null, 2)}</pre>`;
        if (typeof value === 'number' && value >= 1000) return value.toLocaleString();
        if (typeof value === 'boolean') return value ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤';
        return String(value);
    };

    const formatCurrency = (value) => {
        if (!value || value === 0) return '-';
        return Number(value).toLocaleString() + 'ì›';
    };

    const getStatusBadge = (status) => {
        const statusMap = {
            'SALE': { color: '#28a745', text: 'íŒë§¤ì¤‘' },
            'WAIT': { color: '#ffc107', text: 'ìŠ¹ì¸ëŒ€ê¸°' },
            'OUTOFSTOCK': { color: '#dc3545', text: 'í’ˆì ˆ' },
            'SUSPENSION': { color: '#6c757d', text: 'íŒë§¤ì¤‘ì§€' }
        };
        const info = statusMap[status] || { color: '#6c757d', text: status || '-' };
        return `<span style="background: ${info.color}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${info.text}</span>`;
    };

    // ì´ë¯¸ì§€ ê´€ë ¨ í•„ë“œë“¤ì„ ì œì™¸í•  ëª©ë¡
    const imageFields = [
        'representativeImage', 'productImages', 'detailImages', 'additionalImages',
        'imageUrl', 'thumbnailUrl', 'mainImage', 'subImages'
    ];

    // ì£¼ìš” í•„ë“œë“¤ì„ ë¨¼ì € í‘œì‹œí•˜ê³ , ë‚˜ë¨¸ì§€ëŠ” ì¶”ê°€ ì •ë³´ë¡œ í‘œì‹œ
    const mainFields = [
        'channelProductNo', 'statusType', 'salePrice', 'stockPrice', 'supplyPrice',
        'discountedPrice', 'stockQuantity', 'wholeCategoryName', 'brandName',
        'manufacturerName', 'regDate', 'editDate', 'saleStartDate', 'saleEndDate'
    ];

    const additionalFields = Object.keys(data).filter(key =>
        !mainFields.includes(key) && !imageFields.includes(key) && key !== 'optionInfo'
    );

    return `
        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
            <h6 style="margin: 0 0 10px 0; color: #495057;">ğŸ“¦ ê¸°ë³¸ ì •ë³´</h6>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div><strong>ìƒí’ˆëª…:</strong> ${productName}</div>
                <div><strong>ì›ìƒí’ˆID:</strong> ${originProductId}</div>
                <div><strong>ì±„ë„ìƒí’ˆID:</strong> ${formatValue(data.channelProductNo)}</div>
                <div><strong>ìƒí’ˆìƒíƒœ:</strong> ${data.statusType ? getStatusBadge(data.statusType) : '-'}</div>
            </div>
        </div>

        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
            <h6 style="margin: 0 0 10px 0; color: #495057;">ğŸ’° ê°€ê²© ì •ë³´</h6>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div><strong>íŒë§¤ê°€:</strong> ${formatCurrency(data.salePrice)}</div>
                <div><strong>ì •ê°€:</strong> ${formatCurrency(data.stockPrice)}</div>
                <div><strong>ê³µê¸‰ê°€:</strong> ${formatCurrency(data.supplyPrice)}</div>
                <div><strong>í• ì¸ê°€:</strong> ${formatCurrency(data.discountedPrice)}</div>
            </div>
        </div>

        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
            <h6 style="margin: 0 0 10px 0; color: #495057;">ğŸ“¦ ì¬ê³  ë° ì¹´í…Œê³ ë¦¬</h6>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div><strong>ì¬ê³ ìˆ˜ëŸ‰:</strong> ${formatValue(data.stockQuantity)}</div>
                <div><strong>ì¹´í…Œê³ ë¦¬:</strong> ${formatValue(data.wholeCategoryName)}</div>
                <div><strong>ë¸Œëœë“œ:</strong> ${formatValue(data.brandName)}</div>
                <div><strong>ì œì¡°ì—…ì²´:</strong> ${formatValue(data.manufacturerName)}</div>
            </div>
        </div>

        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
            <h6 style="margin: 0 0 10px 0; color: #495057;">ğŸ“… ë‚ ì§œ ì •ë³´</h6>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div><strong>ë“±ë¡ì¼:</strong> ${formatValue(data.regDate)}</div>
                <div><strong>ìˆ˜ì •ì¼:</strong> ${formatValue(data.editDate)}</div>
                <div><strong>ìŠ¹ì¸ì¼:</strong> ${formatValue(data.saleStartDate)}</div>
                <div><strong>íŒë§¤ì¢…ë£Œì¼:</strong> ${formatValue(data.saleEndDate)}</div>
            </div>
        </div>

        ${data.optionInfo ? generateOptionInfoSection(data.optionInfo) : ''}

        ${additionalFields.length > 0 ? `
        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
            <h6 style="margin: 0 0 10px 0; color: #495057;">ğŸ”§ ì¶”ê°€ ì •ë³´ (${additionalFields.length}ê°œ í•„ë“œ)</h6>
            <div style="max-height: 400px; overflow: auto;">
                ${additionalFields.map(key => {
                    const value = data[key];
                    if (value === null || value === undefined || value === '') return '';
                    return `
                        <div style="background: white; margin-bottom: 8px; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                            <strong style="color: #495057;">${key}:</strong><br>
                            <div style="margin-top: 4px; color: #6c757d;">
                                ${formatValue(value)}
                            </div>
                        </div>
                    `;
                }).filter(item => item !== '').join('')}
            </div>
        </div>
        ` : ''}

        <div style="background: #e9ecef; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px;">
            <h6 style="margin: 0 0 10px 0; color: #495057;">ğŸ“Š ë°ì´í„° ìš”ì•½</h6>
            <div style="font-size: 12px; color: #6c757d;">
                â€¢ ì „ì²´ í•„ë“œ ìˆ˜: ${Object.keys(data).length}ê°œ<br>
                â€¢ í‘œì‹œëœ í•„ë“œ ìˆ˜: ${mainFields.filter(f => data[f] !== undefined).length + additionalFields.length}ê°œ<br>
                â€¢ ì´ë¯¸ì§€ í•„ë“œ ì œì™¸: ${imageFields.filter(f => data[f] !== undefined).length}ê°œ<br>
                â€¢ optionInfo í¬í•¨ ì—¬ë¶€: ${data.optionInfo ? 'âœ… í¬í•¨' : 'âŒ ì—†ìŒ'}
            </div>
        </div>
    `;
}

// íŒì—… ë‹«ê¸° í•¨ìˆ˜ (ì¡°íšŒìš©)
function closeProductViewPopup() {
    const popup = document.getElementById('productViewPopup');
    if (popup) {
        popup.remove();
    }
}

// ë„¤ì´ë²„ API ì›ë³¸ ì‘ë‹µì„ íŒì—…ìœ¼ë¡œ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜ (ë””ë²„ê¹…ìš©)
async function openProductDetailPopup(originProductId, productName = "") {
    try {
        console.log('ìƒí’ˆ ìƒì„¸ ì •ë³´ ì¡°íšŒ:', originProductId, productName);

        if (!originProductId || originProductId === 'undefined' || originProductId === '-') {
            alert('ì›ìƒí’ˆIDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒí’ˆ ì •ë³´ë¥¼ ì¡°íšŒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ë¡œë”© í‘œì‹œ
        showStatusMessage('ìƒí’ˆ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');

        // ì„œë²„ì—ì„œ ë„¤ì´ë²„ API ì‘ë‹µ ì¡°íšŒ
        const response = await fetch(`/api/products/${originProductId}/detail`);
        const result = await response.json();

        if (result.success) {
            // ì‘ë‹µ ë°ì´í„°ë¥¼ ì˜ˆì˜ê²Œ í¬ë§·íŒ…
            const formattedData = JSON.stringify(result.data, null, 2);

            // íŒì—… ì°½ HTML ìƒì„±
            const popupHtml = `
                <div style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.5); z-index: 10000;
                    display: flex; align-items: center; justify-content: center;
                " onclick="closeProductDetailPopup()">
                    <div style="
                        background: white; width: 90%; max-width: 800px; max-height: 90%;
                        border-radius: 8px; padding: 20px; overflow: auto;
                        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                    " onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h5 style="margin: 0; color: #333;">ğŸ” ìƒí’ˆ ìƒì„¸ ì •ë³´ (ì›ë³¸ API ì‘ë‹µ)</h5>
                            <button onclick="closeProductDetailPopup()" style="
                                background: #dc3545; color: white; border: none;
                                border-radius: 4px; padding: 8px 12px; cursor: pointer;
                            ">âœ• ë‹«ê¸°</button>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>ìƒí’ˆëª…:</strong> ${productName}<br>
                            <strong>ì›ìƒí’ˆID:</strong> ${originProductId}
                        </div>
                        <div style="
                            background: #f8f9fa; border: 1px solid #dee2e6;
                            border-radius: 4px; padding: 15px;
                            font-family: 'Courier New', monospace;
                            white-space: pre-wrap; font-size: 12px;
                            max-height: 500px; overflow: auto;
                        ">${formattedData}</div>
                        <div style="margin-top: 15px; text-align: center;">
                            <button onclick="copyToClipboard('${formattedData.replace(/'/g, "\\'")}'); showStatusMessage('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');" style="
                                background: #28a745; color: white; border: none;
                                border-radius: 4px; padding: 8px 16px; cursor: pointer; margin-right: 10px;
                            ">ğŸ“‹ ë³µì‚¬</button>
                            <button onclick="closeProductDetailPopup()" style="
                                background: #6c757d; color: white; border: none;
                                border-radius: 4px; padding: 8px 16px; cursor: pointer;
                            ">ë‹«ê¸°</button>
                        </div>
                    </div>
                </div>
            `;

            // íŒì—…ì„ bodyì— ì¶”ê°€
            const popupDiv = document.createElement('div');
            popupDiv.id = 'productDetailPopup';
            popupDiv.innerHTML = popupHtml;
            document.body.appendChild(popupDiv);

            showStatusMessage('ìƒí’ˆ ì •ë³´ ì¡°íšŒ ì™„ë£Œ', 'success');

        } else {
            throw new Error(result.error || 'ìƒí’ˆ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');
        }

    } catch (error) {
        console.error('ìƒí’ˆ ìƒì„¸ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
        showStatusMessage(`ìƒí’ˆ ì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
    }
}

// íŒì—… ë‹«ê¸° í•¨ìˆ˜
function closeProductDetailPopup() {
    const popup = document.getElementById('productDetailPopup');
    if (popup) {
        popup.remove();
    }
}

// í´ë¦½ë³´ë“œ ë³µì‚¬ í•¨ìˆ˜
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).catch(err => {
        console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
        // í´ë°±: í…ìŠ¤íŠ¸ ì˜ì—­ ìƒì„±í•´ì„œ ë³µì‚¬
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
    });
}

// ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
function showStatusMessage(message, type = 'info') {
    const alertClass = type === 'success' ? 'alert-success' :
                      type === 'error' ? 'alert-danger' : 'alert-info';

    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${alertClass} alert-dismissible fade show mt-3`;
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // ì²« ë²ˆì§¸ ì¹´ë“œ ìœ„ì— ì‚½ì…
    const firstCard = document.querySelector('.product-header');
    if (firstCard && firstCard.parentNode) {
        firstCard.parentNode.insertBefore(alertDiv, firstCard.nextSibling);
    } else {
        document.querySelector('.container').prepend(alertDiv);
    }

    // 5ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// ê¸°ì¡´ ìƒí’ˆ ìˆ˜ì • í•¨ìˆ˜ (í˜¸í™˜ì„± ìœ ì§€)
function editProduct(productId) {
    const product = products.find(p => p.product_id === productId);
    if (product) {
        openProductEdit(product.origin_product_no || productId, product.name);
    } else {
        alert('ìƒí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
}

// ìƒí’ˆ ìƒíƒœ ë³€ê²½
function toggleProductStatus(productId) {
    alert('ìƒí’ˆ ìƒíƒœ ë³€ê²½ ê¸°ëŠ¥ì´ ê³§ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.');
}

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function getCategoryText(category) {
    const categoryMap = {
        'fashion': 'íŒ¨ì…˜',
        'beauty': 'ë·°í‹°',
        'home': 'í™ˆ/ë¦¬ë¹™',
        'food': 'ì‹í’ˆ',
        'digital': 'ë””ì§€í„¸'
    };
    return categoryMap[category] || category || '-';
}

function getStockBadgeClass(stock) {
    const stockNum = stock || 0;
    if (stockNum === 0) return 'stock-out';
    if (stockNum < 50) return 'stock-low';
    if (stockNum < 100) return 'stock-medium';
    return 'stock-high';
}

function getStatusBadgeClass(status) {
    switch(status) {
        case 'SALE': return 'bg-success';
        case 'WAIT': return 'bg-warning';
        case 'OUTOFSTOCK': return 'bg-danger';
        case 'SUSPENSION': return 'bg-secondary';
        case 'CLOSE': return 'bg-dark';
        case 'PROHIBITION': return 'bg-danger';
        default: return 'bg-light text-dark';
    }
}

function getStatusText(status) {
    switch(status) {
        case 'SALE': return 'íŒë§¤ì¤‘';
        case 'WAIT': return 'ìŠ¹ì¸ëŒ€ê¸°';
        case 'OUTOFSTOCK': return 'í’ˆì ˆ';
        case 'SUSPENSION': return 'íŒë§¤ì¤‘ì§€';
        case 'CLOSE': return 'ì¢…ë£Œ';
        case 'PROHIBITION': return 'íŒë§¤ê¸ˆì§€';
        default: return status || '-';
    }
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('ko-KR');
}

function formatPrice(price) {
    if (!price) return '-';
    return new Intl.NumberFormat('ko-KR').format(price) + 'ì›';
}

function updateProductCount(count) {
    document.getElementById('totalProductCount').textContent = count;
}

function showLoading(show) {
    // ë¡œë”© í‘œì‹œ (ê°„ë‹¨í•œ êµ¬í˜„)
    if (show) {
        document.body.style.cursor = 'wait';
    } else {
        document.body.style.cursor = 'default';
    }
}

// ìƒí’ˆ ë“±ë¡ ëª¨ë‹¬ í‘œì‹œ
function showProductRegistration() {
    // í¼ ì´ˆê¸°í™”
    document.getElementById('productRegistrationForm').reset();

    // ëª¨ë‹¬ í‘œì‹œ
    const modal = new bootstrap.Modal(document.getElementById('productRegistrationModal'));
    modal.show();
}

// ìƒí’ˆ ë“±ë¡ í¼ ì œì¶œ ì²˜ë¦¬
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('productRegistrationForm');
    if (form) {
        form.addEventListener('submit', handleProductRegistration);
    }
});

async function handleProductRegistration(event) {
    event.preventDefault();

    try {
        showLoading(true);

        const formData = new FormData(event.target);
        const productData = Object.fromEntries(formData.entries());

        // ìˆ«ì í•„ë“œ ë³€í™˜
        if (productData.price) productData.price = parseInt(productData.price);
        if (productData.discounted_price) productData.discounted_price = parseInt(productData.discounted_price);
        if (productData.stock) productData.stock = parseInt(productData.stock);

        console.log('ìƒí’ˆ ë“±ë¡ ë°ì´í„°:', productData);

        const response = await fetch('/api/products', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(productData)
        });

        const result = await response.json();
        console.log('ìƒí’ˆ ë“±ë¡ ì‘ë‹µ:', result);

        if (result.success) {
            // ì„±ê³µ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
            const modal = bootstrap.Modal.getInstance(document.getElementById('productRegistrationModal'));
            modal.hide();

            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle"></i> ìƒí’ˆì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').prepend(alertDiv);

            // 3ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);

            // ìƒí’ˆ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            await loadProducts();
            filterProducts(); // í˜„ì¬ í•„í„° ì ìš©

        } else {
            throw new Error(result.error || 'ìƒí’ˆ ë“±ë¡ ì‹¤íŒ¨');
        }

    } catch (error) {
        console.error('ìƒí’ˆ ë“±ë¡ ì˜¤ë¥˜:', error);
        alert('ìƒí’ˆ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    } finally {
        showLoading(false);
    }
}
</script>
{% endblock %}