{% extends "base.html" %}

{% block extra_head %}
<style>
    .product-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
    }
    .filter-card, .products-card {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .product-image {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 0.25rem;
    }
    .stock-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    .stock-low { background-color: #ffeaa7; color: #d63031; }
    .stock-medium { background-color: #81ecec; color: #00b894; }
    .stock-high { background-color: #a7f0ba; color: #00b894; }
    .stock-out { background-color: #fab1a0; color: #e17055; }
</style>
{% endblock %}

{% block content %}
<div class="product-header">
    <h2 class="h4 mb-2">
        <i class="fas fa-tags"></i> {{ title }}
    </h2>
    <p class="mb-0">상품 정보를 조회하고 관리할 수 있습니다. 재고 현황과 판매 상태를 확인하세요.</p>
</div>

<!-- 상품 필터 -->
<div class="filter-card p-3 mb-3">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h6 class="mb-2">
                <i class="fas fa-filter"></i> 판매 상태 필터
                <span class="badge bg-primary ms-2" id="selectedStatusCount">0</span>
            </h6>
            <div class="d-flex flex-wrap gap-3">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="status_all" onchange="toggleAllStatus()">
                    <label class="form-check-label small" for="status_all">전체선택</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input status-filter" type="checkbox" id="status_SALE" value="SALE" onchange="updateStatusFilter()">
                    <label class="form-check-label small" for="status_SALE">판매중</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input status-filter" type="checkbox" id="status_WAIT" value="WAIT" onchange="updateStatusFilter()">
                    <label class="form-check-label small" for="status_WAIT">승인대기</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input status-filter" type="checkbox" id="status_OUTOFSTOCK" value="OUTOFSTOCK" onchange="updateStatusFilter()">
                    <label class="form-check-label small" for="status_OUTOFSTOCK">품절</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input status-filter" type="checkbox" id="status_SUSPENSION" value="SUSPENSION" onchange="updateStatusFilter()">
                    <label class="form-check-label small" for="status_SUSPENSION">판매중지</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input status-filter" type="checkbox" id="status_CLOSE" value="CLOSE" onchange="updateStatusFilter()">
                    <label class="form-check-label small" for="status_CLOSE">종료</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input status-filter" type="checkbox" id="status_PROHIBITION" value="PROHIBITION" onchange="updateStatusFilter()">
                    <label class="form-check-label small" for="status_PROHIBITION">판매금지</label>
                </div>
            </div>
        </div>
        <div class="col-md-4 text-end">
            <div class="d-flex gap-2 justify-content-end">
                <button type="button" class="btn btn-outline-info btn-sm" onclick="saveFilterSettings()">
                    <i class="fas fa-save"></i> 저장
                </button>
                <button type="button" class="btn btn-outline-warning btn-sm" onclick="loadFromSettings()" title="설정에서 불러오기">
                    <i class="fas fa-cog"></i> 설정
                </button>
                <button type="button" class="btn btn-success btn-sm" onclick="refreshProducts()">
                    <i class="fas fa-sync"></i> 새로고침
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 상품 목록 -->
<div class="products-card">
    <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
        <h5 class="mb-0"><i class="fas fa-list"></i> 상품 목록</h5>
        <div>
            <span id="productCount" class="badge bg-primary fs-6 me-2">
                총 <span id="totalProductCount">0</span>건
            </span>
            <button class="btn btn-success btn-sm me-2" onclick="showProductRegistration()">
                <i class="fas fa-plus"></i> 상품등록
            </button>
            <button class="btn btn-outline-primary btn-sm" onclick="exportProducts()">
                <i class="fas fa-download"></i> 내보내기
            </button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="bg-light">
                <tr>
                    <th width="5%">변경</th>
                    <th width="5%">조회</th>
                    <th width="5%">상세</th>
                    <th width="4%">이미지</th>
                    <th width="18%">상품명</th>
                    <th width="8%">상품ID</th>
                    <th width="8%">원래판매가</th>
                    <th width="8%">셀러할인가</th>
                    <th width="8%">실제판매가</th>
                    <th width="6%">재고</th>
                    <th width="6%">상태</th>
                    <th width="8%">등록일</th>
                    <th width="6%">판매량</th>
                    <th width="10%">원상품ID</th>
                </tr>
            </thead>
            <tbody id="productsTableBody">
                <!-- 동적으로 로드됨 -->
            </tbody>
        </table>
    </div>

    <!-- 상품이 없을 때 -->
    <div id="noProductsMessage" class="text-center p-5 d-none">
        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">등록된 상품이 없습니다</h5>
        <p class="text-muted">새 상품을 등록하거나 다른 조건으로 검색해보세요.</p>
    </div>
</div>

<!-- 상품 상세 모달 -->
<div class="modal fade" id="productDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">상품 상세 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="productDetailContent">
                    <!-- 동적으로 로드됨 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" onclick="editProduct()">수정</button>
            </div>
        </div>
    </div>
</div>

<!-- 상품 등록 모달 -->
<div class="modal fade" id="productRegistrationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> 새 상품 등록
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="productRegistrationForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productName" class="form-label">상품명 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="productName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productBrand" class="form-label">브랜드</label>
                                <input type="text" class="form-control" id="productBrand" name="brand">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productPrice" class="form-label">원래판매가 <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="productPrice" name="price" required min="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productDiscountedPrice" class="form-label">셀러할인가</label>
                                <input type="number" class="form-control" id="productDiscountedPrice" name="discounted_price" min="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productStock" class="form-label">재고수량 <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="productStock" name="stock" required min="0">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productStatus" class="form-label">판매상태 <span class="text-danger">*</span></label>
                                <select class="form-select" id="productStatus" name="status" required>
                                    <option value="">선택하세요</option>
                                    <option value="SALE">판매중</option>
                                    <option value="WAIT">승인대기</option>
                                    <option value="OUTOFSTOCK">품절</option>
                                    <option value="SUSPENSION">판매중지</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productImageUrl" class="form-label">상품 이미지 URL</label>
                                <input type="url" class="form-control" id="productImageUrl" name="image_url">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="productDescription" class="form-label">상품설명</label>
                        <textarea class="form-control" id="productDescription" name="description" rows="3"></textarea>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>참고:</strong> 상품 등록 후 네이버 쇼핑 API를 통해 동기화됩니다.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> 등록
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let products = [];
let filteredProducts = [];

// 페이지 로드시 상품 로드 및 필터 설정 로드
document.addEventListener('DOMContentLoaded', async function() {
    // 상품 데이터 로드 후 필터 설정 로드
    await loadProducts();
    await loadFilterSettings();
    // 초기 상태 카운트 업데이트
    updateStatusCount();
});

// 상품 로드
async function loadProducts() {
    try {
        console.log('상품 로드 시작...');
        showLoading(true);

        const response = await fetch('/api/products');
        console.log('API 응답 상태:', response.status);
        const data = await response.json();
        console.log('API 응답 데이터:', data);

        if (data.success) {
            products = data.products;
            filteredProducts = [...products];
            console.log('상품 개수:', products.length);
            console.log('첫 번째 상품:', products[0]);
            renderProducts(filteredProducts);
            updateProductCount(filteredProducts.length);
        } else {
            throw new Error(data.error || '상품 로드 실패');
        }
    } catch (error) {
        console.error('상품 로드 오류:', error);
        alert('상품을 불러오는 중 오류가 발생했습니다: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// 멀티셀렉션 필터 관련 함수들
function getSelectedStatuses() {
    const checkboxes = document.querySelectorAll('.status-filter:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function updateStatusCount() {
    const count = getSelectedStatuses().length;
    document.getElementById('selectedStatusCount').textContent = count;
}

function updateStatusFilter() {
    updateStatusCount();
    // 자동 필터링 적용 (선택사항)
    filterProducts();
}

function toggleAllStatus() {
    const allCheckbox = document.getElementById('status_all');
    const statusCheckboxes = document.querySelectorAll('.status-filter');

    statusCheckboxes.forEach(cb => {
        cb.checked = allCheckbox.checked;
    });

    updateStatusCount();
    filterProducts();
}

// 상품 필터링 (멀티셀렉션 지원)
function filterProducts() {
    const selectedStatuses = getSelectedStatuses();

    filteredProducts = products.filter(product => {
        // 상태 필터 - 아무것도 선택하지 않으면 모든 상품 표시
        if (selectedStatuses.length > 0 && !selectedStatuses.includes(product.status)) {
            return false;
        }

        return true;
    });

    renderProducts(filteredProducts);
    updateProductCount(filteredProducts.length);
}

// 필터 설정 저장
async function saveFilterSettings() {
    const selectedStatuses = getSelectedStatuses();
    const filterSettings = {
        selectedStatuses: selectedStatuses
    };

    try {
        const response = await fetch('/api/products/filter-settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(filterSettings)
        });

        const data = await response.json();
        if (data.success) {
            // 성공 알림
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-2';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle"></i> 필터 설정이 저장되었습니다.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.filter-card').appendChild(alertDiv);

            // 3초 후 자동 제거
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        } else {
            throw new Error(data.error || '필터 저장 실패');
        }
    } catch (error) {
        console.error('필터 저장 오류:', error);
        alert('필터 설정 저장 중 오류가 발생했습니다: ' + error.message);
    }
}

// 필터 설정 로드
async function loadFilterSettings() {
    try {
        const response = await fetch('/api/products/filter-settings');
        const data = await response.json();

        if (data.success && data.settings) {
            const settings = data.settings;

            // 상태 필터 복원
            if (settings.selectedStatuses && settings.selectedStatuses.length > 0) {
                settings.selectedStatuses.forEach(status => {
                    const checkbox = document.getElementById(`status_${status}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
                updateStatusCount();
                filterProducts();
            }
        }
    } catch (error) {
        console.error('필터 설정 로드 오류:', error);
    }
}

// 설정 페이지에서 상품조회설정 불러오기
async function loadFromSettings() {
    try {
        // 사용자에게 확인
        if (!confirm('설정 페이지의 상품조회설정을 현재 필터에 적용하시겠습니까?\n현재 선택된 필터는 초기화됩니다.')) {
            return;
        }

        // 설정 API에서 상품 상태 조회 설정 가져오기
        const response = await fetch('/api/settings');
        const result = await response.json();

        if (result.success && result.data) {
            const productStatusTypes = result.data.product_status_types;

            if (productStatusTypes) {
                // 모든 체크박스 초기화
                resetFilters();

                // 설정에서 가져온 상태들 체크
                const statusList = productStatusTypes.split(',').map(s => s.trim()).filter(s => s);
                statusList.forEach(status => {
                    const checkbox = document.getElementById(`status_${status}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });

                // 필터 업데이트
                updateStatusCount();
                filterProducts();

                // 상품 필터 설정도 동기화
                await saveFilterSettings();

                alert(`설정 페이지에서 ${statusList.length}개의 상품 상태를 불러왔습니다: ${statusList.join(', ')}`);
            } else {
                alert('설정 페이지에 상품조회설정이 없습니다.\n설정 > 조건설정 > 상품 상태 조회 설정을 먼저 구성해주세요.');
            }
        } else {
            throw new Error(result.error || '설정 조회 실패');
        }
    } catch (error) {
        console.error('설정에서 불러오기 오류:', error);
        alert('설정에서 불러오기 중 오류가 발생했습니다: ' + error.message);
    }
}

// 문자열 이스케이프 함수 (JavaScript 템플릿 리터럴용)
function escapeHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#x27;');
}

// JavaScript 함수 인자용 이스케이프 (작은따옴표 처리)
function escapeJsString(str) {
    if (!str) return '';
    return String(str).replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r');
}

// 상품 테이블 렌더링
function renderProducts(productList) {
    console.log('renderProducts 호출됨, 상품 개수:', productList.length);
    const tbody = document.getElementById('productsTableBody');
    const noProductsMessage = document.getElementById('noProductsMessage');

    console.log('tbody 엘리먼트:', tbody);
    console.log('noProductsMessage 엘리먼트:', noProductsMessage);

    if (productList.length === 0) {
        console.log('상품이 없으므로 메시지 표시');
        tbody.innerHTML = '';
        noProductsMessage.classList.remove('d-none');
        return;
    }

    console.log('상품 테이블 렌더링 시작...');
    noProductsMessage.classList.add('d-none');


    const tableHTML = productList.map((product, index) => {
        const productId = escapeJsString(product.origin_product_no || product.product_id);
        const productName = escapeJsString(product.name);

        return `
        <tr>
            <td class="text-center">
                <button class="btn btn-outline-warning btn-sm" onclick="openProductEdit('${productId}', '${productName}')" title="상품 수정">
                    ⚙️ 변경
                </button>
            </td>
            <td class="text-center">
                <button class="btn btn-outline-info btn-sm" onclick="openProductViewPopup('${productId}', '${productName}')" title="상품 정보 조회">
                    🔍 조회
                </button>
            </td>
            <td class="text-center">
                <button class="btn btn-outline-secondary btn-sm" onclick="openProductDetailPopup('${productId}', '${productName}')" title="원본 데이터 상세 (디버깅용)">
                    📄 상세
                </button>
            </td>
            <td>
                <img src="${product.image_url || '/static/images/no-image.png'}"
                     alt="상품이미지" class="product-image"
                     onerror="this.src='/static/images/no-image.png'">
            </td>
            <td onclick="showProductDetail('${escapeJsString(product.product_id)}')" style="cursor: pointer;">
                <div class="text-truncate" style="max-width: 200px;" title="${escapeHtml(product.name)}">
                    <strong>${escapeHtml(product.name || '-')}</strong>
                </div>
                <small class="text-muted">${escapeHtml(product.brand || '')}</small>
            </td>
            <td>
                <small class="text-muted">${product.product_id || '-'}</small>
            </td>
            <td class="text-end">
                <strong>${formatPrice(product.sale_price)}</strong>
            </td>
            <td class="text-end">
                ${product.discounted_price && product.discounted_price > 0 && product.discounted_price < product.sale_price ?
                    `<small class="text-danger">${formatPrice(product.sale_price - product.discounted_price)}</small>` :
                    '<small class="text-muted">-</small>'
                }
            </td>
            <td class="text-end">
                ${product.discounted_price && product.discounted_price > 0 ?
                    `<strong class="text-primary">${formatPrice(product.discounted_price)}</strong>` :
                    '<small class="text-muted">-</small>'
                }
            </td>
            <td class="text-center">
                <span class="stock-badge ${getStockBadgeClass(product.stock)}">
                    ${product.stock || 0}
                </span>
            </td>
            <td>
                <span class="badge ${getStatusBadgeClass(product.status)}">
                    ${getStatusText(product.status)}
                </span>
            </td>
            <td>
                <small>${formatDate(product.created_at)}</small>
            </td>
            <td class="text-center">
                ${product.sales_count || 0}건
            </td>
            <td>
                <small class="text-muted">${product.origin_product_no || '-'}</small>
            </td>
        </tr>
        `;
    }).join('');

    console.log('테이블 HTML 길이:', tableHTML.length);
    console.log('테이블 HTML 미리보기:', tableHTML.substring(0, 200) + '...');

    tbody.innerHTML = tableHTML;
    console.log('테이블 업데이트 완료');
}

// 필터 초기화
function resetFilters() {
    // 모든 체크박스 해제
    document.getElementById('status_all').checked = false;
    const statusCheckboxes = document.querySelectorAll('.status-filter');
    statusCheckboxes.forEach(cb => {
        cb.checked = false;
    });

    // 카운트 업데이트
    updateStatusCount();

    // 모든 상품 표시
    filteredProducts = [...products];
    renderProducts(filteredProducts);
    updateProductCount(filteredProducts.length);
}

// 상품 새로고침 (네이버 API에서 가져오기)
async function refreshProducts() {
    try {
        console.log('네이버 API에서 상품 새로고침 시작...');
        showLoading(true);

        // 새로고침 버튼 업데이트
        const refreshBtn = document.querySelector('button[onclick="refreshProducts()"]');
        if (refreshBtn) {
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> API 새로고침 중...';
            refreshBtn.disabled = true;
        }

        const response = await fetch('/api/products/refresh', {
            method: 'POST'
        });
        console.log('API 새로고침 응답 상태:', response.status);
        const data = await response.json();
        console.log('API 새로고침 응답 데이터:', data);

        if (data.success) {
            products = data.products;
            console.log('네이버 API에서 새로고침:', products.length, '개 상품');

            // 현재 선택된 필터 유지하여 다시 적용
            filterProducts();

            // 성공 메시지 표시
            if (data.message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.container').prepend(alertDiv);

                // 3초 후 자동 제거
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 3000);
            }
        } else {
            throw new Error(data.error || '상품 새로고침 실패');
        }

        // 버튼 원상복구
        if (refreshBtn) {
            refreshBtn.innerHTML = '<i class="fas fa-sync"></i> 새로고침';
            refreshBtn.disabled = false;
        }

    } catch (error) {
        console.error('상품 새로고침 오류:', error);
        alert('상품을 새로고침하는 중 오류가 발생했습니다: ' + error.message);

        // 실패 시 버튼 원상복구
        const refreshBtn = document.querySelector('button[onclick="refreshProducts()"]');
        if (refreshBtn) {
            refreshBtn.innerHTML = '<i class="fas fa-sync"></i> 새로고침';
            refreshBtn.disabled = false;
        }
    } finally {
        showLoading(false);
    }
}

// 상품 내보내기
function exportProducts() {
    alert('상품 내보내기 기능이 곧 구현될 예정입니다.');
}

// 상품 상세 보기
function showProductDetail(productId) {
    const product = products.find(p => p.product_id === productId);
    if (!product) return;

    const content = `
        <div class="row">
            <div class="col-md-4">
                <img src="${product.image_url || '/static/images/no-image.png'}"
                     class="img-fluid rounded" alt="상품이미지"
                     onerror="this.src='/static/images/no-image.png'">
            </div>
            <div class="col-md-8">
                <h5>${product.name}</h5>
                <p class="text-muted mb-2">상품ID: ${product.product_id}</p>

                <table class="table table-sm">
                    <tr>
                        <th>원래판매가</th>
                        <td><span class="text-muted">${formatPrice(product.sale_price)}</span></td>
                    </tr>
                    <tr>
                        <th>셀러할인가</th>
                        <td><span class="text-danger">${formatPrice((product.sale_price || 0) - (product.discounted_price || 0))}</span></td>
                    </tr>
                    <tr>
                        <th>실제판매가</th>
                        <td><strong class="text-primary">${formatPrice(product.discounted_price)}</strong></td>
                    </tr>
                    <tr>
                        <th>현재재고</th>
                        <td>
                            <span class="stock-badge ${getStockBadgeClass(product.stock)}">
                                ${product.stock || 0}개
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>판매상태</th>
                        <td>
                            <span class="badge ${getStatusBadgeClass(product.status)}">
                                ${getStatusText(product.status)}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>등록일</th>
                        <td>${formatDate(product.created_at)}</td>
                    </tr>
                    <tr>
                        <th>총 판매량</th>
                        <td>${product.sales_count || 0}건</td>
                    </tr>
                </table>

                ${product.description ? `
                <div class="mt-3">
                    <h6>상품설명</h6>
                    <p class="text-muted">${product.description}</p>
                </div>
                ` : ''}
            </div>
        </div>
    `;

    document.getElementById('productDetailContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('productDetailModal')).show();
}

// 스마트스토어 상품 수정 페이지 열기 (원상품ID 사용)
function openProductEdit(originProductId, productName = "") {
    try {
        console.log('상품 수정 페이지 열기:', originProductId, productName);

        if (!originProductId || originProductId === 'undefined' || originProductId === '-') {
            alert('원상품ID를 찾을 수 없습니다. 상품 수정 페이지를 열 수 없습니다.');
            return;
        }

        // 스마트스토어 상품 수정 URL (원상품ID 포함)
        const url = `https://sell.smartstore.naver.com/#/products/edit/${originProductId}`;
        window.open(url, '_blank');

        console.log('상품 수정 페이지 열기 완료:', originProductId, productName);

        // 성공 메시지 표시
        showStatusMessage(`상품 수정 페이지를 브라우저에서 열었습니다: ${productName}`, 'success');

    } catch (error) {
        console.error('상품 수정 페이지 열기 오류:', error);
        alert('상품 수정 페이지를 여는 중 오류가 발생했습니다: ' + error.message);
    }
}

// 스마트스토어 상품 조회 페이지 열기 (상품ID 사용)
function openProductView(productId, productName = "") {
    try {
        console.log('상품 조회 페이지 열기:', productId, productName);

        if (!productId || productId === 'undefined' || productId === '-') {
            alert('상품ID를 찾을 수 없습니다. 상품 조회 페이지를 열 수 없습니다.');
            return;
        }

        // 스마트스토어 상품 조회 URL (상품ID 포함)
        const url = `https://smartstore.naver.com/us-shop/products/${productId}`;
        window.open(url, '_blank');

        console.log('상품 조회 페이지 열기 완료:', productId, productName);

        // 성공 메시지 표시
        showStatusMessage(`상품 조회 페이지를 브라우저에서 열었습니다: ${productName}`, 'info');

    } catch (error) {
        console.error('상품 조회 페이지 열기 오류:', error);
        alert('상품 조회 페이지를 여는 중 오류가 발생했습니다: ' + error.message);
    }
}

// 상품 정보를 가독성 좋은 형태로 보여주는 함수
async function openProductViewPopup(originProductId, productName = "") {
    try {
        console.log('상품 정보 조회:', originProductId, productName);

        if (!originProductId || originProductId === 'undefined' || originProductId === '-') {
            alert('원상품ID를 찾을 수 없습니다. 상품 정보를 조회할 수 없습니다.');
            return;
        }

        // 로딩 표시
        showStatusMessage('상품 정보를 조회하고 있습니다...', 'info');

        // 서버에서 네이버 API 응답 조회
        const response = await fetch(`/api/products/${originProductId}/detail`);
        const result = await response.json();

        if (result.success) {
            const data = result.data;

            // 디버깅: 전체 데이터 구조 확인
            console.log('전체 API 응답 데이터:', data);
            console.log('data 타입:', typeof data);
            console.log('data 키들:', Object.keys(data));
            console.log('originProduct 존재 여부:', !!data.originProduct);

            // 다양한 가능한 경로 확인
            console.log('data.data 확인:', data.data);
            console.log('data.data?.originProduct 확인:', data.data?.originProduct);
            console.log('detailAttribute 존재 여부:', !!data.originProduct?.detailAttribute);
            console.log('optionInfo 존재 여부:', !!data.originProduct?.detailAttribute?.optionInfo);

            // optionInfo 경로 확인 - 여러 가능한 경로 시도
            let optionInfo = data.originProduct?.detailAttribute?.optionInfo;

            // 첫 번째 경로가 실패하면 data.data 경로 시도
            if (!optionInfo) {
                optionInfo = data.data?.originProduct?.detailAttribute?.optionInfo;
                console.log('두 번째 경로 시도: data.data.originProduct.detailAttribute.optionInfo');
            }
            console.log('추출된 optionInfo:', optionInfo);

            if (!optionInfo) {
                console.log('optionInfo가 없습니다. 데이터 구조를 확인하세요.');
                showStatusMessage('이 상품에는 옵션 정보가 없습니다.', 'info');
                return;
            }

            // 기본 상품 정보와 optionInfo만 표시
            const basicInfo = `
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
                    <h6 style="margin: 0 0 10px 0; color: #495057;">📦 기본 정보</h6>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div><strong>상품명:</strong> ${productName}</div>
                        <div><strong>원상품ID:</strong> ${originProductId}</div>
                    </div>
                </div>
            `;

            const optionInfoHtml = generateOptionInfoSection(optionInfo);

            // 팝업 창 HTML 생성
            const popupHtml = `
                <div style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.5); z-index: 10000;
                    display: flex; align-items: center; justify-content: center;
                " onclick="closeProductViewPopup()">
                    <div style="
                        background: white; width: 90%; max-width: 900px; max-height: 90%;
                        border-radius: 8px; padding: 20px; overflow: auto;
                        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                    " onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h5 style="margin: 0; color: #333;">🎛️ 상품 옵션 정보</h5>
                            <button onclick="closeProductViewPopup()" style="
                                background: #dc3545; color: white; border: none;
                                border-radius: 4px; padding: 8px 12px; cursor: pointer;
                            ">✕ 닫기</button>
                        </div>
                        ${basicInfo}
                        ${optionInfoHtml}
                        <div style="margin-top: 15px; text-align: center;">
                            <button onclick="closeProductViewPopup()" style="
                                background: #6c757d; color: white; border: none;
                                border-radius: 4px; padding: 8px 16px; cursor: pointer;
                            ">닫기</button>
                        </div>
                    </div>
                </div>
            `;

            // 팝업을 body에 추가
            const popupDiv = document.createElement('div');
            popupDiv.id = 'productViewPopup';
            popupDiv.innerHTML = popupHtml;
            document.body.appendChild(popupDiv);

            showStatusMessage('상품 정보 조회 완료', 'success');

        } else {
            throw new Error(result.error || '상품 정보 조회 실패');
        }

    } catch (error) {
        console.error('상품 정보 조회 오류:', error);
        showStatusMessage(`상품 정보 조회 중 오류가 발생했습니다: ${error.message}`, 'error');
    }
}

// 옵션 정보를 파싱해서 표시하는 함수
function generateOptionInfoSection(optionInfo) {
    console.log('generateOptionInfoSection 호출됨, optionInfo:', optionInfo);

    if (!optionInfo) {
        console.error('optionInfo가 null 또는 undefined입니다.');
        return '<div>옵션 정보를 불러올 수 없습니다.</div>';
    }
    const formatCurrency = (value) => {
        if (!value || value === 0) return '기본가';
        return (value > 0 ? '+' : '') + Number(value).toLocaleString() + '원';
    };

    const getStockBadge = (stock) => {
        if (stock === 0) return '<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">품절</span>';
        if (stock < 10) return '<span style="background: #ffc107; color: black; padding: 2px 6px; border-radius: 3px; font-size: 11px;">재고부족</span>';
        return '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">재고있음</span>';
    };

    const getUsableBadge = (usable) => {
        return usable
            ? '<span style="background: #17a2b8; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">사용가능</span>'
            : '<span style="background: #6c757d; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">사용불가</span>';
    };

    let html = `
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
            <h6 style="margin: 0 0 15px 0; color: #856404;">🎛️ 상품 옵션 정보</h6>
    `;

    // 옵션 그룹 이름 표시
    if (optionInfo.optionCombinationGroupNames) {
        html += `
            <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #ddd; margin-bottom: 10px;">
                <h6 style="margin: 0 0 5px 0; color: #495057;">📂 옵션 그룹</h6>
        `;
        Object.entries(optionInfo.optionCombinationGroupNames).forEach(([key, value]) => {
            html += `<div><strong>${key}:</strong> ${value}</div>`;
        });
        html += `</div>`;
    }

    // 옵션 조합 표시
    if (optionInfo.optionCombinations && optionInfo.optionCombinations.length > 0) {
        html += `
            <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #ddd; margin-bottom: 10px;">
                <h6 style="margin: 0 0 10px 0; color: #495057;">🛍️ 옵션 목록 (총 ${optionInfo.optionCombinations.length}개)</h6>
                <div style="display: grid; gap: 8px;">
        `;

        optionInfo.optionCombinations.forEach((option, index) => {
            html += `
                <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #e9ecef;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 5px;">
                        <strong style="color: #495057;">${option.optionName1 || `옵션 ${index + 1}`}</strong>
                        <div>
                            ${getStockBadge(option.stockQuantity)}
                            ${getUsableBadge(option.usable)}
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; font-size: 12px; color: #6c757d;">
                        <div><strong>옵션ID:</strong> ${option.id}</div>
                        <div><strong>재고:</strong> ${option.stockQuantity.toLocaleString()}개</div>
                        <div><strong>추가금액:</strong> ${formatCurrency(option.price)}</div>
                        <div><strong>관리코드:</strong> ${option.sellerManagerCode || '-'}</div>
                    </div>
                </div>
            `;
        });

        html += `
                </div>
            </div>
        `;
    }

    // 옵션 설정 정보
    html += `
        <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
            <h6 style="margin: 0 0 10px 0; color: #495057;">⚙️ 옵션 설정</h6>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;">
                <div><strong>단순옵션 정렬:</strong> ${optionInfo.simpleOptionSortType || '-'}</div>
                <div><strong>조합옵션 정렬:</strong> ${optionInfo.optionCombinationSortType || '-'}</div>
                <div><strong>단순옵션 수:</strong> ${optionInfo.optionSimple ? optionInfo.optionSimple.length : 0}개</div>
                <div><strong>커스텀옵션 수:</strong> ${optionInfo.optionCustom ? optionInfo.optionCustom.length : 0}개</div>
            </div>
        </div>
    `;

    html += `</div>`;
    return html;
}

// 상품 정보를 표 형태로 구성하는 함수
function generateProductInfoTable(data, productName, originProductId) {
    const formatValue = (value) => {
        if (value === null || value === undefined || value === '') return '-';
        if (typeof value === 'object') return `<pre style="margin: 0; white-space: pre-wrap; font-size: 11px;">${JSON.stringify(value, null, 2)}</pre>`;
        if (typeof value === 'number' && value >= 1000) return value.toLocaleString();
        if (typeof value === 'boolean') return value ? '예' : '아니오';
        return String(value);
    };

    const formatCurrency = (value) => {
        if (!value || value === 0) return '-';
        return Number(value).toLocaleString() + '원';
    };

    const getStatusBadge = (status) => {
        const statusMap = {
            'SALE': { color: '#28a745', text: '판매중' },
            'WAIT': { color: '#ffc107', text: '승인대기' },
            'OUTOFSTOCK': { color: '#dc3545', text: '품절' },
            'SUSPENSION': { color: '#6c757d', text: '판매중지' }
        };
        const info = statusMap[status] || { color: '#6c757d', text: status || '-' };
        return `<span style="background: ${info.color}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${info.text}</span>`;
    };

    // 이미지 관련 필드들을 제외할 목록
    const imageFields = [
        'representativeImage', 'productImages', 'detailImages', 'additionalImages',
        'imageUrl', 'thumbnailUrl', 'mainImage', 'subImages'
    ];

    // 주요 필드들을 먼저 표시하고, 나머지는 추가 정보로 표시
    const mainFields = [
        'channelProductNo', 'statusType', 'salePrice', 'stockPrice', 'supplyPrice',
        'discountedPrice', 'stockQuantity', 'wholeCategoryName', 'brandName',
        'manufacturerName', 'regDate', 'editDate', 'saleStartDate', 'saleEndDate'
    ];

    const additionalFields = Object.keys(data).filter(key =>
        !mainFields.includes(key) && !imageFields.includes(key) && key !== 'optionInfo'
    );

    return `
        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
            <h6 style="margin: 0 0 10px 0; color: #495057;">📦 기본 정보</h6>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div><strong>상품명:</strong> ${productName}</div>
                <div><strong>원상품ID:</strong> ${originProductId}</div>
                <div><strong>채널상품ID:</strong> ${formatValue(data.channelProductNo)}</div>
                <div><strong>상품상태:</strong> ${data.statusType ? getStatusBadge(data.statusType) : '-'}</div>
            </div>
        </div>

        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
            <h6 style="margin: 0 0 10px 0; color: #495057;">💰 가격 정보</h6>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div><strong>판매가:</strong> ${formatCurrency(data.salePrice)}</div>
                <div><strong>정가:</strong> ${formatCurrency(data.stockPrice)}</div>
                <div><strong>공급가:</strong> ${formatCurrency(data.supplyPrice)}</div>
                <div><strong>할인가:</strong> ${formatCurrency(data.discountedPrice)}</div>
            </div>
        </div>

        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
            <h6 style="margin: 0 0 10px 0; color: #495057;">📦 재고 및 카테고리</h6>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div><strong>재고수량:</strong> ${formatValue(data.stockQuantity)}</div>
                <div><strong>카테고리:</strong> ${formatValue(data.wholeCategoryName)}</div>
                <div><strong>브랜드:</strong> ${formatValue(data.brandName)}</div>
                <div><strong>제조업체:</strong> ${formatValue(data.manufacturerName)}</div>
            </div>
        </div>

        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
            <h6 style="margin: 0 0 10px 0; color: #495057;">📅 날짜 정보</h6>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div><strong>등록일:</strong> ${formatValue(data.regDate)}</div>
                <div><strong>수정일:</strong> ${formatValue(data.editDate)}</div>
                <div><strong>승인일:</strong> ${formatValue(data.saleStartDate)}</div>
                <div><strong>판매종료일:</strong> ${formatValue(data.saleEndDate)}</div>
            </div>
        </div>

        ${data.optionInfo ? generateOptionInfoSection(data.optionInfo) : ''}

        ${additionalFields.length > 0 ? `
        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
            <h6 style="margin: 0 0 10px 0; color: #495057;">🔧 추가 정보 (${additionalFields.length}개 필드)</h6>
            <div style="max-height: 400px; overflow: auto;">
                ${additionalFields.map(key => {
                    const value = data[key];
                    if (value === null || value === undefined || value === '') return '';
                    return `
                        <div style="background: white; margin-bottom: 8px; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                            <strong style="color: #495057;">${key}:</strong><br>
                            <div style="margin-top: 4px; color: #6c757d;">
                                ${formatValue(value)}
                            </div>
                        </div>
                    `;
                }).filter(item => item !== '').join('')}
            </div>
        </div>
        ` : ''}

        <div style="background: #e9ecef; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px;">
            <h6 style="margin: 0 0 10px 0; color: #495057;">📊 데이터 요약</h6>
            <div style="font-size: 12px; color: #6c757d;">
                • 전체 필드 수: ${Object.keys(data).length}개<br>
                • 표시된 필드 수: ${mainFields.filter(f => data[f] !== undefined).length + additionalFields.length}개<br>
                • 이미지 필드 제외: ${imageFields.filter(f => data[f] !== undefined).length}개<br>
                • optionInfo 포함 여부: ${data.optionInfo ? '✅ 포함' : '❌ 없음'}
            </div>
        </div>
    `;
}

// 팝업 닫기 함수 (조회용)
function closeProductViewPopup() {
    const popup = document.getElementById('productViewPopup');
    if (popup) {
        popup.remove();
    }
}

// 네이버 API 원본 응답을 팝업으로 보여주는 함수 (디버깅용)
async function openProductDetailPopup(originProductId, productName = "") {
    try {
        console.log('상품 상세 정보 조회:', originProductId, productName);

        if (!originProductId || originProductId === 'undefined' || originProductId === '-') {
            alert('원상품ID를 찾을 수 없습니다. 상품 정보를 조회할 수 없습니다.');
            return;
        }

        // 로딩 표시
        showStatusMessage('상품 정보를 조회하고 있습니다...', 'info');

        // 서버에서 네이버 API 응답 조회
        const response = await fetch(`/api/products/${originProductId}/detail`);
        const result = await response.json();

        if (result.success) {
            // 응답 데이터를 예쁘게 포맷팅
            const formattedData = JSON.stringify(result.data, null, 2);

            // 팝업 창 HTML 생성
            const popupHtml = `
                <div style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.5); z-index: 10000;
                    display: flex; align-items: center; justify-content: center;
                " onclick="closeProductDetailPopup()">
                    <div style="
                        background: white; width: 90%; max-width: 800px; max-height: 90%;
                        border-radius: 8px; padding: 20px; overflow: auto;
                        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                    " onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h5 style="margin: 0; color: #333;">🔍 상품 상세 정보 (원본 API 응답)</h5>
                            <button onclick="closeProductDetailPopup()" style="
                                background: #dc3545; color: white; border: none;
                                border-radius: 4px; padding: 8px 12px; cursor: pointer;
                            ">✕ 닫기</button>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>상품명:</strong> ${productName}<br>
                            <strong>원상품ID:</strong> ${originProductId}
                        </div>
                        <div style="
                            background: #f8f9fa; border: 1px solid #dee2e6;
                            border-radius: 4px; padding: 15px;
                            font-family: 'Courier New', monospace;
                            white-space: pre-wrap; font-size: 12px;
                            max-height: 500px; overflow: auto;
                        ">${formattedData}</div>
                        <div style="margin-top: 15px; text-align: center;">
                            <button onclick="copyToClipboard('${formattedData.replace(/'/g, "\\'")}'); showStatusMessage('클립보드에 복사되었습니다!', 'success');" style="
                                background: #28a745; color: white; border: none;
                                border-radius: 4px; padding: 8px 16px; cursor: pointer; margin-right: 10px;
                            ">📋 복사</button>
                            <button onclick="closeProductDetailPopup()" style="
                                background: #6c757d; color: white; border: none;
                                border-radius: 4px; padding: 8px 16px; cursor: pointer;
                            ">닫기</button>
                        </div>
                    </div>
                </div>
            `;

            // 팝업을 body에 추가
            const popupDiv = document.createElement('div');
            popupDiv.id = 'productDetailPopup';
            popupDiv.innerHTML = popupHtml;
            document.body.appendChild(popupDiv);

            showStatusMessage('상품 정보 조회 완료', 'success');

        } else {
            throw new Error(result.error || '상품 정보 조회 실패');
        }

    } catch (error) {
        console.error('상품 상세 정보 조회 오류:', error);
        showStatusMessage(`상품 정보 조회 중 오류가 발생했습니다: ${error.message}`, 'error');
    }
}

// 팝업 닫기 함수
function closeProductDetailPopup() {
    const popup = document.getElementById('productDetailPopup');
    if (popup) {
        popup.remove();
    }
}

// 클립보드 복사 함수
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).catch(err => {
        console.error('클립보드 복사 실패:', err);
        // 폴백: 텍스트 영역 생성해서 복사
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
    });
}

// 상태 메시지 표시 함수
function showStatusMessage(message, type = 'info') {
    const alertClass = type === 'success' ? 'alert-success' :
                      type === 'error' ? 'alert-danger' : 'alert-info';

    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${alertClass} alert-dismissible fade show mt-3`;
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // 첫 번째 카드 위에 삽입
    const firstCard = document.querySelector('.product-header');
    if (firstCard && firstCard.parentNode) {
        firstCard.parentNode.insertBefore(alertDiv, firstCard.nextSibling);
    } else {
        document.querySelector('.container').prepend(alertDiv);
    }

    // 5초 후 자동 제거
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// 기존 상품 수정 함수 (호환성 유지)
function editProduct(productId) {
    const product = products.find(p => p.product_id === productId);
    if (product) {
        openProductEdit(product.origin_product_no || productId, product.name);
    } else {
        alert('상품 정보를 찾을 수 없습니다.');
    }
}

// 상품 상태 변경
function toggleProductStatus(productId) {
    alert('상품 상태 변경 기능이 곧 구현될 예정입니다.');
}

// 유틸리티 함수들
function getCategoryText(category) {
    const categoryMap = {
        'fashion': '패션',
        'beauty': '뷰티',
        'home': '홈/리빙',
        'food': '식품',
        'digital': '디지털'
    };
    return categoryMap[category] || category || '-';
}

function getStockBadgeClass(stock) {
    const stockNum = stock || 0;
    if (stockNum === 0) return 'stock-out';
    if (stockNum < 50) return 'stock-low';
    if (stockNum < 100) return 'stock-medium';
    return 'stock-high';
}

function getStatusBadgeClass(status) {
    switch(status) {
        case 'SALE': return 'bg-success';
        case 'WAIT': return 'bg-warning';
        case 'OUTOFSTOCK': return 'bg-danger';
        case 'SUSPENSION': return 'bg-secondary';
        case 'CLOSE': return 'bg-dark';
        case 'PROHIBITION': return 'bg-danger';
        default: return 'bg-light text-dark';
    }
}

function getStatusText(status) {
    switch(status) {
        case 'SALE': return '판매중';
        case 'WAIT': return '승인대기';
        case 'OUTOFSTOCK': return '품절';
        case 'SUSPENSION': return '판매중지';
        case 'CLOSE': return '종료';
        case 'PROHIBITION': return '판매금지';
        default: return status || '-';
    }
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('ko-KR');
}

function formatPrice(price) {
    if (!price) return '-';
    return new Intl.NumberFormat('ko-KR').format(price) + '원';
}

function updateProductCount(count) {
    document.getElementById('totalProductCount').textContent = count;
}

function showLoading(show) {
    // 로딩 표시 (간단한 구현)
    if (show) {
        document.body.style.cursor = 'wait';
    } else {
        document.body.style.cursor = 'default';
    }
}

// 상품 등록 모달 표시
function showProductRegistration() {
    // 폼 초기화
    document.getElementById('productRegistrationForm').reset();

    // 모달 표시
    const modal = new bootstrap.Modal(document.getElementById('productRegistrationModal'));
    modal.show();
}

// 상품 등록 폼 제출 처리
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('productRegistrationForm');
    if (form) {
        form.addEventListener('submit', handleProductRegistration);
    }
});

async function handleProductRegistration(event) {
    event.preventDefault();

    try {
        showLoading(true);

        const formData = new FormData(event.target);
        const productData = Object.fromEntries(formData.entries());

        // 숫자 필드 변환
        if (productData.price) productData.price = parseInt(productData.price);
        if (productData.discounted_price) productData.discounted_price = parseInt(productData.discounted_price);
        if (productData.stock) productData.stock = parseInt(productData.stock);

        console.log('상품 등록 데이터:', productData);

        const response = await fetch('/api/products', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(productData)
        });

        const result = await response.json();
        console.log('상품 등록 응답:', result);

        if (result.success) {
            // 성공 시 모달 닫기
            const modal = bootstrap.Modal.getInstance(document.getElementById('productRegistrationModal'));
            modal.hide();

            // 성공 메시지 표시
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle"></i> 상품이 성공적으로 등록되었습니다.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').prepend(alertDiv);

            // 3초 후 자동 제거
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);

            // 상품 목록 새로고침
            await loadProducts();
            filterProducts(); // 현재 필터 적용

        } else {
            throw new Error(result.error || '상품 등록 실패');
        }

    } catch (error) {
        console.error('상품 등록 오류:', error);
        alert('상품 등록 중 오류가 발생했습니다: ' + error.message);
    } finally {
        showLoading(false);
    }
}
</script>
{% endblock %}