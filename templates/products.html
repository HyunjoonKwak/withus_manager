{% extends "base.html" %}

{% block extra_head %}
<style>
    .product-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
    }
    .filter-card, .products-card {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .product-image {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 0.25rem;
    }
    .stock-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    .stock-low { background-color: #ffeaa7; color: #d63031; }
    .stock-medium { background-color: #81ecec; color: #00b894; }
    .stock-high { background-color: #a7f0ba; color: #00b894; }
    .stock-out { background-color: #fab1a0; color: #e17055; }
</style>
{% endblock %}

{% block content %}
<div class="product-header">
    <h2 class="h4 mb-2">
        <i class="fas fa-tags"></i> {{ title }}
    </h2>
    <p class="mb-0">상품 정보를 조회하고 관리할 수 있습니다. 재고 현황과 판매 상태를 확인하세요.</p>
</div>

<!-- 상품 필터 -->
<div class="filter-card p-3 mb-3">
    <h5 class="mb-3"><i class="fas fa-filter"></i> 상품 필터</h5>
    <div class="row">
        <div class="col-md-3">
            <label class="form-label">판매 상태</label>
            <select class="form-select" id="statusFilter">
                <option value="">전체</option>
                <option value="SALE">판매중</option>
                <option value="WAIT">승인대기</option>
                <option value="OUTOFSTOCK">품절</option>
                <option value="SUSPENSION">판매중지</option>
                <option value="CLOSE">종료</option>
                <option value="PROHIBITION">판매금지</option>
            </select>
        </div>
        <div class="col-md-9 d-flex align-items-end gap-2">
            <button type="button" class="btn btn-primary" onclick="filterProducts()">
                <i class="fas fa-search"></i> 검색
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                <i class="fas fa-undo"></i> 초기화
            </button>
            <button type="button" class="btn btn-success" onclick="refreshProducts()">
                <i class="fas fa-sync"></i> 새로고침
            </button>
        </div>
    </div>
</div>

<!-- 상품 목록 -->
<div class="products-card">
    <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
        <h5 class="mb-0"><i class="fas fa-list"></i> 상품 목록</h5>
        <div>
            <span id="productCount" class="badge bg-primary fs-6 me-2">
                총 <span id="totalProductCount">0</span>건
            </span>
            <button class="btn btn-outline-primary btn-sm" onclick="exportProducts()">
                <i class="fas fa-download"></i> 내보내기
            </button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="bg-light">
                <tr>
                    <th width="5%">이미지</th>
                    <th width="15%">상품명</th>
                    <th width="10%">상품ID</th>
                    <th width="8%">카테고리</th>
                    <th width="8%">원래판매가</th>
                    <th width="8%">셀러할인가</th>
                    <th width="8%">실제판매가</th>
                    <th width="6%">재고</th>
                    <th width="6%">상태</th>
                    <th width="10%">등록일</th>
                    <th width="8%">판매량</th>
                    <th width="8%">액션</th>
                </tr>
            </thead>
            <tbody id="productsTableBody">
                <!-- 동적으로 로드됨 -->
            </tbody>
        </table>
    </div>

    <!-- 상품이 없을 때 -->
    <div id="noProductsMessage" class="text-center p-5 d-none">
        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">등록된 상품이 없습니다</h5>
        <p class="text-muted">새 상품을 등록하거나 다른 조건으로 검색해보세요.</p>
    </div>
</div>

<!-- 상품 상세 모달 -->
<div class="modal fade" id="productDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">상품 상세 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="productDetailContent">
                    <!-- 동적으로 로드됨 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" onclick="editProduct()">수정</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let products = [];
let filteredProducts = [];

// 페이지 로드시 상품 로드
document.addEventListener('DOMContentLoaded', function() {
    loadProducts();

    // 실시간 검색 (debounce 적용)
    let searchTimeout;
    document.getElementById('productNameFilter').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            filterProducts();
        }, 500);
    });
});

// 상품 로드
async function loadProducts() {
    try {
        console.log('상품 로드 시작...');
        showLoading(true);

        const response = await fetch('/api/products');
        console.log('API 응답 상태:', response.status);
        const data = await response.json();
        console.log('API 응답 데이터:', data);

        if (data.success) {
            products = data.products;
            filteredProducts = [...products];
            console.log('상품 개수:', products.length);
            console.log('첫 번째 상품:', products[0]);
            renderProducts(filteredProducts);
            updateProductCount(filteredProducts.length);
        } else {
            throw new Error(data.error || '상품 로드 실패');
        }
    } catch (error) {
        console.error('상품 로드 오류:', error);
        alert('상품을 불러오는 중 오류가 발생했습니다: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// 상품 필터링
function filterProducts() {
    const statusFilter = document.getElementById('statusFilter').value;

    filteredProducts = products.filter(product => {
        // 상태 필터
        if (statusFilter && product.status !== statusFilter) {
            return false;
        }

        return true;
    });

    renderProducts(filteredProducts);
    updateProductCount(filteredProducts.length);
}

// 상품 테이블 렌더링
function renderProducts(productList) {
    console.log('renderProducts 호출됨, 상품 개수:', productList.length);
    const tbody = document.getElementById('productsTableBody');
    const noProductsMessage = document.getElementById('noProductsMessage');

    console.log('tbody 엘리먼트:', tbody);
    console.log('noProductsMessage 엘리먼트:', noProductsMessage);

    if (productList.length === 0) {
        console.log('상품이 없으므로 메시지 표시');
        tbody.innerHTML = '';
        noProductsMessage.classList.remove('d-none');
        return;
    }

    console.log('상품 테이블 렌더링 시작...');
    noProductsMessage.classList.add('d-none');


    const tableHTML = productList.map((product, index) => `
        <tr onclick="showProductDetail('${product.product_id}')" style="cursor: pointer;">
            <td>
                <img src="${product.image_url || '/static/images/no-image.png'}"
                     alt="상품이미지" class="product-image"
                     onerror="this.src='/static/images/no-image.png'">
            </td>
            <td>
                <div class="text-truncate" style="max-width: 200px;" title="${product.name}">
                    <strong>${product.name || '-'}</strong>
                </div>
                <small class="text-muted">${product.brand || ''}</small>
            </td>
            <td>
                <small class="text-muted">${product.product_id || '-'}</small>
            </td>
            <td>
                <span class="badge bg-light text-dark">${getCategoryText(product.category)}</span>
            </td>
            <td class="text-end">
                <small class="text-muted">${formatPrice(product.price || product.sale_price)}</small>
            </td>
            <td class="text-end">
                <small class="text-success">${formatPrice(product.discounted_price)}</small>
            </td>
            <td class="text-end">
                <strong class="text-primary">${formatPrice(product.actual_price || product.sale_price - (product.discounted_price || 0))}</strong>
            </td>
            <td class="text-center">
                <span class="stock-badge ${getStockBadgeClass(product.stock)}">
                    ${product.stock || 0}
                </span>
            </td>
            <td>
                <span class="badge ${getStatusBadgeClass(product.status)}">
                    ${getStatusText(product.status)}
                </span>
            </td>
            <td>
                <small>${formatDate(product.created_at)}</small>
            </td>
            <td class="text-center">
                ${product.sales_count || 0}건
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); editProduct('${product.product_id}')" title="수정">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="event.stopPropagation(); toggleProductStatus('${product.product_id}')" title="상태변경">
                        <i class="fas fa-toggle-on"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');

    console.log('테이블 HTML 길이:', tableHTML.length);
    console.log('테이블 HTML 미리보기:', tableHTML.substring(0, 200) + '...');

    tbody.innerHTML = tableHTML;
    console.log('테이블 업데이트 완료');
}

// 필터 초기화
function resetFilters() {
    document.getElementById('statusFilter').value = '';

    filteredProducts = [...products];
    renderProducts(filteredProducts);
    updateProductCount(filteredProducts.length);
}

// 상품 새로고침 (네이버 API에서 가져오기)
async function refreshProducts() {
    try {
        console.log('네이버 API에서 상품 새로고침 시작...');
        showLoading(true);

        // 새로고침 버튼 업데이트
        const refreshBtn = document.querySelector('button[onclick="refreshProducts()"]');
        if (refreshBtn) {
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> API 새로고침 중...';
            refreshBtn.disabled = true;
        }

        const response = await fetch('/api/products/refresh', {
            method: 'POST'
        });
        console.log('API 새로고침 응답 상태:', response.status);
        const data = await response.json();
        console.log('API 새로고침 응답 데이터:', data);

        if (data.success) {
            products = data.products;
            filteredProducts = [...products];
            console.log('네이버 API에서 새로고침:', products.length, '개 상품');
            renderProducts(filteredProducts);
            updateProductCount(filteredProducts.length);

            // 성공 메시지 표시
            if (data.message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.container').prepend(alertDiv);

                // 3초 후 자동 제거
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 3000);
            }
        } else {
            throw new Error(data.error || '상품 새로고침 실패');
        }

        // 버튼 원상복구
        if (refreshBtn) {
            refreshBtn.innerHTML = '<i class="fas fa-sync"></i> 새로고침';
            refreshBtn.disabled = false;
        }

    } catch (error) {
        console.error('상품 새로고침 오류:', error);
        alert('상품을 새로고침하는 중 오류가 발생했습니다: ' + error.message);

        // 실패 시 버튼 원상복구
        const refreshBtn = document.querySelector('button[onclick="refreshProducts()"]');
        if (refreshBtn) {
            refreshBtn.innerHTML = '<i class="fas fa-sync"></i> 새로고침';
            refreshBtn.disabled = false;
        }
    } finally {
        showLoading(false);
    }
}

// 상품 내보내기
function exportProducts() {
    alert('상품 내보내기 기능이 곧 구현될 예정입니다.');
}

// 상품 상세 보기
function showProductDetail(productId) {
    const product = products.find(p => p.product_id === productId);
    if (!product) return;

    const content = `
        <div class="row">
            <div class="col-md-4">
                <img src="${product.image_url || '/static/images/no-image.png'}"
                     class="img-fluid rounded" alt="상품이미지"
                     onerror="this.src='/static/images/no-image.png'">
            </div>
            <div class="col-md-8">
                <h5>${product.name}</h5>
                <p class="text-muted mb-2">상품ID: ${product.product_id}</p>

                <table class="table table-sm">
                    <tr>
                        <th width="30%">카테고리</th>
                        <td>${getCategoryText(product.category)}</td>
                    </tr>
                    <tr>
                        <th>원래판매가</th>
                        <td><span class="text-muted">${formatPrice(product.price || product.sale_price)}</span></td>
                    </tr>
                    <tr>
                        <th>셀러할인가</th>
                        <td><span class="text-success">${formatPrice(product.discounted_price)}</span></td>
                    </tr>
                    <tr>
                        <th>실제판매가</th>
                        <td><strong class="text-primary">${formatPrice(product.actual_price || product.sale_price - (product.discounted_price || 0))}</strong></td>
                    </tr>
                    <tr>
                        <th>현재재고</th>
                        <td>
                            <span class="stock-badge ${getStockBadgeClass(product.stock)}">
                                ${product.stock || 0}개
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>판매상태</th>
                        <td>
                            <span class="badge ${getStatusBadgeClass(product.status)}">
                                ${getStatusText(product.status)}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>등록일</th>
                        <td>${formatDate(product.created_at)}</td>
                    </tr>
                    <tr>
                        <th>총 판매량</th>
                        <td>${product.sales_count || 0}건</td>
                    </tr>
                </table>

                ${product.description ? `
                <div class="mt-3">
                    <h6>상품설명</h6>
                    <p class="text-muted">${product.description}</p>
                </div>
                ` : ''}
            </div>
        </div>
    `;

    document.getElementById('productDetailContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('productDetailModal')).show();
}

// 상품 수정
function editProduct(productId) {
    alert('상품 수정 기능이 곧 구현될 예정입니다.');
}

// 상품 상태 변경
function toggleProductStatus(productId) {
    alert('상품 상태 변경 기능이 곧 구현될 예정입니다.');
}

// 유틸리티 함수들
function getCategoryText(category) {
    const categoryMap = {
        'fashion': '패션',
        'beauty': '뷰티',
        'home': '홈/리빙',
        'food': '식품',
        'digital': '디지털'
    };
    return categoryMap[category] || category || '-';
}

function getStockBadgeClass(stock) {
    const stockNum = stock || 0;
    if (stockNum === 0) return 'stock-out';
    if (stockNum < 50) return 'stock-low';
    if (stockNum < 100) return 'stock-medium';
    return 'stock-high';
}

function getStatusBadgeClass(status) {
    switch(status) {
        case 'SALE': return 'bg-success';
        case 'WAIT': return 'bg-warning';
        case 'OUTOFSTOCK': return 'bg-danger';
        case 'SUSPENSION': return 'bg-secondary';
        case 'CLOSE': return 'bg-dark';
        case 'PROHIBITION': return 'bg-danger';
        default: return 'bg-light text-dark';
    }
}

function getStatusText(status) {
    switch(status) {
        case 'SALE': return '판매중';
        case 'WAIT': return '승인대기';
        case 'OUTOFSTOCK': return '품절';
        case 'SUSPENSION': return '판매중지';
        case 'CLOSE': return '종료';
        case 'PROHIBITION': return '판매금지';
        default: return status || '-';
    }
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('ko-KR');
}

function formatPrice(price) {
    if (!price) return '-';
    return new Intl.NumberFormat('ko-KR').format(price) + '원';
}

function updateProductCount(count) {
    document.getElementById('totalProductCount').textContent = count;
}

function showLoading(show) {
    // 로딩 표시 (간단한 구현)
    if (show) {
        document.body.style.cursor = 'wait';
    } else {
        document.body.style.cursor = 'default';
    }
}
</script>
{% endblock %}