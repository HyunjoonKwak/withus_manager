{% extends "base.html" %}

{% block title %}대시보드 - {{ title }}{% endblock %}

{% block extra_head %}
<style>
    .status-card {
        height: 100%;
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
    }
    .status-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .status-card.clickable {
        cursor: pointer;
    }
    .status-card.has-orders {
        border-left: 4px solid #fd7e14;
        background: linear-gradient(135deg, #fff 0%, #fff8f0 100%);
    }
    .status-card.no-orders {
        background: #f8f9fa;
    }
    .status-icon {
        font-size: 3rem;
        margin-bottom: 10px;
    }
    .chart-container {
        position: relative;
        height: 300px;
    }
    .refresh-info {
        background: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .period-selector {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 10px;
        margin-top: 10px;
    }
    .period-info {
        font-size: 0.9rem;
        color: #6c757d;
    }
    .period-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }
</style>
{% endblock %}

{% block content %}
<!-- 새로고침 정보 및 기간 설정 -->
<div class="refresh-info">
    <div class="row align-items-center">
        <div class="col-md-8">
            <i class="fas fa-info-circle text-primary"></i>
            <strong>자동 모니터링:</strong>
            {% if monitoring_active %}
                <span class="text-success">활성화됨</span>
                - 주기적으로 주문 상태를 확인하고 있습니다.
            {% else %}
                <span class="text-warning">비활성화됨</span>
                - 수동으로 새로고침해주세요.
            {% endif %}
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-primary btn-sm" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt"></i> 지금 새로고침
            </button>
        </div>
    </div>

    <!-- 조회 기간 설정 -->
    <div class="period-selector">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="period-info">
                    <i class="fas fa-calendar-alt text-info"></i>
                    <strong>조회 기간:</strong>
                    <span id="current-period">최근 {{ dashboard_data.period.days|default(5) }}일간</span>
                    <br>
                    <small id="period-dates" class="text-muted">
                        {{ dashboard_data.period.start_date|default("") }} ~ {{ dashboard_data.period.end_date|default("") }}
                    </small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="period-controls">
                    <label for="period-select" class="form-label mb-0 text-sm">기간 변경:</label>
                    <div class="d-flex gap-2 align-items-center">
                        <select id="period-select" class="form-select form-select-sm" style="max-width: 120px;">
                            <option value="1" {% if dashboard_data.period.days == 1 %}selected{% endif %}>1일</option>
                            <option value="3" {% if dashboard_data.period.days == 3 %}selected{% endif %}>3일</option>
                            <option value="5" {% if dashboard_data.period.days == 5 %}selected{% endif %}>5일</option>
                            <option value="7" {% if dashboard_data.period.days == 7 %}selected{% endif %}>7일</option>
                            <option value="10" {% if dashboard_data.period.days == 10 %}selected{% endif %}>10일</option>
                            <option value="14" {% if dashboard_data.period.days == 14 %}selected{% endif %}>14일</option>
                            <option value="30" {% if dashboard_data.period.days == 30 %}selected{% endif %}>30일</option>
                            <option value="90" {% if dashboard_data.period.days == 90 %}selected{% endif %}>90일</option>
                        </select>
                        <button id="save-period-btn" class="btn btn-sm btn-success" onclick="saveDashboardPeriod()" style="white-space: nowrap;">
                            <i class="fas fa-save"></i> 저장
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 대시보드 통계 -->
<div class="row g-3 mb-4">
    <div class="col-12">
        <h4>
            <i class="fas fa-chart-bar text-primary"></i> 주문 현황
            <small class="text-muted">전체 {{ total_orders }}건</small>
        </h4>
    </div>
</div>

<div class="row g-3" id="dashboard-cards">
    {% for status, count in order_counts.items() %}
    <div class="col-md-3 col-sm-6">
        <div class="card status-card {% if count > 0 %}has-orders{% else %}no-orders{% endif %}"
             onclick="navigateToOrderPage('{{ status }}', {{ count }})"
             style="cursor: pointer;">
            <div class="card-body text-center">
                <div class="status-icon">
                    {% if status == '신규주문' %}
                        <i class="fas fa-plus-circle text-success"></i>
                    {% elif status == '발송대기' %}
                        <i class="fas fa-box text-info"></i>
                    {% elif status == '배송중' %}
                        <i class="fas fa-truck text-primary"></i>
                    {% elif status == '배송완료' %}
                        <i class="fas fa-check-circle text-success"></i>
                    {% elif status == '구매확정' %}
                        <i class="fas fa-heart text-danger"></i>
                    {% elif status == '취소주문' %}
                        <i class="fas fa-times-circle text-danger"></i>
                    {% elif status == '반품주문' %}
                        <i class="fas fa-undo text-warning"></i>
                    {% elif status == '교환주문' %}
                        <i class="fas fa-exchange-alt text-warning"></i>
                    {% else %}
                        <i class="fas fa-question-circle text-secondary"></i>
                    {% endif %}
                </div>
                <h3 class="status-count">{{ "{:,}".format(count) }}</h3>
                <h6 class="card-title mb-0">{{ status }}</h6>
                {% if count > 0 %}
                    <small class="text-muted">건이 있습니다</small>
                {% else %}
                    <small class="text-muted">없음</small>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- 추가 정보 -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-clock text-primary"></i> 시스템 정보
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <td>마지막 확인:</td>
                        <td><strong>{{ last_check }}</strong></td>
                    </tr>
                    <tr>
                        <td>모니터링 상태:</td>
                        <td>
                            {% if monitoring_active %}
                                <span class="badge bg-success">활성화</span>
                            {% else %}
                                <span class="badge bg-warning">비활성화</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td>현재 시간:</td>
                        <td class="current-time">-</td>
                    </tr>
                    <tr>
                        <td>다음 새로고침:</td>
                        <td>
                            <span id="refresh-countdown" class="badge bg-info">-</span>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-bell text-primary"></i> 빠른 작업
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt"></i> 대시보드 새로고침
                    </button>
                    <button class="btn btn-outline-info" onclick="window.location.href='/orders'">
                        <i class="fas fa-list"></i> 주문 목록 보기
                    </button>
                    <button class="btn btn-outline-success" onclick="testNotifications()">
                        <i class="fas fa-paper-plane"></i> 알림 테스트
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 안내 메시지 -->
{% if total_orders == 0 %}
<div class="alert alert-info mt-4" role="alert">
    <i class="fas fa-info-circle"></i>
    <strong>안내:</strong> 아직 주문 데이터가 없습니다.
    네이버 API 연동을 확인하거나 수동으로 주문을 가져와보세요.
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
// 대시보드 새로고침
async function refreshDashboard() {
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;

    try {
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 새로고침 중...';
        button.disabled = true;

        // 카드들을 로딩 상태로 변경
        document.getElementById('dashboard-cards').classList.add('loading');

        const response = await fetch('/api/dashboard/refresh');
        const result = await response.json();

        if (result.success) {
            // 성공적으로 새로고침되면 페이지 리로드
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            throw new Error(result.error || '알 수 없는 오류');
        }
    } catch (error) {
        alert('대시보드 새로고침 중 오류가 발생했습니다: ' + error.message);
        button.innerHTML = originalHtml;
        button.disabled = false;
        document.getElementById('dashboard-cards').classList.remove('loading');
    }
}

// 알림 테스트
async function testNotifications() {
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;

    try {
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 테스트 중...';
        button.disabled = true;

        const response = await fetch('/api/test-notifications', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        const result = await response.json();

        if (result.success) {
            alert('알림 테스트가 완료되었습니다. Discord를 확인해보세요.');
        } else {
            throw new Error(result.error || '알 수 없는 오류');
        }
    } catch (error) {
        alert('알림 테스트 중 오류가 발생했습니다: ' + error.message);
    } finally {
        button.innerHTML = originalHtml;
        button.disabled = false;
    }
}

// 주문 상태 페이지로 이동
function navigateToOrderPage(status, count) {
    // 상태별 URL 매핑
    const statusUrlMap = {
        '신규주문': '/new-orders',
        '발송대기': '/shipping-pending',
        '배송중': '/shipping-in-progress',
        '배송완료': '/shipping-completed',
        '구매확정': '/purchase-decided',
        '취소주문': '/cancel',
        '반품주문': '/returns-exchanges',
        '교환주문': '/returns-exchanges'
    };

    const url = statusUrlMap[status];
    if (url) {
        window.location.href = url;
    } else {
        console.warn('알 수 없는 주문 상태:', status);
    }
}

// 기간 저장 (환경 변수에 저장)
async function saveDashboardPeriod() {
    const select = document.getElementById('period-select');
    const saveButton = document.getElementById('save-period-btn');
    const days = parseInt(select.value);
    const originalHtml = saveButton.innerHTML;

    try {
        saveButton.disabled = true;
        saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 저장중...';

        const response = await fetch('/api/dashboard/period', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ days: days, save_to_env: true })
        });

        const result = await response.json();

        if (result.success) {
            // 기간 정보 업데이트
            document.getElementById('current-period').textContent = `최근 ${days}일간`;
            if (result.period_dates) {
                document.getElementById('period-dates').textContent = result.period_dates;
            }

            // 성공 메시지 표시
            saveButton.innerHTML = '<i class="fas fa-check"></i> 저장완료';
            saveButton.className = 'btn btn-sm btn-success';

            // 대시보드 새로고침
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            throw new Error(result.error || '기간 저장 중 오류가 발생했습니다');
        }
    } catch (error) {
        alert('기간 저장 중 오류가 발생했습니다: ' + error.message);
        console.error('Period save error:', error);
        saveButton.innerHTML = originalHtml;
        saveButton.disabled = false;
    }
}

// 기간 변경 (임시 변경, 저장하지 않음)
async function changeDashboardPeriod() {
    const select = document.getElementById('period-select');
    const days = parseInt(select.value);

    try {
        const response = await fetch('/api/dashboard/period', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ days: days, save_to_env: false })
        });

        const result = await response.json();

        if (result.success) {
            // 기간 정보 업데이트
            document.getElementById('current-period').textContent = `최근 ${days}일간`;
            if (result.period_dates) {
                document.getElementById('period-dates').textContent = result.period_dates;
            }

            // 대시보드 새로고침
            setTimeout(() => {
                location.reload();
            }, 500);
        } else {
            throw new Error(result.error || '기간 변경 중 오류가 발생했습니다');
        }
    } catch (error) {
        alert('기간 변경 중 오류가 발생했습니다: ' + error.message);
        console.error('Period change error:', error);
    }
}

// 전역 변수
let refreshTimer = null;
let countdownTimer = null;
let nextRefreshTime = null;

// 현재 시간 업데이트
function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });
    document.querySelector('.current-time').textContent = timeString;
}

// 리프레시 카운트다운 업데이트
function updateRefreshCountdown() {
    const countdownElement = document.getElementById('refresh-countdown');

    if (!nextRefreshTime) {
        countdownElement.textContent = '비활성화됨';
        countdownElement.className = 'badge bg-secondary';
        return;
    }

    const now = new Date();
    const timeLeft = nextRefreshTime - now;

    if (timeLeft <= 0) {
        countdownElement.textContent = '새로고침 중...';
        countdownElement.className = 'badge bg-warning';
        // 자동 새로고침 실행
        refreshDashboard();
        return;
    }

    const minutes = Math.floor(timeLeft / 60000);
    const seconds = Math.floor((timeLeft % 60000) / 1000);

    if (minutes > 0) {
        countdownElement.textContent = `${minutes}분 ${seconds}초`;
    } else {
        countdownElement.textContent = `${seconds}초`;
    }

    // 30초 이하일 때 색상 변경
    if (timeLeft <= 30000) {
        countdownElement.className = 'badge bg-warning';
    } else if (timeLeft <= 60000) {
        countdownElement.className = 'badge bg-info';
    } else {
        countdownElement.className = 'badge bg-success';
    }
}

// 자동 새로고침 설정
function setupAutoRefresh() {
    // 모니터링이 활성화된 경우에만 자동 새로고침 설정
    const monitoringActive = {{ monitoring_active|lower }};

    if (!monitoringActive) {
        document.getElementById('refresh-countdown').textContent = '모니터링 비활성화';
        document.getElementById('refresh-countdown').className = 'badge bg-secondary';
        return;
    }

    // 기본 새로고침 간격 (10분)
    const refreshInterval = 10 * 60 * 1000; // 10분을 밀리초로

    // 다음 새로고침 시간 계산
    nextRefreshTime = new Date(Date.now() + refreshInterval);

    // 기존 타이머 정리
    if (refreshTimer) clearTimeout(refreshTimer);
    if (countdownTimer) clearInterval(countdownTimer);

    // 새로고침 타이머 설정
    refreshTimer = setTimeout(() => {
        refreshDashboard();
    }, refreshInterval);

    // 카운트다운 타이머 설정 (1초마다)
    countdownTimer = setInterval(updateRefreshCountdown, 1000);
}

// 페이지 로드 시 실행
document.addEventListener('DOMContentLoaded', function() {
    // 현재 시간을 1초마다 업데이트
    setInterval(updateCurrentTime, 1000);
    updateCurrentTime();

    // 자동 새로고침 설정
    setupAutoRefresh();
});

// 수동 새로고침 시 타이머 재설정
const originalRefreshDashboard = refreshDashboard;
refreshDashboard = async function() {
    await originalRefreshDashboard.apply(this, arguments);
    // 새로고침 후 타이머 재설정
    setupAutoRefresh();
};
</script>
{% endblock %}