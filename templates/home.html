{% extends "base.html" %}

{% block title %}ëŒ€ì‹œë³´ë“œ - WithUs ì£¼ë¬¸ê´€ë¦¬{% endblock %}

{% block extra_head %}
<style>
    .status-card {
        height: 120px;
        border: none;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
    }
    .status-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .status-card.clickable {
        cursor: pointer;
    }
    .status-card.has-orders {
        border-left: 4px solid #fd7e14;
        background: linear-gradient(135deg, #fff 0%, #fff8f0 100%);
    }
    .status-card.no-orders {
        background: #f8f9fa;
    }
    .status-icon {
        font-size: 1.8rem;
        margin-bottom: 5px;
    }
    .chart-container {
        position: relative;
        height: 300px;
    }
    .refresh-info {
        background: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .period-selector {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 10px;
        margin-top: 10px;
    }
    .period-info {
        font-size: 0.9rem;
        color: #6c757d;
    }
    .period-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    /* 8ê°œ ì¹´ë“œë¥¼ í•œ ì¤„ë¡œ ë°°ì¹˜í•˜ê¸° ìœ„í•œ ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
    @media (min-width: 1200px) {
        .col-xl-15 {
            flex: 0 0 12.5%;
            max-width: 12.5%;
        }
    }
    @media (min-width: 992px) and (max-width: 1199.98px) {
        .col-lg-15 {
            flex: 0 0 12.5%;
            max-width: 12.5%;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- ìƒˆë¡œê³ ì¹¨ ì •ë³´ ë° ê¸°ê°„ ì„¤ì • -->
<div class="refresh-info">
    <div class="row align-items-center">
        <div class="col-md-8">
            <i class="fas fa-info-circle text-primary"></i>
            <strong>ìë™ ëª¨ë‹ˆí„°ë§:</strong>
            {% if monitoring_active %}
                <span class="text-success">í™œì„±í™”ë¨</span>
                - ì£¼ê¸°ì ìœ¼ë¡œ ì£¼ë¬¸ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤.
            {% else %}
                <span class="text-warning">ë¹„í™œì„±í™”ë¨</span>
                - ìˆ˜ë™ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.
            {% endif %}
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-primary btn-sm" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt"></i> ì§€ê¸ˆ ìƒˆë¡œê³ ì¹¨
            </button>
        </div>
    </div>

    <!-- ì¡°íšŒ ê¸°ê°„ ì„¤ì • -->
    <div class="period-selector">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="period-info">
                    <i class="fas fa-calendar-alt text-info"></i>
                    <strong>ì¡°íšŒ ê¸°ê°„:</strong>
                    <span id="current-period">ìµœê·¼ {{ dashboard_data.period.days|default(5) }}ì¼ê°„</span>
                    <br>
                    <small id="period-dates" class="text-muted">
                        {{ dashboard_data.period.start_date|default("") }} ~ {{ dashboard_data.period.end_date|default("") }}
                    </small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="period-controls">
                    <label for="period-select" class="form-label mb-0 text-sm">ê¸°ê°„ ë³€ê²½:</label>
                    <div class="d-flex gap-2 align-items-center">
                        <select id="period-select" class="form-select form-select-sm" style="max-width: 120px;">
                            <option value="1" {% if dashboard_data.period.days == 1 %}selected{% endif %}>1ì¼</option>
                            <option value="3" {% if dashboard_data.period.days == 3 %}selected{% endif %}>3ì¼</option>
                            <option value="5" {% if dashboard_data.period.days == 5 %}selected{% endif %}>5ì¼</option>
                            <option value="7" {% if dashboard_data.period.days == 7 %}selected{% endif %}>7ì¼</option>
                            <option value="10" {% if dashboard_data.period.days == 10 %}selected{% endif %}>10ì¼</option>
                            <option value="14" {% if dashboard_data.period.days == 14 %}selected{% endif %}>14ì¼</option>
                            <option value="30" {% if dashboard_data.period.days == 30 %}selected{% endif %}>30ì¼</option>
                            <option value="90" {% if dashboard_data.period.days == 90 %}selected{% endif %}>90ì¼</option>
                        </select>
                        <button id="save-period-btn" class="btn btn-sm btn-success" onclick="saveDashboardPeriod()" style="white-space: nowrap;">
                            <i class="fas fa-save"></i> ì €ì¥
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ëŒ€ì‹œë³´ë“œ í†µê³„ -->
<div class="row g-3 mb-4">
    <div class="col-12">
        <h4>
            <i class="fas fa-chart-bar text-primary"></i> ì£¼ë¬¸ í˜„í™©
            <small class="text-muted">ì „ì²´ {{ total_orders }}ê±´</small>
        </h4>
    </div>
</div>

<div class="row g-2" id="dashboard-cards">
    {% for status, count in order_counts.items() %}
    <div class="col-xl-15 col-lg-15 col-md-3 col-sm-6">
        <div class="card status-card {% if count > 0 %}has-orders{% else %}no-orders{% endif %}"
             onclick="navigateToOrderPage('{{ status }}', {{ count }})"
             style="cursor: pointer;">
            <div class="card-body text-center p-2">
                <div class="status-icon">
                    {% if status == 'ì‹ ê·œì£¼ë¬¸' %}
                        <i class="fas fa-plus-circle text-success"></i>
                    {% elif status == 'ë°œì†¡ëŒ€ê¸°' %}
                        <i class="fas fa-box text-info"></i>
                    {% elif status == 'ë°°ì†¡ì¤‘' %}
                        <i class="fas fa-truck text-primary"></i>
                    {% elif status == 'ë°°ì†¡ì™„ë£Œ' %}
                        <i class="fas fa-check-circle text-success"></i>
                    {% elif status == 'êµ¬ë§¤í™•ì •' %}
                        <i class="fas fa-heart text-danger"></i>
                    {% elif status == 'ì·¨ì†Œì£¼ë¬¸' %}
                        <i class="fas fa-times-circle text-danger"></i>
                    {% elif status == 'ë°˜í’ˆì£¼ë¬¸' %}
                        <i class="fas fa-undo text-warning"></i>
                    {% elif status == 'êµí™˜ì£¼ë¬¸' %}
                        <i class="fas fa-exchange-alt text-warning"></i>
                    {% else %}
                        <i class="fas fa-question-circle text-secondary"></i>
                    {% endif %}
                </div>
                <h5 class="status-count mb-1">{{ "{:,}".format(count) }}</h5>
                <h6 class="card-title mb-0 small">{{ status }}</h6>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- ì¶”ê°€ ì •ë³´ -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-clock text-primary"></i> ì‹œìŠ¤í…œ ì •ë³´
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <td>ë§ˆì§€ë§‰ í™•ì¸:</td>
                        <td><strong>{{ last_check }}</strong></td>
                    </tr>
                    <tr>
                        <td>ëª¨ë‹ˆí„°ë§ ìƒíƒœ:</td>
                        <td>
                            {% if monitoring_active %}
                                <span class="badge bg-success">í™œì„±í™”</span>
                            {% else %}
                                <span class="badge bg-warning">ë¹„í™œì„±í™”</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td>í˜„ì¬ ì‹œê°„:</td>
                        <td><strong class="current-time">-</strong></td>
                    </tr>
                    <tr>
                        <td>ë‹¤ìŒ ìƒˆë¡œê³ ì¹¨:</td>
                        <td>
                            <span id="refresh-countdown" class="badge bg-info">-</span>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-bell text-primary"></i> ë¹ ë¥¸ ì‘ì—…
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt"></i> ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
                    </button>
                    <button class="btn btn-outline-info" onclick="window.location.href='/orders'">
                        <i class="fas fa-list"></i> ì£¼ë¬¸ ëª©ë¡ ë³´ê¸°
                    </button>
                    <button class="btn btn-outline-success" onclick="testNotifications()">
                        <i class="fas fa-paper-plane"></i> ì•Œë¦¼ í…ŒìŠ¤íŠ¸
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
{% if total_orders == 0 %}
<div class="alert alert-info mt-4" role="alert">
    <i class="fas fa-info-circle"></i>
    <strong>ì•ˆë‚´:</strong> ì•„ì§ ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
    ë„¤ì´ë²„ API ì—°ë™ì„ í™•ì¸í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ì£¼ë¬¸ì„ ê°€ì ¸ì™€ë³´ì„¸ìš”.
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
// ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
async function refreshDashboard(isAutoRefresh = false) {
    let button = null;
    let originalHtml = '';

    // ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ì¸ ê²½ìš°ì—ë§Œ ë²„íŠ¼ ì²˜ë¦¬
    if (!isAutoRefresh && event && event.target) {
        button = event.target.closest('button');
        originalHtml = button.innerHTML;
    }

    try {
        // ë²„íŠ¼ì´ ìˆëŠ” ê²½ìš° ë¡œë”© ìƒíƒœ ì„¤ì •
        if (button) {
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ìƒˆë¡œê³ ì¹¨ ì¤‘...';
            button.disabled = true;
        }

        // ì¹´ë“œë“¤ì„ ë¡œë”© ìƒíƒœë¡œ ë³€ê²½
        document.getElementById('dashboard-cards').classList.add('loading');

        console.log(`ğŸ”„ ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨ ${isAutoRefresh ? '(ìë™)' : '(ìˆ˜ë™)'}`);

        const response = await fetch('/api/dashboard/refresh');
        const result = await response.json();

        if (result.success) {
            // API ê°±ì‹  ì •ë³´ í‘œì‹œ
            const refreshMessage = result.api_refreshed
                ? `ë„¤ì´ë²„ APIì—ì„œ ${result.total_refreshed_from_api}ê±´ ê°±ì‹ ë¨`
                : 'ë¡œì»¬ ë°ì´í„°ë§Œ ìƒˆë¡œê³ ì¹¨ë¨';

            console.log(`âœ… ${refreshMessage}`);

            if (button) {
                button.innerHTML = `<i class="fas fa-check"></i> ${refreshMessage}`;
            }

            // ì„±ê³µì ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨ë˜ë©´ í˜ì´ì§€ ë¦¬ë¡œë“œ
            setTimeout(() => {
                location.reload();
            }, isAutoRefresh ? 500 : 1500); // ìë™ ìƒˆë¡œê³ ì¹¨ì€ ë” ë¹¨ë¦¬ ë¦¬ë¡œë“œ
        } else {
            throw new Error(result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
        }
    } catch (error) {
        console.error('âŒ ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', error);

        if (isAutoRefresh) {
            // ìë™ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨ ì‹œ ì¡°ìš©íˆ ì²˜ë¦¬
            console.warn('âš ï¸ ìë™ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨, ë‹¤ìŒ ì£¼ê¸°ì— ì¬ì‹œë„');
        } else {
            // ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨ ì‹œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
            alert('ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }

        if (button) {
            button.innerHTML = originalHtml;
            button.disabled = false;
        }
        document.getElementById('dashboard-cards').classList.remove('loading');
    }
}

// ì•Œë¦¼ í…ŒìŠ¤íŠ¸
async function testNotifications() {
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;

    try {
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> í…ŒìŠ¤íŠ¸ ì¤‘...';
        button.disabled = true;

        const response = await fetch('/api/test-notifications', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        const result = await response.json();

        if (result.success) {
            alert('ì•Œë¦¼ í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. Discordë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.');
        } else {
            throw new Error(result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
        }
    } catch (error) {
        alert('ì•Œë¦¼ í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    } finally {
        button.innerHTML = originalHtml;
        button.disabled = false;
    }
}

// ì£¼ë¬¸ ìƒíƒœ í˜ì´ì§€ë¡œ ì´ë™
function navigateToOrderPage(status, count) {
    // ìƒíƒœë³„ URL ë§¤í•‘
    const statusUrlMap = {
        'ì‹ ê·œì£¼ë¬¸': '/new-orders',
        'ë°œì†¡ëŒ€ê¸°': '/shipping-pending',
        'ë°°ì†¡ì¤‘': '/shipping-in-progress',
        'ë°°ì†¡ì™„ë£Œ': '/shipping-completed',
        'êµ¬ë§¤í™•ì •': '/purchase-decided',
        'ì·¨ì†Œì£¼ë¬¸': '/cancel',
        'ë°˜í’ˆì£¼ë¬¸': '/returns-exchanges',
        'êµí™˜ì£¼ë¬¸': '/returns-exchanges'
    };

    const url = statusUrlMap[status];
    if (url) {
        window.location.href = url;
    } else {
        console.warn('ì•Œ ìˆ˜ ì—†ëŠ” ì£¼ë¬¸ ìƒíƒœ:', status);
    }
}

// ê¸°ê°„ ì €ì¥ (í™˜ê²½ ë³€ìˆ˜ì— ì €ì¥)
async function saveDashboardPeriod() {
    const select = document.getElementById('period-select');
    const saveButton = document.getElementById('save-period-btn');
    const days = parseInt(select.value);
    const originalHtml = saveButton.innerHTML;

    try {
        saveButton.disabled = true;
        saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì €ì¥ì¤‘...';

        const response = await fetch('/api/dashboard/period', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ days: days, save_to_env: true })
        });

        const result = await response.json();

        if (result.success) {
            // ê¸°ê°„ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('current-period').textContent = `ìµœê·¼ ${days}ì¼ê°„`;
            if (result.period_dates) {
                document.getElementById('period-dates').textContent = result.period_dates;
            }

            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            saveButton.innerHTML = '<i class="fas fa-check"></i> ì €ì¥ì™„ë£Œ';
            saveButton.className = 'btn btn-sm btn-success';

            // ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            throw new Error(result.error || 'ê¸°ê°„ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        }
    } catch (error) {
        alert('ê¸°ê°„ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        console.error('Period save error:', error);
        saveButton.innerHTML = originalHtml;
        saveButton.disabled = false;
    }
}

// ê¸°ê°„ ë³€ê²½ (ì„ì‹œ ë³€ê²½, ì €ì¥í•˜ì§€ ì•ŠìŒ)
async function changeDashboardPeriod() {
    const select = document.getElementById('period-select');
    const days = parseInt(select.value);

    try {
        const response = await fetch('/api/dashboard/period', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ days: days, save_to_env: false })
        });

        const result = await response.json();

        if (result.success) {
            // ê¸°ê°„ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('current-period').textContent = `ìµœê·¼ ${days}ì¼ê°„`;
            if (result.period_dates) {
                document.getElementById('period-dates').textContent = result.period_dates;
            }

            // ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
            setTimeout(() => {
                location.reload();
            }, 500);
        } else {
            throw new Error(result.error || 'ê¸°ê°„ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        }
    } catch (error) {
        alert('ê¸°ê°„ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        console.error('Period change error:', error);
    }
}

// ì „ì—­ ë³€ìˆ˜
let refreshTimer = null;
let countdownTimer = null;
let nextRefreshTime = null;

// í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸
function updateCurrentTime() {
    const now = new Date();

    // ë” ì•ˆì •ì ì¸ 24ì‹œê°„ í˜•ì‹ ì‹œê°„ ìƒì„±
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const date = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');

    const timeString = `${year}.${month}.${date} ${hours}:${minutes}:${seconds}`;

    const timeElement = document.querySelector('.current-time');
    if (timeElement && timeElement.textContent !== timeString) {
        timeElement.textContent = timeString;
    }
}

// ë¦¬í”„ë ˆì‹œ ì¹´ìš´íŠ¸ë‹¤ìš´ ì—…ë°ì´íŠ¸
function updateRefreshCountdown() {
    const countdownElement = document.getElementById('refresh-countdown');

    if (!nextRefreshTime) {
        countdownElement.textContent = 'ë¹„í™œì„±í™”ë¨';
        countdownElement.className = 'badge bg-secondary';
        return;
    }

    const now = new Date();
    const timeLeft = nextRefreshTime - now;

    if (timeLeft <= 0) {
        countdownElement.textContent = 'ìƒˆë¡œê³ ì¹¨ ì¤‘...';
        countdownElement.className = 'badge bg-warning';
        // ìë™ ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰
        refreshDashboard(true); // isAutoRefresh = true
        return;
    }

    const minutes = Math.floor(timeLeft / 60000);
    const seconds = Math.floor((timeLeft % 60000) / 1000);

    if (minutes > 0) {
        countdownElement.textContent = `${minutes}ë¶„ ${seconds}ì´ˆ`;
    } else {
        countdownElement.textContent = `${seconds}ì´ˆ`;
    }

    // 30ì´ˆ ì´í•˜ì¼ ë•Œ ìƒ‰ìƒ ë³€ê²½
    if (timeLeft <= 30000) {
        countdownElement.className = 'badge bg-warning';
    } else if (timeLeft <= 60000) {
        countdownElement.className = 'badge bg-info';
    } else {
        countdownElement.className = 'badge bg-success';
    }
}

// ìë™ ìƒˆë¡œê³ ì¹¨ ì„¤ì •
function setupAutoRefresh() {
    // ëª¨ë‹ˆí„°ë§ì´ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ìë™ ìƒˆë¡œê³ ì¹¨ ì„¤ì •
    const monitoringActive = {{ monitoring_active|lower }};

    if (!monitoringActive) {
        document.getElementById('refresh-countdown').textContent = 'ëª¨ë‹ˆí„°ë§ ë¹„í™œì„±í™”';
        document.getElementById('refresh-countdown').className = 'badge bg-secondary';
        return;
    }

    // ê¸°ë³¸ ìƒˆë¡œê³ ì¹¨ ê°„ê²© (10ë¶„)
    const refreshInterval = 10 * 60 * 1000; // 10ë¶„ì„ ë°€ë¦¬ì´ˆë¡œ

    // ë‹¤ìŒ ìƒˆë¡œê³ ì¹¨ ì‹œê°„ ê³„ì‚°
    nextRefreshTime = new Date(Date.now() + refreshInterval);

    // ê¸°ì¡´ íƒ€ì´ë¨¸ ì •ë¦¬
    if (refreshTimer) clearTimeout(refreshTimer);
    if (countdownTimer) clearInterval(countdownTimer);

    // ìƒˆë¡œê³ ì¹¨ íƒ€ì´ë¨¸ ì„¤ì •
    refreshTimer = setTimeout(() => {
        refreshDashboard(true); // isAutoRefresh = true
    }, refreshInterval);

    // ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸ ì„¤ì • (1ì´ˆë§ˆë‹¤)
    countdownTimer = setInterval(updateRefreshCountdown, 1000);
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
document.addEventListener('DOMContentLoaded', function() {
    // í˜„ì¬ ì‹œê°„ì„ 1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
    setInterval(updateCurrentTime, 1000);
    updateCurrentTime();

    // ìë™ ìƒˆë¡œê³ ì¹¨ ì„¤ì •
    setupAutoRefresh();
});

// ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ì‹œ íƒ€ì´ë¨¸ ì¬ì„¤ì •
const originalRefreshDashboard = refreshDashboard;
refreshDashboard = async function() {
    await originalRefreshDashboard.apply(this, arguments);
    // ìƒˆë¡œê³ ì¹¨ í›„ íƒ€ì´ë¨¸ ì¬ì„¤ì •
    setupAutoRefresh();
};
</script>
{% endblock %}