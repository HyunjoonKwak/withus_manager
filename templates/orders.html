{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-shopping-cart text-primary"></i> 주문 관리</h2>
                <button class="btn btn-primary" onclick="refreshOrders()">
                    <i class="fas fa-sync-alt"></i> 새로고침
                </button>
            </div>

            <!-- 필터링 옵션 -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="statusFilter" class="form-label">상태 필터</label>
                            <select class="form-select" id="statusFilter" onchange="filterOrders()">
                                <option value="">전체 상태</option>
                                <option value="신규주문">신규주문</option>
                                <option value="발송대기">발송대기</option>
                                <option value="배송중">배송중</option>
                                <option value="배송완료">배송완료</option>
                                <option value="구매확정">구매확정</option>
                                <option value="취소주문">취소주문</option>
                                <option value="반품주문">반품주문</option>
                                <option value="교환주문">교환주문</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="dateFrom" class="form-label">시작일</label>
                            <input type="date" class="form-control" id="dateFrom" onchange="filterOrders()">
                        </div>
                        <div class="col-md-3">
                            <label for="dateTo" class="form-label">종료일</label>
                            <input type="date" class="form-control" id="dateTo" onchange="filterOrders()">
                        </div>
                        <div class="col-md-3">
                            <label for="searchText" class="form-label">검색</label>
                            <input type="text" class="form-control" id="searchText" placeholder="주문자명 또는 상품명" onkeyup="filterOrders()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 주문 목록 테이블 -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>주문ID</th>
                                    <th>주문자</th>
                                    <th>상품명</th>
                                    <th>수량</th>
                                    <th>금액</th>
                                    <th>상태</th>
                                    <th>주문일시</th>
                                    <th>배송지</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">주문 데이터를 불러오는 중...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let allOrders = [];

async function refreshOrders() {
    try {
        showLoading();
        const response = await fetch('/api/orders');
        const result = await response.json();

        if (result.success) {
            allOrders = result.orders;
            displayOrders(allOrders);
        } else {
            showError('주문 데이터 조회 실패: ' + result.error);
        }
    } catch (error) {
        showError('주문 데이터 조회 중 오류 발생: ' + error.message);
    }
}

function displayOrders(orders) {
    const tbody = document.getElementById('ordersTableBody');

    if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">주문 데이터가 없습니다.</td></tr>';
        return;
    }

    tbody.innerHTML = orders.map(order => `
        <tr>
            <td><span class="badge bg-secondary">${order.order_id || '-'}</span></td>
            <td><strong>${order.customer_name || '-'}</strong></td>
            <td>${order.product_name || '-'}</td>
            <td><span class="badge bg-info">${order.quantity || 0}</span></td>
            <td><strong>${formatPrice(order.price)}</strong></td>
            <td>${getStatusBadge(order.order_status)}</td>
            <td>${formatDate(order.order_date)}</td>
            <td class="text-truncate" style="max-width: 200px;" title="${order.delivery_address || ''}">${order.delivery_address || '-'}</td>
        </tr>
    `).join('');
}

function getStatusBadge(status) {
    const statusClasses = {
        '신규주문': 'bg-success',
        '발송대기': 'bg-warning',
        '배송중': 'bg-primary',
        '배송완료': 'bg-info',
        '구매확정': 'bg-success',
        '취소주문': 'bg-danger',
        '반품주문': 'bg-secondary',
        '교환주문': 'bg-secondary'
    };

    const badgeClass = statusClasses[status] || 'bg-light text-dark';
    return `<span class="badge ${badgeClass}">${status || '-'}</span>`;
}

function formatPrice(price) {
    if (!price) return '-';
    return new Intl.NumberFormat('ko-KR').format(price) + '원';
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', {hour: '2-digit', minute:'2-digit'});
}

function filterOrders() {
    const statusFilter = document.getElementById('statusFilter').value;
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    const searchText = document.getElementById('searchText').value.toLowerCase();

    let filtered = allOrders.filter(order => {
        // 상태 필터
        if (statusFilter && order.order_status !== statusFilter) return false;

        // 날짜 필터
        if (dateFrom) {
            const orderDate = new Date(order.order_date);
            const fromDate = new Date(dateFrom);
            if (orderDate < fromDate) return false;
        }

        if (dateTo) {
            const orderDate = new Date(order.order_date);
            const toDate = new Date(dateTo);
            toDate.setDate(toDate.getDate() + 1); // 종료일 포함
            if (orderDate >= toDate) return false;
        }

        // 텍스트 검색
        if (searchText) {
            const customerName = (order.customer_name || '').toLowerCase();
            const productName = (order.product_name || '').toLowerCase();
            if (!customerName.includes(searchText) && !productName.includes(searchText)) return false;
        }

        return true;
    });

    displayOrders(filtered);
}

function showLoading() {
    document.getElementById('ordersTableBody').innerHTML = `
        <tr>
            <td colspan="8" class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">주문 데이터를 불러오는 중...</p>
            </td>
        </tr>`;
}

function showError(message) {
    document.getElementById('ordersTableBody').innerHTML = `
        <tr>
            <td colspan="8" class="text-center text-danger">
                <i class="fas fa-exclamation-triangle"></i> ${message}
            </td>
        </tr>`;
}

// 페이지 로드 시 실행
document.addEventListener('DOMContentLoaded', function() {
    // 기본 날짜 설정 (최근 7일)
    const today = new Date();
    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

    document.getElementById('dateTo').value = today.toISOString().split('T')[0];
    document.getElementById('dateFrom').value = weekAgo.toISOString().split('T')[0];

    // 주문 데이터 로드
    refreshOrders();
});
</script>
{% endblock %}