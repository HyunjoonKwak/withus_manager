{% extends "base.html" %}

{% block title %}조건설정 - {{ title }}{% endblock %}

{% block extra_head %}
<style>
    .settings-card {
        transition: all 0.2s ease;
        border: 1px solid #dee2e6;
        margin-bottom: 20px;
    }
    .settings-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-color: #007bff;
    }
    .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px 10px 0 0;
    }
    .form-check-input:checked {
        background-color: #007bff;
        border-color: #007bff;
    }
    .btn-save {
        background: linear-gradient(45deg, #28a745, #20c997);
        border: none;
        color: white;
        border-radius: 25px;
        padding: 8px 20px;
        transition: all 0.3s ease;
    }
    .btn-save:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        color: white;
    }
    .monitoring-section {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-sliders-h me-2"></i>조건설정</h2>
    <button class="btn btn-primary" onclick="refreshSettings()">
        <i class="fas fa-sync-alt me-2"></i>새로고침
    </button>
</div>

<!-- 대시보드 설정 -->
<div class="card settings-card">
    <div class="card-header section-header">
        <h5 class="mb-0"><i class="fas fa-chart-dashboard me-2"></i>대시보드 설정</h5>
    </div>
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <label for="dashboardPeriod" class="form-label">기본 조회 기간:</label>
                <div class="input-group">
                    <select class="form-select" id="dashboardPeriod">
                        <option value="1">1일</option>
                        <option value="3">3일</option>
                        <option value="7">7일</option>
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <button class="btn btn-save" onclick="saveDashboardSettings()">
                    <i class="fas fa-save me-2"></i>저장
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 모니터링 설정 -->
<div class="card settings-card">
    <div class="card-header monitoring-section">
        <h5 class="mb-0"><i class="fas fa-heartbeat me-2"></i>모니터링 설정</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="autoRefresh">
                    <label class="form-check-label" for="autoRefresh">
                        자동 리프레시 활성화
                    </label>
                </div>
                <div class="mb-3">
                    <label for="refreshInterval" class="form-label">리프레시 간격 (초):</label>
                    <input type="number" class="form-control" id="refreshInterval" min="30" max="3600" value="60">
                    <div class="form-text">권장: 60초 이상 (너무 짧으면 API 제한에 걸릴 수 있습니다)</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex gap-2">
                    <button class="btn btn-save" onclick="saveMonitoringSettings()">
                        <i class="fas fa-save me-2"></i>저장
                    </button>
                    <button class="btn btn-outline-primary" onclick="manualRefresh()">
                        <i class="fas fa-sync me-2"></i>지금 새로고침
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 주문 상태 설정 -->
<div class="card settings-card">
    <div class="card-header section-header">
        <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>주문 상태 설정</h5>
    </div>
    <div class="card-body">
        <div class="row" id="orderStatusCheckboxes">
            <!-- 주문 상태 체크박스들이 여기에 동적으로 생성됩니다 -->
        </div>
        <div class="mt-3">
            <button class="btn btn-save" onclick="saveOrderStatusSettings()">
                <i class="fas fa-save me-2"></i>저장
            </button>
            <button class="btn btn-outline-secondary ms-2" onclick="selectAllOrderStatuses()">
                <i class="fas fa-check-square me-2"></i>전체 선택
            </button>
            <button class="btn btn-outline-secondary ms-2" onclick="deselectAllOrderStatuses()">
                <i class="fas fa-square me-2"></i>전체 해제
            </button>
        </div>
    </div>
</div>

<!-- 주문 컬럼 설정 -->
<div class="card settings-card">
    <div class="card-header section-header">
        <h5 class="mb-0"><i class="fas fa-columns me-2"></i>주문 컬럼 설정</h5>
    </div>
    <div class="card-body">
        <div class="row" id="orderColumnCheckboxes">
            <!-- 주문 컬럼 체크박스들이 여기에 동적으로 생성됩니다 -->
        </div>
        <div class="mt-3">
            <button class="btn btn-save" onclick="saveOrderColumnSettings()">
                <i class="fas fa-save me-2"></i>저장
            </button>
            <button class="btn btn-outline-secondary ms-2" onclick="selectAllOrderColumns()">
                <i class="fas fa-check-square me-2"></i>전체 선택
            </button>
            <button class="btn btn-outline-secondary ms-2" onclick="deselectAllOrderColumns()">
                <i class="fas fa-square me-2"></i>전체 해제
            </button>
        </div>
    </div>
</div>

<!-- 상품 상태 설정 -->
<div class="card settings-card">
    <div class="card-header section-header">
        <h5 class="mb-0"><i class="fas fa-box me-2"></i>상품 상태 설정</h5>
    </div>
    <div class="card-body">
        <div class="row" id="productStatusCheckboxes">
            <!-- 상품 상태 체크박스들이 여기에 동적으로 생성됩니다 -->
        </div>
        <div class="mt-3">
            <button class="btn btn-save" onclick="saveProductStatusSettings()">
                <i class="fas fa-save me-2"></i>저장
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// 페이지 로드 시 설정 불러오기
document.addEventListener('DOMContentLoaded', function() {
    loadAllSettings();
});

// 모든 설정 불러오기
async function loadAllSettings() {
    await loadDashboardSettings();
    await loadMonitoringSettings();
    await loadOrderStatusSettings();
    await loadOrderColumnSettings();
    await loadProductStatusSettings();
}

// 대시보드 설정 불러오기
async function loadDashboardSettings() {
    try {
        const response = await fetch('/api/settings/period/dashboard');
        const result = await response.json();
        if (result.success) {
            document.getElementById('dashboardPeriod').value = result.period_days || 1;
        }
    } catch (error) {
        console.error('대시보드 설정 로드 오류:', error);
    }
}

// 모니터링 설정 불러오기
async function loadMonitoringSettings() {
    try {
        const response = await fetch('/api/settings');
        const result = await response.json();
        if (result.success && result.config) {
            document.getElementById('autoRefresh').checked = result.config.AUTO_REFRESH === 'true';
            document.getElementById('refreshInterval').value = result.config.REFRESH_INTERVAL || 60;
        }
    } catch (error) {
        console.error('모니터링 설정 로드 오류:', error);
    }
}

// 주문 상태 설정 불러오기
async function loadOrderStatusSettings() {
    try {
        const response = await fetch('/api/settings');
        const result = await response.json();
        if (result.success && result.config) {
            const orderStatuses = [
                {code: 'PAYMENT_WAITING', label: '결제대기'},
                {code: 'PAYED', label: '결제완료'},
                {code: 'DELIVERING', label: '배송중'},
                {code: 'DELIVERED', label: '배송완료'},
                {code: 'PURCHASE_DECIDED', label: '구매확정'},
                {code: 'EXCHANGED', label: '교환'},
                {code: 'CANCELED', label: '취소'},
                {code: 'RETURNED', label: '반품'},
                {code: 'CANCELED_BY_NOPAYMENT', label: '미결제취소'}
            ];

            const selectedStatuses = (result.config.ORDER_STATUS_TYPES || 'PAYED,DELIVERING,DELIVERED').split(',');
            const container = document.getElementById('orderStatusCheckboxes');
            container.innerHTML = '';

            orderStatuses.forEach(status => {
                const col = document.createElement('div');
                col.className = 'col-md-4 col-sm-6 mb-2';

                const formCheck = document.createElement('div');
                formCheck.className = 'form-check';

                const input = document.createElement('input');
                input.className = 'form-check-input';
                input.type = 'checkbox';
                input.id = `orderStatus_${status.code}`;
                input.value = status.code;
                input.checked = selectedStatuses.includes(status.code);

                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.setAttribute('for', input.id);
                label.textContent = `${status.label} (${status.code})`;

                formCheck.appendChild(input);
                formCheck.appendChild(label);
                col.appendChild(formCheck);
                container.appendChild(col);
            });
        }
    } catch (error) {
        console.error('주문 상태 설정 로드 오류:', error);
    }
}

// 주문 컬럼 설정 불러오기
async function loadOrderColumnSettings() {
    try {
        const response = await fetch('/api/settings');
        const result = await response.json();
        if (result.success && result.config) {
            const orderColumns = [
                '주문ID', '상품주문ID', '주문자', '상품명', '옵션정보', '판매자상품코드',
                '수량', '단가', '할인금액', '금액', '결제방법', '배송지주소', '배송예정일', '주문일시', '상태'
            ];

            const defaultColumns = orderColumns.join(',');
            const selectedColumns = (result.config.ORDER_COLUMNS || defaultColumns).split(',');
            const container = document.getElementById('orderColumnCheckboxes');
            container.innerHTML = '';

            orderColumns.forEach(column => {
                const col = document.createElement('div');
                col.className = 'col-md-3 col-sm-4 mb-2';

                const formCheck = document.createElement('div');
                formCheck.className = 'form-check';

                const input = document.createElement('input');
                input.className = 'form-check-input';
                input.type = 'checkbox';
                input.id = `orderColumn_${column}`;
                input.value = column;
                input.checked = selectedColumns.includes(column);

                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.setAttribute('for', input.id);
                label.textContent = column;

                formCheck.appendChild(input);
                formCheck.appendChild(label);
                col.appendChild(formCheck);
                container.appendChild(col);
            });
        }
    } catch (error) {
        console.error('주문 컬럼 설정 로드 오류:', error);
    }
}

// 상품 상태 설정 불러오기
async function loadProductStatusSettings() {
    try {
        const response = await fetch('/api/settings');
        const result = await response.json();
        if (result.success && result.config) {
            const productStatuses = [
                {code: 'SALE', label: '판매중'},
                {code: 'WAIT', label: '판매대기'},
                {code: 'OUTOFSTOCK', label: '품절'},
                {code: 'SUSPENSION', label: '판매중지'},
                {code: 'CLOSE', label: '판매종료'},
                {code: 'PROHIBITION', label: '판매금지'}
            ];

            const defaultStatuses = productStatuses.map(s => s.code).join(',');
            const selectedStatuses = (result.config.PRODUCT_STATUS_TYPES || defaultStatuses).split(',');
            const container = document.getElementById('productStatusCheckboxes');
            container.innerHTML = '';

            productStatuses.forEach(status => {
                const col = document.createElement('div');
                col.className = 'col-md-4 col-sm-6 mb-2';

                const formCheck = document.createElement('div');
                formCheck.className = 'form-check';

                const input = document.createElement('input');
                input.className = 'form-check-input';
                input.type = 'checkbox';
                input.id = `productStatus_${status.code}`;
                input.value = status.code;
                input.checked = selectedStatuses.includes(status.code);

                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.setAttribute('for', input.id);
                label.textContent = status.label;

                formCheck.appendChild(input);
                formCheck.appendChild(label);
                col.appendChild(formCheck);
                container.appendChild(col);
            });
        }
    } catch (error) {
        console.error('상품 상태 설정 로드 오류:', error);
    }
}

// 대시보드 설정 저장
async function saveDashboardSettings() {
    try {
        const periodDays = document.getElementById('dashboardPeriod').value;

        const response = await fetch('/api/settings/period/dashboard', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ period_days: parseInt(periodDays) })
        });

        const result = await response.json();
        if (result.success) {
            showToast('success', '대시보드 설정이 저장되었습니다.');
        } else {
            showToast('error', result.message || '저장 실패');
        }
    } catch (error) {
        showToast('error', '대시보드 설정 저장 중 오류가 발생했습니다.');
    }
}

// 모니터링 설정 저장
async function saveMonitoringSettings() {
    try {
        const autoRefresh = document.getElementById('autoRefresh').checked;
        const refreshInterval = document.getElementById('refreshInterval').value;

        if (refreshInterval < 30 || refreshInterval > 3600) {
            showToast('error', '리프레시 간격은 30초 이상 3600초 이하여야 합니다.');
            return;
        }

        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                AUTO_REFRESH: autoRefresh.toString(),
                REFRESH_INTERVAL: refreshInterval
            })
        });

        const result = await response.json();
        if (result.success) {
            showToast('success', '모니터링 설정이 저장되었습니다.');
        } else {
            showToast('error', result.message || '저장 실패');
        }
    } catch (error) {
        showToast('error', '모니터링 설정 저장 중 오류가 발생했습니다.');
    }
}

// 주문 상태 설정 저장
async function saveOrderStatusSettings() {
    try {
        const checkboxes = document.querySelectorAll('#orderStatusCheckboxes input[type="checkbox"]:checked');
        const selectedStatuses = Array.from(checkboxes).map(cb => cb.value);

        if (selectedStatuses.length === 0) {
            showToast('error', '최소 하나의 상태를 선택해야 합니다.');
            return;
        }

        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ORDER_STATUS_TYPES: selectedStatuses.join(',') })
        });

        const result = await response.json();
        if (result.success) {
            showToast('success', '주문 상태 설정이 저장되었습니다.');
        } else {
            showToast('error', result.message || '저장 실패');
        }
    } catch (error) {
        showToast('error', '주문 상태 설정 저장 중 오류가 발생했습니다.');
    }
}

// 주문 컬럼 설정 저장
async function saveOrderColumnSettings() {
    try {
        const checkboxes = document.querySelectorAll('#orderColumnCheckboxes input[type="checkbox"]:checked');
        const selectedColumns = Array.from(checkboxes).map(cb => cb.value);

        if (selectedColumns.length === 0) {
            showToast('error', '최소 하나의 컬럼을 선택해야 합니다.');
            return;
        }

        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ORDER_COLUMNS: selectedColumns.join(',') })
        });

        const result = await response.json();
        if (result.success) {
            showToast('success', '주문 컬럼 설정이 저장되었습니다.');
        } else {
            showToast('error', result.message || '저장 실패');
        }
    } catch (error) {
        showToast('error', '주문 컬럼 설정 저장 중 오류가 발생했습니다.');
    }
}

// 상품 상태 설정 저장
async function saveProductStatusSettings() {
    try {
        const checkboxes = document.querySelectorAll('#productStatusCheckboxes input[type="checkbox"]:checked');
        const selectedStatuses = Array.from(checkboxes).map(cb => cb.value);

        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ PRODUCT_STATUS_TYPES: selectedStatuses.join(',') })
        });

        const result = await response.json();
        if (result.success) {
            showToast('success', '상품 상태 설정이 저장되었습니다.');
        } else {
            showToast('error', result.message || '저장 실패');
        }
    } catch (error) {
        showToast('error', '상품 상태 설정 저장 중 오류가 발생했습니다.');
    }
}

// 수동 새로고침
async function manualRefresh() {
    try {
        const response = await fetch('/api/dashboard/refresh');
        const result = await response.json();
        if (result.success) {
            showToast('success', '대시보드 새로고침이 완료되었습니다.');
        } else {
            showToast('error', result.message || '새로고침 실패');
        }
    } catch (error) {
        showToast('error', '새로고침 중 오류가 발생했습니다.');
    }
}

// 전체 선택/해제 함수들
function selectAllOrderStatuses() {
    document.querySelectorAll('#orderStatusCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = true);
}

function deselectAllOrderStatuses() {
    document.querySelectorAll('#orderStatusCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
}

function selectAllOrderColumns() {
    document.querySelectorAll('#orderColumnCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = true);
}

function deselectAllOrderColumns() {
    document.querySelectorAll('#orderColumnCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
}

// 설정 새로고침
function refreshSettings() {
    loadAllSettings();
    showToast('success', '설정을 새로고침했습니다.');
}

// 토스트 메시지 표시
function showToast(type, message) {
    if (type === 'success') {
        alert('✅ ' + message);
    } else {
        alert('❌ ' + message);
    }
}
</script>
{% endblock %}